<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Harald Pretl">
<meta name="author" content="Michael Koefinger">
<meta name="dcterms.date" content="2024-11-21">

<title>Analog Circuit Design</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta name="citation_title" content="Analog Circuit Design">
<meta name="citation_author" content="Harald Pretl">
<meta name="citation_author" content="Michael Koefinger">
<meta name="citation_publication_date" content="2024-11-21">
<meta name="citation_cover_date" content="2024-11-21">
<meta name="citation_year" content="2024">
<meta name="citation_online_date" content="2024-11-21">
<meta name="citation_language" content="en-US">
<meta name="citation_reference" content="citation_title=A treatise on electricity and magnetism;,citation_author=James Clerk Maxwell;,citation_publication_date=1873;,citation_cover_date=1873;,citation_year=1873;,citation_volume=1;">
<meta name="citation_reference" content="citation_title=Miller’s Theorem [Circuit Intuitions];,citation_author=Ali Sheikholeslami;,citation_publication_date=2015;,citation_cover_date=2015;,citation_year=2015;,citation_fulltext_html_url=http://ieeexplore.ieee.org/document/7258480/;,citation_issue=3;,citation_doi=10.1109/mssc.2015.2446457;,citation_issn=1943-0582;,citation_volume=7;,citation_journal_title=IEEE Solid-State Circuits Magazine;">
<meta name="citation_reference" content="citation_title=Measurement of loop gain in feedback systems;,citation_author=R. D. Middlebrook;,citation_publication_date=1975;,citation_cover_date=1975;,citation_year=1975;,citation_issue=4;,citation_doi=10.1080/00207217508920421;,citation_issn=0020-7217;,citation_volume=38;,citation_journal_title=International Journal of Electronics;">
<meta name="citation_reference" content="citation_title=Verifying the diode–capacitor circuit voltage decay;,citation_author=Edward H. Hellen;,citation_publication_date=2003-08;,citation_cover_date=2003-08;,citation_year=2003;,citation_issue=8;,citation_doi=10.1119/1.1578070;,citation_volume=71;,citation_journal_title=American Journal of Physics;">
<meta name="citation_reference" content="citation_title=SPICE2: A computer program to simulate semiconductor circuits;,citation_author=Laurence W. Nagel;,citation_publication_date=1975-05;,citation_cover_date=1975-05;,citation_year=1975;,citation_fulltext_html_url=http://www2.eecs.berkeley.edu/Pubs/TechRpts/1975/9602.html;,citation_dissertation_institution=EECS Department, University of California, Berkeley;">
<meta name="citation_reference" content="citation_title=Systematic design of analog CMOS circuits: Using pre-computed lookup tables;,citation_author=Paul G. A. Jespers;,citation_author=Boris Murmann;,citation_publication_date=2017;,citation_cover_date=2017;,citation_year=2017;">
<meta name="citation_reference" content="citation_title=Modern semiconductor devices for integrated circuits;,citation_author=Chenming Hu;,citation_publication_date=2010;,citation_cover_date=2010;,citation_year=2010;">
<meta name="citation_reference" content="citation_title=Operation and modeling of the MOS transistor;,citation_author=Yannis Tsividis;,citation_author=Colin McAndrew;,citation_publication_date=2011;,citation_cover_date=2011;,citation_year=2011;">
<meta name="citation_reference" content="citation_title=Analysis and Design of Elementary MOS Amplifier Stages;,citation_author=Boris Murmann;,citation_publication_date=2013;,citation_cover_date=2013;,citation_year=2013;">
<meta name="citation_reference" content="citation_title=Analysis and Design of Analog Integrated Circuits;,citation_author=Paul R. Gray;,citation_author=Paul J. Hurst;,citation_author=Stephen H. Lewis;,citation_author=Robert G. Meyer;,citation_publication_date=2009;,citation_cover_date=2009;,citation_year=2009;">
<meta name="citation_reference" content="citation_title=Design of Analog CMOS Integrated Circuits;,citation_author=Behzad Razavi;,citation_publication_date=2017;,citation_cover_date=2017;,citation_year=2017;">
</head>

<body>

<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Analog Circuit Design</h1>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
            <div class="quarto-title-meta-author">
          <div class="quarto-title-meta-heading">Authors</div>
          <div class="quarto-title-meta-heading">Affiliation</div>
          
                <div class="quarto-title-meta-contents">
            <p class="author">Harald Pretl <a href="mailto:harald.pretl@jku.at" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0003-1519-076X" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        <a href="https://www.jku.at/en/institute-for-integrated-circuits-and-quantum-computing">
                        Johannes Kepler University
                        </a>
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">Michael Koefinger </p>
          </div>
                    </div>
        
        <div class="quarto-title-meta">

                      
                <div>
            <div class="quarto-title-meta-heading">Published</div>
            <div class="quarto-title-meta-contents">
              <p class="date">November 21, 2024</p>
            </div>
          </div>
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      <div class="quarto-alternate-formats"><div class="quarto-title-meta-heading">Other Formats</div><div class="quarto-title-meta-contents"><p><a href="index.pdf"><i class="bi bi-file-pdf"></i>PDF</a></p></div></div></div>
    </div>



    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-intro" id="toc-sec-intro" class="nav-link active" data-scroll-target="#sec-intro"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#ihps-sg13g2-130nm-cmos-technology" id="toc-ihps-sg13g2-130nm-cmos-technology" class="nav-link" data-scroll-target="#ihps-sg13g2-130nm-cmos-technology"><span class="header-section-number">1.1</span> IHP’s SG13G2 130nm CMOS Technology</a></li>
  <li><a href="#schematic-entry-using-xschem" id="toc-schematic-entry-using-xschem" class="nav-link" data-scroll-target="#schematic-entry-using-xschem"><span class="header-section-number">1.2</span> Schematic Entry Using Xschem</a></li>
  <li><a href="#circuit-simulation-using-ngspice" id="toc-circuit-simulation-using-ngspice" class="nav-link" data-scroll-target="#circuit-simulation-using-ngspice"><span class="header-section-number">1.3</span> Circuit Simulation Using ngspice</a></li>
  <li><a href="#integrated-ic-design-environment-iic-osic-tools" id="toc-integrated-ic-design-environment-iic-osic-tools" class="nav-link" data-scroll-target="#integrated-ic-design-environment-iic-osic-tools"><span class="header-section-number">1.4</span> Integrated IC Design Environment (IIC-OSIC-TOOLS)</a></li>
  <li><a href="#setting-up-the-design-directory" id="toc-setting-up-the-design-directory" class="nav-link" data-scroll-target="#setting-up-the-design-directory"><span class="header-section-number">1.5</span> Setting up the Design Directory</a>
  <ul class="collapse">
  <li><a href="#creating-backups" id="toc-creating-backups" class="nav-link" data-scroll-target="#creating-backups"><span class="header-section-number">1.5.1</span> Creating Backups</a></li>
  <li><a href="#updating-the-repository" id="toc-updating-the-repository" class="nav-link" data-scroll-target="#updating-the-repository"><span class="header-section-number">1.5.2</span> Updating the Repository</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-first-steps" id="toc-sec-first-steps" class="nav-link" data-scroll-target="#sec-first-steps"><span class="header-section-number">2</span> First Steps</a>
  <ul class="collapse">
  <li><a href="#sec-mosfet" id="toc-sec-mosfet" class="nav-link" data-scroll-target="#sec-mosfet"><span class="header-section-number">2.1</span> The Metal-Oxide-Semiconductor Field-Effect-Transistor (MOSFET)</a>
  <ul class="collapse">
  <li><a href="#large-signal-mosfet-model" id="toc-large-signal-mosfet-model" class="nav-link" data-scroll-target="#large-signal-mosfet-model"><span class="header-section-number">2.1.1</span> Large-Signal MOSFET Model</a></li>
  <li><a href="#sec-mosfet-smallsignal-model" id="toc-sec-mosfet-smallsignal-model" class="nav-link" data-scroll-target="#sec-mosfet-smallsignal-model"><span class="header-section-number">2.1.2</span> Small-Signal MOSFET Model</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">2.2</span> Conclusion</a></li>
  </ul></li>
  <li><a href="#sec-gmid-method" id="toc-sec-gmid-method" class="nav-link" data-scroll-target="#sec-gmid-method"><span class="header-section-number">3</span> Transistor Sizing Using gm/ID Methodology</a>
  <ul class="collapse">
  <li><a href="#sec-techsweep-testbench" id="toc-sec-techsweep-testbench" class="nav-link" data-scroll-target="#sec-techsweep-testbench"><span class="header-section-number">3.1</span> MOSFET Characterization Testbench</a></li>
  <li><a href="#sec-techsweep-nmos" id="toc-sec-techsweep-nmos" class="nav-link" data-scroll-target="#sec-techsweep-nmos"><span class="header-section-number">3.2</span> NMOS Characterization in Saturation</a></li>
  <li><a href="#sec-techsweep-pmos" id="toc-sec-techsweep-pmos" class="nav-link" data-scroll-target="#sec-techsweep-pmos"><span class="header-section-number">3.3</span> PMOS Characterization in Saturation</a></li>
  <li><a href="#nmos-and-pmos-characterization-in-triode" id="toc-nmos-and-pmos-characterization-in-triode" class="nav-link" data-scroll-target="#nmos-and-pmos-characterization-in-triode"><span class="header-section-number">3.4</span> NMOS and PMOS Characterization in Triode</a></li>
  </ul></li>
  <li><a href="#sec-mosfet-diode" id="toc-sec-mosfet-diode" class="nav-link" data-scroll-target="#sec-mosfet-diode"><span class="header-section-number">4</span> First Circuit: MOSFET Diode</a>
  <ul class="collapse">
  <li><a href="#mosfet-diode-sizing" id="toc-mosfet-diode-sizing" class="nav-link" data-scroll-target="#mosfet-diode-sizing"><span class="header-section-number">4.1</span> MOSFET Diode Sizing</a></li>
  <li><a href="#mosfet-diode-large-signal-behavior" id="toc-mosfet-diode-large-signal-behavior" class="nav-link" data-scroll-target="#mosfet-diode-large-signal-behavior"><span class="header-section-number">4.2</span> MOSFET Diode Large-Signal Behavior</a></li>
  <li><a href="#mosfet-diode-small-signal-analysis" id="toc-mosfet-diode-small-signal-analysis" class="nav-link" data-scroll-target="#mosfet-diode-small-signal-analysis"><span class="header-section-number">4.3</span> MOSFET Diode Small-Signal Analysis</a></li>
  <li><a href="#mosfet-diode-stability-analysis" id="toc-mosfet-diode-stability-analysis" class="nav-link" data-scroll-target="#mosfet-diode-stability-analysis"><span class="header-section-number">4.4</span> MOSFET Diode Stability Analysis</a></li>
  <li><a href="#mosfet-diode-noise-calculation" id="toc-mosfet-diode-noise-calculation" class="nav-link" data-scroll-target="#mosfet-diode-noise-calculation"><span class="header-section-number">4.5</span> MOSFET Diode Noise Calculation</a></li>
  <li><a href="#conclusion-1" id="toc-conclusion-1" class="nav-link" data-scroll-target="#conclusion-1"><span class="header-section-number">4.6</span> Conclusion</a></li>
  </ul></li>
  <li><a href="#sec-cs-amplifier" id="toc-sec-cs-amplifier" class="nav-link" data-scroll-target="#sec-cs-amplifier"><span class="header-section-number">5</span> Common-Source Amplifier</a>
  <ul class="collapse">
  <li><a href="#sense-amplifier-for-50ohm-load" id="toc-sense-amplifier-for-50ohm-load" class="nav-link" data-scroll-target="#sense-amplifier-for-50ohm-load"><span class="header-section-number">5.1</span> Sense Amplifier for 50Ohm Load</a></li>
  </ul></li>
  <li><a href="#sec-current-mirror" id="toc-sec-current-mirror" class="nav-link" data-scroll-target="#sec-current-mirror"><span class="header-section-number">6</span> Current Mirror</a></li>
  <li><a href="#sec-diff-pair" id="toc-sec-diff-pair" class="nav-link" data-scroll-target="#sec-diff-pair"><span class="header-section-number">7</span> Differential Pair</a>
  <ul class="collapse">
  <li><a href="#differential-operation-of-the-diffpair" id="toc-differential-operation-of-the-diffpair" class="nav-link" data-scroll-target="#differential-operation-of-the-diffpair"><span class="header-section-number">7.1</span> Differential Operation of the Diffpair</a></li>
  <li><a href="#common-mode-operation-of-the-diffpair" id="toc-common-mode-operation-of-the-diffpair" class="nav-link" data-scroll-target="#common-mode-operation-of-the-diffpair"><span class="header-section-number">7.2</span> Common-Mode Operation of the Diffpair</a></li>
  </ul></li>
  <li><a href="#sec-basic-ota" id="toc-sec-basic-ota" class="nav-link" data-scroll-target="#sec-basic-ota"><span class="header-section-number">8</span> A Basic 5-Transistor OTA</a>
  <ul class="collapse">
  <li><a href="#voltage-buffer-with-ota" id="toc-voltage-buffer-with-ota" class="nav-link" data-scroll-target="#voltage-buffer-with-ota"><span class="header-section-number">8.1</span> Voltage Buffer with OTA</a></li>
  <li><a href="#sec-basic-ota-large-signal" id="toc-sec-basic-ota-large-signal" class="nav-link" data-scroll-target="#sec-basic-ota-large-signal"><span class="header-section-number">8.2</span> Large-Signal Analysis of the OTA</a></li>
  <li><a href="#sec-basic-ota-small-signal" id="toc-sec-basic-ota-small-signal" class="nav-link" data-scroll-target="#sec-basic-ota-small-signal"><span class="header-section-number">8.3</span> Small-Signal Analysis of the OTA</a>
  <ul class="collapse">
  <li><a href="#ota-small-signal-transfer-function" id="toc-ota-small-signal-transfer-function" class="nav-link" data-scroll-target="#ota-small-signal-transfer-function"><span class="header-section-number">8.3.1</span> OTA Small-Signal Transfer Function</a></li>
  <li><a href="#ota-noise" id="toc-ota-noise" class="nav-link" data-scroll-target="#ota-noise"><span class="header-section-number">8.3.2</span> OTA Noise</a></li>
  </ul></li>
  <li><a href="#sec-basic-ota-sizing" id="toc-sec-basic-ota-sizing" class="nav-link" data-scroll-target="#sec-basic-ota-sizing"><span class="header-section-number">8.4</span> 5T-OTA Sizing</a></li>
  <li><a href="#sec-basic-ota-simulation" id="toc-sec-basic-ota-simulation" class="nav-link" data-scroll-target="#sec-basic-ota-simulation"><span class="header-section-number">8.5</span> 5T-OTA Simulation</a></li>
  <li><a href="#t-ota-simulation-versus-pvt" id="toc-t-ota-simulation-versus-pvt" class="nav-link" data-scroll-target="#t-ota-simulation-versus-pvt"><span class="header-section-number">8.6</span> 5T-OTA Simulation versus PVT</a>
  <ul class="collapse">
  <li><a href="#pvt-simulation-analysis" id="toc-pvt-simulation-analysis" class="nav-link" data-scroll-target="#pvt-simulation-analysis"><span class="header-section-number">8.6.1</span> PVT Simulation Analysis</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-cascode-stage" id="toc-sec-cascode-stage" class="nav-link" data-scroll-target="#sec-cascode-stage"><span class="header-section-number">9</span> Cascode Stage</a>
  <ul class="collapse">
  <li><a href="#cascode-output-impedance" id="toc-cascode-output-impedance" class="nav-link" data-scroll-target="#cascode-output-impedance"><span class="header-section-number">9.1</span> Cascode Output Impedance</a></li>
  <li><a href="#cascode-input-impedance" id="toc-cascode-input-impedance" class="nav-link" data-scroll-target="#cascode-input-impedance"><span class="header-section-number">9.2</span> Cascode Input Impedance</a></li>
  </ul></li>
  <li><a href="#sec-improved-ota" id="toc-sec-improved-ota" class="nav-link" data-scroll-target="#sec-improved-ota"><span class="header-section-number">10</span> Improved OTA</a>
  <ul class="collapse">
  <li><a href="#sec-improved-ota-sizing" id="toc-sec-improved-ota-sizing" class="nav-link" data-scroll-target="#sec-improved-ota-sizing"><span class="header-section-number">10.1</span> Sizing the Improved OTA</a></li>
  <li><a href="#designing-the-improved-ota" id="toc-designing-the-improved-ota" class="nav-link" data-scroll-target="#designing-the-improved-ota"><span class="header-section-number">10.2</span> Designing the Improved OTA</a>
  <ul class="collapse">
  <li><a href="#discussion-of-the-ota-design" id="toc-discussion-of-the-ota-design" class="nav-link" data-scroll-target="#discussion-of-the-ota-design"><span class="header-section-number">10.2.1</span> Discussion of the OTA Design</a></li>
  </ul></li>
  <li><a href="#simulation-of-improved-ota" id="toc-simulation-of-improved-ota" class="nav-link" data-scroll-target="#simulation-of-improved-ota"><span class="header-section-number">10.3</span> Simulation of Improved OTA</a></li>
  <li><a href="#corner-simulation-of-improved-ota" id="toc-corner-simulation-of-improved-ota" class="nav-link" data-scroll-target="#corner-simulation-of-improved-ota"><span class="header-section-number">10.4</span> Corner Simulation of Improved OTA</a></li>
  </ul></li>
  <li><a href="#a-fully-differential-ota" id="toc-a-fully-differential-ota" class="nav-link" data-scroll-target="#a-fully-differential-ota"><span class="header-section-number">11</span> A Fully-Differential OTA</a></li>
  <li><a href="#biasing-the-ota" id="toc-biasing-the-ota" class="nav-link" data-scroll-target="#biasing-the-ota"><span class="header-section-number">12</span> Biasing the OTA</a></li>
  <li><a href="#an-rc-opamp-filter" id="toc-an-rc-opamp-filter" class="nav-link" data-scroll-target="#an-rc-opamp-filter"><span class="header-section-number">13</span> An RC-OPAMP Filter</a></li>
  <li><a href="#summary-conclusion" id="toc-summary-conclusion" class="nav-link" data-scroll-target="#summary-conclusion"><span class="header-section-number">14</span> Summary &amp; Conclusion</a></li>
  <li><a href="#sec-middlebrook-method" id="toc-sec-middlebrook-method" class="nav-link" data-scroll-target="#sec-middlebrook-method"><span class="header-section-number">15</span> Appendix: Middlebrook’s Method</a></li>
  <li><a href="#sec-miller-theorem" id="toc-sec-miller-theorem" class="nav-link" data-scroll-target="#sec-miller-theorem"><span class="header-section-number">16</span> Appendix: Miller’s Theorem</a></li>
  <li><a href="#sec-5t-ota-zout" id="toc-sec-5t-ota-zout" class="nav-link" data-scroll-target="#sec-5t-ota-zout"><span class="header-section-number">17</span> Appendix: 5T-OTA Small-Signal Output Impedance</a>
  <ul class="collapse">
  <li><a href="#open-loop-configuration" id="toc-open-loop-configuration" class="nav-link" data-scroll-target="#open-loop-configuration"><span class="header-section-number">17.1</span> Open-Loop Configuration</a></li>
  <li><a href="#closed-loop-configuration" id="toc-closed-loop-configuration" class="nav-link" data-scroll-target="#closed-loop-configuration"><span class="header-section-number">17.2</span> Closed-Loop Configuration</a></li>
  </ul></li>
  <li><a href="#sec-linux-cheatsheet" id="toc-sec-linux-cheatsheet" class="nav-link" data-scroll-target="#sec-linux-cheatsheet"><span class="header-section-number">18</span> Appendix: Linux Cheatsheet</a></li>
  <li><a href="#sec-xschem-cheatsheet" id="toc-sec-xschem-cheatsheet" class="nav-link" data-scroll-target="#sec-xschem-cheatsheet"><span class="header-section-number">19</span> Appendix: Xschem Cheatsheet</a></li>
  <li><a href="#sec-ngspice-cheatsheet" id="toc-sec-ngspice-cheatsheet" class="nav-link" data-scroll-target="#sec-ngspice-cheatsheet"><span class="header-section-number">20</span> Appendix: ngspice Cheatsheet</a>
  <ul class="collapse">
  <li><a href="#commands" id="toc-commands" class="nav-link" data-scroll-target="#commands"><span class="header-section-number">20.1</span> Commands</a></li>
  <li><a href="#options" id="toc-options" class="nav-link" data-scroll-target="#options"><span class="header-section-number">20.2</span> Options</a></li>
  <li><a href="#convergence-helper" id="toc-convergence-helper" class="nav-link" data-scroll-target="#convergence-helper"><span class="header-section-number">20.3</span> Convergence Helper</a></li>
  </ul></li>
  <li><a href="#sec-designers-etiquette" id="toc-sec-designers-etiquette" class="nav-link" data-scroll-target="#sec-designers-etiquette"><span class="header-section-number">21</span> Appendix: Circuit Designer’s Etiquette</a>
  <ul class="collapse">
  <li><a href="#prolog" id="toc-prolog" class="nav-link" data-scroll-target="#prolog"><span class="header-section-number">21.1</span> Prolog</a></li>
  <li><a href="#pins" id="toc-pins" class="nav-link" data-scroll-target="#pins"><span class="header-section-number">21.2</span> Pins</a></li>
  <li><a href="#schematics" id="toc-schematics" class="nav-link" data-scroll-target="#schematics"><span class="header-section-number">21.3</span> Schematics</a></li>
  <li><a href="#symbols" id="toc-symbols" class="nav-link" data-scroll-target="#symbols"><span class="header-section-number">21.4</span> Symbols</a></li>
  <li><a href="#design-robustness" id="toc-design-robustness" class="nav-link" data-scroll-target="#design-robustness"><span class="header-section-number">21.5</span> Design Robustness</a></li>
  <li><a href="#rules-for-good-mixed-signal-and-rf-circuits" id="toc-rules-for-good-mixed-signal-and-rf-circuits" class="nav-link" data-scroll-target="#rules-for-good-mixed-signal-and-rf-circuits"><span class="header-section-number">21.6</span> Rules for Good Mixed-Signal and RF Circuits</a></li>
  <li><a href="#vhdlverilog-coding-guide" id="toc-vhdlverilog-coding-guide" class="nav-link" data-scroll-target="#vhdlverilog-coding-guide"><span class="header-section-number">21.7</span> VHDL/Verilog Coding Guide</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">21.8</span> Further Reading</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-notebooks"><h2>Notebooks</h2><ul><li><a href="sizing/techsweep_sg13_txt_to_mat-preview.html"><i class="bi bi-journal-code"></i>Conversion of TXT to MAT for gm/ID result files for SG13G2</a></li><li><a href="sizing/techsweep_sg13_plots_nmos-preview.html"><i class="bi bi-journal-code"></i>MOSFET gm/ID Evaluation Script for IHP SG13G2</a></li><li><a href="sizing/techsweep_sg13_plots_pmos-preview.html"><i class="bi bi-journal-code"></i>MOSFET gm/ID Evaluation Script for IHP SG13G2</a></li><li><a href="sizing/lookup_sg13-preview.html"><i class="bi bi-journal-code"></i>MOSFET gm/ID Lookup for IHP SG13G2</a></li><li><a href="sizing/techsweep_sg13_plots_triode-preview.html"><i class="bi bi-journal-code"></i>MOSFET gm/ID Lookup for IHP SG13G2 in Triode Region</a></li><li><a href="sizing/sizing_basic_ota_improved-preview.html"><i class="bi bi-journal-code"></i>Sizing for Basic (Improved) OTA</a></li><li><a href="sizing/sizing_basic_ota_improved_w_circuit-preview.html"><i class="bi bi-journal-code"></i>Sizing for Basic (Improved) OTA With Schematic</a></li><li><a href="sizing/sizing_basic_ota-preview.html"><i class="bi bi-journal-code"></i>Sizing for Basic 5T-OTA</a></li><li><a href="sizing/sizing_basic_ota_w_circuit-preview.html"><i class="bi bi-journal-code"></i>Sizing for Basic 5T-OTA With Schematic</a></li><li><a href="sizing/sizing_current_mirror-preview.html"><i class="bi bi-journal-code"></i>Sizing for Improved Current Mirror</a></li><li><a href="sizing/sizing_measurement_amplifier-preview.html"><i class="bi bi-journal-code"></i>Sizing for Measurement Amplifier</a></li><li><a href="sizing/sizing_mosfet_diode-preview.html"><i class="bi bi-journal-code"></i>Sizing for MOSFET Diode Example</a></li></ul></div></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">



  


<section id="sec-intro" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This is the material for an intermediate-level MOSFET circuit design course, held at JKU under course number 336.009 (“KV Analoge Schaltungstechnik”).</p>
<p>The course makes heavy use of circuit simulation, using <strong>Xschem</strong> for schematic entry and <strong>ngspice</strong> for simulation. The 130nm CMOS technology <strong>SG13G2</strong> from IHP Microelectronics is used.</p>
<p>Tools and PDK are integrated in the <strong>IIC-OSIC-TOOLS</strong> Docker image, which will be used during the coursework.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>All course material (source code of this document, Jupyter notebooks for calculations, Xschem circuits, etc.) is made publicly available on GitHub (<a href="https://github.com/iic-jku/analog-circuit-design">follow this link</a>) and shared under the Apache-2.0 license.</p>
<p>Please feel free to submit pull requests on GitHub to fix errors and omissions!</p>
<p>The production of this document would be impossible without these (and many more) great open-source software products: <code>VS Code</code>, <code>Quarto</code>, <code>Pandoc</code>, <code>TexLive</code>, <code>Jupyter Notebook</code>, <code>Python</code>, <code>Xschem</code>, <code>ngspice</code>, <code>CACE</code>, <code>pygmid</code>, <code>schemdraw</code>, <code>Numpy</code>, <code>Scipy</code>, <code>Matplotlib</code>, <code>Pandas</code>, <code>Git</code>, <code>Docker</code>, <code>Ubuntu</code>, <code>Linux</code>, …</p>
</div>
</div>
<section id="ihps-sg13g2-130nm-cmos-technology" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="ihps-sg13g2-130nm-cmos-technology"><span class="header-section-number">1.1</span> IHP’s SG13G2 130nm CMOS Technology</h2>
<p>SG13G2 is the name of a 130nm CMOS technology (strictly speaking BiCMOS) from IHP Microelectronics. It features low-voltage (thin-oxide) core MOSFET, high-voltage (thick-oxide) I/O MOSFET, various types of linear resistors, and 7 layers of Aluminum metallization (5 thin plus 2 thick metal layers). This PDK is open-source, and the complete process specification can be found at <a href="https://github.com/IHP-GmbH/IHP-Open-PDK/blob/main/ihp-sg13g2/libs.doc/doc/SG13G2_os_process_spec.pdf">SG13G2 process specification</a>. While we will not do layouts in this course, the layout rules can be found at <a href="https://github.com/IHP-GmbH/IHP-Open-PDK/blob/main/ihp-sg13g2/libs.doc/doc/SG13G2_os_layout_rules.pdf">SG13G2 layout rules</a>.</p>
<p>For our circuit design, the most important parameters of the available devices are summarized in the following table:</p>
<div id="tbl-sg13g2-devices" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-sg13g2-devices-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: IHP SG13G2 devices
</figcaption>
<div aria-describedby="tbl-sg13g2-devices-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 14%">
<col style="width: 58%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Device</th>
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Specification</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Low-voltage (LV) NMOS</td>
<td style="text-align: left;"><code>sg13_lv_nmos</code></td>
<td style="text-align: left;">operating voltage (nom.) <span class="math inline">\(V_\mathrm{DD}=1.5\,\text{V}\)</span>, <span class="math inline">\(L_\mathrm{min}=0.13\,\mu\text{m}\)</span>, <span class="math inline">\(V_\mathrm{th}\approx 0.5\,\text{V}\)</span>; triple-well available</td>
</tr>
<tr class="even">
<td style="text-align: left;">Low-voltage (LV) PMOS</td>
<td style="text-align: left;"><code>sg13_lv_pmos</code></td>
<td style="text-align: left;">operating voltage (nom.) <span class="math inline">\(V_\mathrm{DD}=1.5\,\text{V}\)</span>, <span class="math inline">\(L_\mathrm{min}=0.13\,\mu\text{m}\)</span>, <span class="math inline">\(V_\mathrm{th}\approx -0.47\,\text{V}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">High-voltage (HV) NMOS</td>
<td style="text-align: left;"><code>sg13_hv_nmos</code></td>
<td style="text-align: left;">operating voltage (nom.) <span class="math inline">\(V_\mathrm{DD}=3.3\,\text{V}\)</span>, <span class="math inline">\(L_\mathrm{min}=0.45\,\mu\text{m}\)</span>, <span class="math inline">\(V_\mathrm{th}\approx 0.7\,\text{V}\)</span>; triple-well available</td>
</tr>
<tr class="even">
<td style="text-align: left;">High-voltage (HV) PMOS</td>
<td style="text-align: left;"><code>sg13_hv_pmos</code></td>
<td style="text-align: left;">operating voltage (nom.) <span class="math inline">\(V_\mathrm{DD}=3.3\,\text{V}\)</span>, <span class="math inline">\(L_\mathrm{min}=0.45\,\mu\text{m}\)</span>, <span class="math inline">\(V_\mathrm{th}\approx -0.65\,\text{V}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Silicided poly resistor</td>
<td style="text-align: left;"><code>rsil</code></td>
<td style="text-align: left;"><span class="math inline">\(R_\square=7\,\Omega \pm 10\%\)</span>, <span class="math inline">\(\text{TC}_1=3100\,\text{ppm/K}\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">Poly resistor</td>
<td style="text-align: left;"><code>rppd</code></td>
<td style="text-align: left;"><span class="math inline">\(R_\square=260\,\Omega \pm 10\%\)</span>, <span class="math inline">\(\text{TC}_1=170\,\text{ppm/K}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Poly resistor high</td>
<td style="text-align: left;"><code>rhigh</code></td>
<td style="text-align: left;"><span class="math inline">\(R_\square=1360\,\Omega \pm 15\%\)</span>, <span class="math inline">\(\text{TC}_1=-2300\,\text{ppm/K}\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">MIM capacitor</td>
<td style="text-align: left;"><code>cap_cmim</code></td>
<td style="text-align: left;"><span class="math inline">\(C'=1.5\,\text{fF}/\mu\text{m}^2 \pm 10\%\)</span>, <span class="math inline">\(\text{VC}_1=-26\text{ppm/V}\)</span>, <span class="math inline">\(\text{TC}_1=3.6\text{ppm/K}\)</span>, breakdown voltage <span class="math inline">\(&gt;15\,\text{V}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">MOM capacitor</td>
<td style="text-align: left;">n/a</td>
<td style="text-align: left;">The metal stack is well-suited for MOM capacitors due to 5 thin metal layers, but no primitive capacitor device is available at this point.</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="schematic-entry-using-xschem" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="schematic-entry-using-xschem"><span class="header-section-number">1.2</span> Schematic Entry Using Xschem</h2>
<p>Xschem is an open-source schematic entry tool with emphasis on integrated circuits. For up-to-date information of the many features of Xschem and the basic operation of it please look at the available <a href="https://xschem.sourceforge.io/stefan/xschem_man/xschem_man.html">online documentation</a>. Usage of Xschem will be learned with the first few basic examples, essentially using a single MOSFET. The usage model of Xschem is that the schematic is hierarchically drawn, and the simulation and evaluation statements are contained in the schematics. Further, Xschem offers embedded graphing, which we will mostly use.</p>
<p>A summary of important Xschem keyboard shortcuts is provided in <a href="#sec-xschem-cheatsheet" class="quarto-xref">Section&nbsp;19</a>.</p>
</section>
<section id="circuit-simulation-using-ngspice" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="circuit-simulation-using-ngspice"><span class="header-section-number">1.3</span> Circuit Simulation Using ngspice</h2>
<p>ngspice is an open-source circuit simulator with SPICE dependency <span class="citation" data-cites="Nagel_1975">(<a href="#ref-Nagel_1975" role="doc-biblioref">Nagel 1975</a>)</span>. Besides the usual simulated types like <code>op</code> (operating point), <code>dc</code> (dc sweeps), <code>tran</code> (time-domain), or <code>ac</code> (small-signal frequency sweeps), ngspice offers a script-like control interface, where many different simulation controls and result evaluations can be done. For detailed information please refer to the latest <a href="https://ngspice.sourceforge.io/docs/ngspice-43-manual.pdf">online manual</a>.</p>
<p>Important ngspice simulation commands and options (e.g., to control convergence settings) are listed in <a href="#sec-ngspice-cheatsheet" class="quarto-xref">Section&nbsp;20</a>.</p>
</section>
<section id="integrated-ic-design-environment-iic-osic-tools" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="integrated-ic-design-environment-iic-osic-tools"><span class="header-section-number">1.4</span> Integrated IC Design Environment (IIC-OSIC-TOOLS)</h2>
<p>In order to make use of the various required components (tools like Xschem and ngspice, PDKs like SG13G2) easier, we will use the <strong>IIC-OSIC-TOOLS</strong>. This is a pre-compiled Docker image which allows to do circuit design on a virtual machine on virtually any type of computing equipment (personal PC, Raspberry Pi, cloud server) on various operating systems (Windows, macOS, Linux). For further information like installed tools, how to setup a VM, etc. please look at <a href="https://github.com/iic-jku/IIC-OSIC-TOOLS">IIC-OSIC-TOOLS GitHub page</a>.</p>
<div class="callout callout-style-default callout-warning callout-titled" title="Preparation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Preparation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please make sure to receive information about your personal VM access ahead of the course start.</p>
</div>
</div>
<p>Experienced users can install this image on their personal computer, for JKU students the IIC will host a VM on our compute cluster and provide personal login credentials.</p>
<div class="callout callout-style-default callout-warning callout-titled" title="Linux">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Linux
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this course, we assume that students have a basic knowledge of Linux and how to operate it using the terminal. If you are not yet familiar with Linux (which is basically a must when doing integrated circuit design as many tools are only available on Linux), then please check out a Linux introductory course or tutorial online, there are many resources available.</p>
<p>A summary of important Linux shell commands is provided in <a href="#sec-linux-cheatsheet" class="quarto-xref">Section&nbsp;18</a>.</p>
</div>
</div>
</section>
<section id="setting-up-the-design-directory" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="setting-up-the-design-directory"><span class="header-section-number">1.5</span> Setting up the Design Directory</h2>
<ul>
<li>Open your VM by entering the URL in your browser.</li>
<li>Open a terminal (third icon in taskbar). You should get the following prompt: <code>/foss/designs &gt;</code></li>
<li>Clone the git repository into the current directory: <code>git clone https://github.com/iic-jku/analog-circuit-design.git</code></li>
<li>This Github repository includes a file called <code>.designinit</code>, which sets the PDK and certain paths. However this must be located in <code>/foss/designs/</code></li>
<li>Therefore, we first need to copy it there: <code>cp analog-circuit-design/.designinit .</code></li>
<li>Then we adjust the variable <code>XSCHEM_USER_LIBRARY_PATH</code> by opening the file in an editor e.g.&nbsp;<code>nano .designinit</code>
<ul>
<li>Edit the last line from <code>export XSCHEM_USER_LIBRARY_PATH=$DESIGNS/xschem</code> to <code>export XSCHEM_USER_LIBRARY_PATH=$DESIGNS/analog-circuit-design/xschem</code></li>
</ul></li>
<li>To apply the changes, we need to close the current terminal window: <code>exit</code></li>
<li>Open again a terminal</li>
<li>Test if the correct PDK gets selected: <code>echo $PDK</code></li>
<li>Change into the Github repository: <code>cd analog-circuit-design</code></li>
<li>Start xschem using <code>xschem</code> or directly open a specific schematic using <code>xschem xschem/dc_lv_nmos.sch</code></li>
</ul>
<section id="creating-backups" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="creating-backups"><span class="header-section-number">1.5.1</span> Creating Backups</h3>
<p>You can easily create backups of your work by creating a zip archive of the complete directory.</p>
<ul>
<li>Change to the parent directory: <code>cd /foss/designs/</code></li>
<li>Create a zip archive from the complete design folder: <code>zip backup.zip analog-circuit-design -r</code></li>
</ul>
</section>
<section id="updating-the-repository" class="level3" data-number="1.5.2">
<h3 data-number="1.5.2" class="anchored" data-anchor-id="updating-the-repository"><span class="header-section-number">1.5.2</span> Updating the Repository</h3>
<ul>
<li>Create a backup!</li>
<li>Go to directory: e.g.&nbsp;<code>cd /foss/designs/analog-circuit-design</code></li>
<li>Fetch newest changes from the origin: <code>git fetch origin</code></li>
<li>Merge changes from the origin into local branch ‘master’: <code>git merge origin/main</code></li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled" title="Git Merge Conflicts">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Git Merge Conflicts
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is possible that <code>git merge</code> does not complete successfully. Either you are able to resolve the merge conflict manually, or it may be easier to make a fresh clone of the repository and adding your local changes manually from the backup.</p>
<p><strong>Think twice before executing any git commands without a backup, this could lead to permanent loss of data!</strong></p>
</div>
</div>
</section>
</section>
</section>
<section id="sec-first-steps" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> First Steps</h1>
<p>In this first chapter we will learn to use Xschem for schematic entry, and how to operate the ngspice SPICE simulator for circuit simulations. Further, we will make ourself familiar with the transistor and other passive components available in the IHP Microelectronics SG13G2 technology. While this is strictly speaking a BiCMOS technology offering MOSFETs as well as SiGe HBTs, we will use it as a pure CMOS technology.</p>
<section id="sec-mosfet" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="sec-mosfet"><span class="header-section-number">2.1</span> The Metal-Oxide-Semiconductor Field-Effect-Transistor (MOSFET)</h2>
<p>In this course, we will not dive into semiconductor physics and derive the device operation bottom-up starting from a fundamental level governed by quantum mechanics or a simplified solid-state physics based approach resulting in the well-known square-law model. Instead, we will treat the MOSFET behaviorally by assuming a 4-terminal device, and the performance of this device regarding its terminal voltages and currents we will largely derive from the simulation model.</p>
<p>Since we have an emphasis on integrated circuit design the size of the MOSFET can be adapted by changing its width <span class="math inline">\(W\)</span> and its length <span class="math inline">\(L\)</span>. As we will see later, <span class="math inline">\(L\)</span> has a profound impact on the MOSFET performance allowing to trade-off speed versus output conductance versus device-to-device matching. The width <span class="math inline">\(W\)</span> is more of a scaling parameter to adapt the current <strong>density</strong> (strictly speaking charge density) forming in the MOSFET channel to a desired current. More about this later.</p>
<p>The circuit symbol that we will use for the n-channel MOSFET is shown in <a href="#fig-nmos-symbol" class="quarto-xref">Figure&nbsp;1</a>, and for the p-channel MOSFET it is shown in <a href="#fig-pmos-symbol" class="quarto-xref">Figure&nbsp;2</a>. A control voltage between gate (“G”) and source (“S”) causes a current to flow between drain (“D”) and source. The MOSFET is a 4-terminal device, so the bulk (“B”) can also control the drain-source current flow. Often, the bulk is connected to source, and then the bulk terminal is not shown to declutter the schematics.</p>
<div class="callout callout-style-default callout-note callout-titled" title="MOSFET Background">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
MOSFET Background
</div>
</div>
<div class="callout-body-container callout-body">
<p>Strictly speaking is the drain-source current of a MOSFET controlled by the voltage between gate and bulk and the voltage between drain and source. Since bulk is often connected to source anyway, and many circuit designers historically were already familiar with the operation of the bipolar junction transistor, it is common to consider the gate-source voltage (besides the drain-source voltage) as the controlling voltage.</p>
<p>This focus on gate-source implies that the source is special compared to the drain. In a typical physical MOSFET, however, the drain and source are constructed exactly the same, and which terminal is drain, and which terminal is source, is only determined by the applied voltage potentials, and can change dynamically during operation (think of a MOSFET operating as a switch… which side is the drain, which side is the source?).</p>
<p>Unfortunately, this focus on a “special” source has made its way into some MOSFET compact models. The model that is used in SG13G2 luckily uses the PSP model, which is formulated symmetrically with regards to drain and source, and is thus very well suited for analog and RF circuit design. For a detailed understanding of the PSP model please refer to the <a href="https://www.nxp.com/wcm_documents/models/mos-models/model-psp/psp102p4_summary.pdf">model documentation</a>.</p>
</div>
</div>
<div id="cell-fig-nmos-symbol" class="cell" data-execution_count="1">
<div class="cell-output cell-output-display">
<div id="fig-nmos-symbol" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nmos-symbol-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-nmos-symbol-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Circuit symbol of n-channel MOSFET."><img src="index_files/figure-html/fig-nmos-symbol-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nmos-symbol-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Circuit symbol of n-channel MOSFET.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-pmos-symbol" class="cell" data-execution_count="2">
<div class="cell-output cell-output-display">
<div id="fig-pmos-symbol" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pmos-symbol-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-pmos-symbol-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: Circuit symbol of p-channel MOSFET."><img src="index_files/figure-html/fig-pmos-symbol-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pmos-symbol-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Circuit symbol of p-channel MOSFET.
</figcaption>
</figure>
</div>
</div>
</div>
<p>For hand calculations and theoretical discussions we will use the following simplified large-signal model, shown in <a href="#fig-mosfet-large-signal-model" class="quarto-xref">Figure&nbsp;3</a>. A current source <span class="math inline">\(I_\mathrm{D}\)</span> models the current flow between drain and source, and it is controlled by the three control voltages <span class="math inline">\(V_\mathrm{GS}\)</span>, <span class="math inline">\(V_\mathrm{DS}\)</span>, and <span class="math inline">\(V_\mathrm{SB}\)</span>. Note that in this way (since <span class="math inline">\(I_\mathrm{D}= f(V_\mathrm{DS})\)</span>) also a resistive behavior between D and S can be modelled. In case that B and S are shorted then simply <span class="math inline">\(V_\mathrm{SB} = 0\)</span> and <span class="math inline">\(C_\mathrm{SB}\)</span> is shorted.</p>
<div id="cell-fig-mosfet-large-signal-model" class="cell" data-execution_count="3">
<div class="cell-output cell-output-display">
<div id="fig-mosfet-large-signal-model" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-large-signal-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-mosfet-large-signal-model-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;3: The MOSFET large-signal model. In general, all capacitors are nonlinear, i.e., they depend on their terminal voltages."><img src="index_files/figure-html/fig-mosfet-large-signal-model-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-large-signal-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The MOSFET large-signal model. In general, all capacitors are nonlinear, i.e., they depend on their terminal voltages.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In an ideal MOSFET no dc current is flowing into the gate, the behavior is purely capacitive. We model this by two capacitors: <span class="math inline">\(C_\mathrm{GG}= C_\mathrm{GS}+ C_\mathrm{GD}+ C_\mathrm{GB}\)</span> is the total capacitance when looking into the gate of the MOSFET. <span class="math inline">\(C_\mathrm{GS}\)</span> is usually the dominant capacitance, and <span class="math inline">\(C_\mathrm{GD}\)</span> models the capacitive feedback between D and G, usually induced by a topological overlap capacitance in the physical construction of the MOSFET. This capacitance is often small compared to <span class="math inline">\(C_\mathrm{GS}\)</span>, but in situations where we have a large voltage swing at the drain this capacitance will be affected by the <a href="https://en.wikipedia.org/wiki/Miller_effect">Miller effect</a> (see <a href="#sec-miller-theorem" class="quarto-xref">Section&nbsp;16</a>). In hand calculations we will often set <span class="math inline">\(C_\mathrm{GD}= C_\mathrm{GB}= C_\mathrm{DB}= C_\mathrm{SB}= 0\)</span>.</p>
<p>To model a physical MOSFET there will be also a requirement for resistors in the model to account for terminal access resistances (<span class="math inline">\(R_\mathrm{G}\)</span>, <span class="math inline">\(R_\mathrm{D}\)</span>, and <span class="math inline">\(R_\mathrm{S}\)</span>) as well as resistors to model second-order effects like non-quasistatic operation. For lower frequencies and bulk MOSFETs we will not consider these resistors, and just deal with the capacitive behavior.</p>
<div class="callout callout-style-default callout-note callout-titled" title="MOSFET Bulk Terminal">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
MOSFET Bulk Terminal
</div>
</div>
<div class="callout-body-container callout-body">
<p>In many situations we will connect the bulk and source terminals of a MOSFET together, which results in a simplified large-signal model. As an exercise, look at <a href="#fig-mosfet-large-signal-model" class="quarto-xref">Figure&nbsp;3</a> and draw this simplified model (hint: look at <a href="#fig-mosfet-small-signal-model" class="quarto-xref">Figure&nbsp;5</a> and <a href="#fig-mosfet-small-signal-model-simplified" class="quarto-xref">Figure&nbsp;6</a> for inspiration).</p>
</div>
</div>
<p>Now, as we are skipping the bottom-up approach of deriving the MOSFET large-signal behavior from basic principles, we need to understand the behavior of the elements of the large-signal model in <a href="#fig-mosfet-large-signal-model" class="quarto-xref">Figure&nbsp;3</a> by using a circuit simulator and observing what happens. And generally, a first step in any new IC technology should be to investigate basic MOSFET performance, by doing simple dc sweeps of <span class="math inline">\(V_\mathrm{GS}\)</span> and <span class="math inline">\(V_\mathrm{DS}\)</span> and looking at <span class="math inline">\(I_\mathrm{D}\)</span> and other large- and small-signal parameters.</p>
<p>As a side note, the students who want to understand MOSFET behavior from a physical angle should consult the MOSFET chapter from the JKU course “Design of Complex Integrated Circuits” (VL 336.048). A great introduction into MOSFET operation and fabrication is given in <span class="citation" data-cites="Chenming_Hu_2010">(<a href="#ref-Chenming_Hu_2010" role="doc-biblioref">Hu 2010</a>)</span>, which is available freely <a href="https://www.chu.berkeley.edu/modern-semiconductor-devices-for-integrated-circuits-chenming-calvin-hu-2010/">online</a> and is a recommended read. A very detailed description of the MOSFET (leaving usually no question unanswered) is provided in <span class="citation" data-cites="Tsividis_McAndrew_2011">(<a href="#ref-Tsividis_McAndrew_2011" role="doc-biblioref">Tsividis and McAndrew 2011</a>)</span>.</p>
<p>Now, in order to get started, basic Xschem testbenches are prepared, and first simple dc sweeps of various voltages and currents will be done. But before that, please look at the import note below!</p>
<div class="callout callout-style-default callout-important callout-titled" title="Mathematical Notation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Mathematical Notation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Throughout this material, we will largely stick to the following notation standardized by IEEE:</p>
<ul>
<li>A <strong>dc quantity</strong> is shown with an upper-case variable name with upper-case subscripts, like <span class="math inline">\(V_\mathrm{GS}\)</span>.</li>
<li>Double-subscripts denote <strong>dc sources</strong>, like <span class="math inline">\(V_\mathrm{DD}\)</span> and <span class="math inline">\(V_\mathrm{SS}\)</span>.</li>
<li>An <strong>ac (small-signal) quantity</strong> (incremental quantity) has a lower-case variable name with a lower-case subscript, like <span class="math inline">\(g_\mathrm{m}\)</span>.</li>
<li>A <strong>total quantity</strong> (dc plus ac) is shown as a lowercase variable name with upper-case subscript, like <span class="math inline">\(i_\mathrm{DS}\)</span>.</li>
<li>An upper-case variable name with a lower-case subscript is used to denote <strong>RMS quantities</strong>, like <span class="math inline">\(I_\mathrm{ds}\)</span>.</li>
</ul>
</div>
</div>
<section id="large-signal-mosfet-model" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="large-signal-mosfet-model"><span class="header-section-number">2.1.1</span> Large-Signal MOSFET Model</h3>
<p>We start with an investigation into the large-signal MOSFET model shown in <a href="#fig-mosfet-large-signal-model" class="quarto-xref">Figure&nbsp;3</a> by using the simple testbench for the LV NMOS shown in <a href="#fig-simple-nmos-tb" class="quarto-xref">Figure&nbsp;4</a>.</p>
<div id="fig-simple-nmos-tb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simple-nmos-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/dc_lv_nmos.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;4: Testbench for NMOS dc sweeps."><img src="./xschem/dc_lv_nmos.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simple-nmos-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Testbench for NMOS dc sweeps.
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="MOSFET Simulation Model">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
MOSFET Simulation Model
</div>
</div>
<div class="callout-body-container callout-body">
<p>For modelling the MOSFET behavior in a circuit simulator like ngspice different models are available. Some of these models have been widely adopted, like the <a href="https://en.wikipedia.org/wiki/BSIM">BSIM</a> (Berkeley Short-channel IGFET Model) or PSP (Philips Penn State) model. The PSP model version 103.6 is used in the IHP SG13G2 PDK for the LV and HV MOSFET. This model has several advantages:</p>
<ul>
<li>Physics-based surface-potential model</li>
<li>Symmetric formulation with respect to drain and source</li>
<li>Support for mobility reduction, velocity saturation, DIBL, gate current, lateral doping gradient effects, STI stress, NQS, etc.</li>
</ul>
<p>The PSP 103.6 model documentation can be found <a href="https://www.cea.fr/cea-tech/leti/pspsupport/Documents/psp103p6_summary.pdf">here</a>. In chapter 8 the dc operating point output of the model (these parameters can be queried in ngspice) is explained, which is helpful to interpret the simulation output.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: MOSFET Investigation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: MOSFET Investigation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please try to execute the following steps and answer these questions:</p>
<ol type="1">
<li>Get the LV NMOS testbench (available at <a href="https://github.com/iic-jku/analog-circuit-design/blob/main/xschem/dc_lv_nmos.sch" class="uri">https://github.com/iic-jku/analog-circuit-design/blob/main/xschem/dc_lv_nmos.sch</a>) working in your IIC-OSIC-TOOLS environment.</li>
<li>Make yourself familiar with Xschem (change the schematic in various ways, run a simulation, graph the result).</li>
<li>Make yourself familiar with ngspice (run various simulations, save nets and parameters, use the embedded Xschem graphing, explore the interactive ngspice shell to look at MOSFET model parameters).</li>
<li>Explore the LV NMOS <code>sg13_lv_nmos</code>:
<ol type="1">
<li>How is <span class="math inline">\(I_\mathrm{D}\)</span> affected by <span class="math inline">\(V_\mathrm{GS}\)</span> and <span class="math inline">\(V_\mathrm{DS}\)</span>?</li>
<li>Change <span class="math inline">\(W\)</span> and <span class="math inline">\(L\)</span> of the MOSFET. What is the impact on the above parameters? Can you explain the variations?</li>
<li>Look at the capacitance values for <span class="math inline">\(C_\mathrm{GS}\)</span>, <span class="math inline">\(C_\mathrm{GB}\)</span>, <span class="math inline">\(C_\mathrm{GD}\)</span>, and <span class="math inline">\(C_\mathrm{DB}\)</span>. How are they affected by <span class="math inline">\(W\)</span> and <span class="math inline">\(L\)</span> and by changing the bias conditions (play with <span class="math inline">\(V_\mathrm{GS}\)</span> and <span class="math inline">\(V_\mathrm{DS}\)</span>)?</li>
<li>When looking at the model parameters in ngspice, you see that there is a <span class="math inline">\(C_\mathrm{GD}\)</span> and a <span class="math inline">\(C_\mathrm{DG}\)</span>. Why is this, what could be the difference? Sometimes these capacitors show a negative value, why? (Hint: Study <a href="#nte-maxwell-cap-matrix" class="quarto-xref">Note&nbsp;1</a>)</li>
</ol></li>
<li>Build testbenches in Xschem for the LV PMOS, the HV NMOS, and the HV PMOS. Explore the different results.
<ol type="1">
<li>For a given <span class="math inline">\(W\)</span> and <span class="math inline">\(L\)</span>, which device provides more drain current? How are the capacitances related?</li>
<li>If you would have to size an inverter, what would be the ideal ratio of <span class="math inline">\(W_p/W_n\)</span>? Will you exactly design this ratio, or are the reasons to deviate?</li>
<li>There are LV and HV MOSFETs, and you investigated the difference in performance. What is the rationale when designing circuits for selection either an LV type, and when to choose an HV type?</li>
</ol></li>
<li>Build a test bench to explore the body effect, start with LV NMOS.
<ol type="1">
<li>What happens when <span class="math inline">\(V_\mathrm{SB}\neq 0\)</span>?</li>
</ol></li>
</ol>
</div>
</div>
</section>
<section id="sec-mosfet-smallsignal-model" class="level3" data-number="2.1.2">
<h3 data-number="2.1.2" class="anchored" data-anchor-id="sec-mosfet-smallsignal-model"><span class="header-section-number">2.1.2</span> Small-Signal MOSFET Model</h3>
<p>As you have seen in the previous investigations, the large-signal model of <a href="#fig-mosfet-large-signal-model" class="quarto-xref">Figure&nbsp;3</a> describes the behavior of the MOSFET across a wide range of voltages applied at the MOSFET terminals. Unfortunately, for hand analysis dealing with a nonlinear model is close to impossible, at the very least it is quite tedious.</p>
<p>However, for many practical situations, we bias a MOSFET with a set of dc voltages applied to its terminal, and only apply small signal excursions during operation. If we do this, we can linearize the large-signal model in this dc operating point, and resort to a small-signal model which can be very useful for hand calculations. Many experienced designers analyze their circuits by doing these kind of hand calculations and describing the circuit analytically, which is a great way to understand fundamental performance limits and relationships between parameters.</p>
<p>We will use the small-signal MOSFET model shown in <a href="#fig-mosfet-small-signal-model" class="quarto-xref">Figure&nbsp;5</a> for this course. The current-source <span class="math inline">\(i_\mathrm{d}= g_\mathrm{m}v_\mathrm{gs}\)</span> models the drain current <span class="math inline">\(I_\mathrm{D}\)</span> as a function of <span class="math inline">\(V_\mathrm{GS}\)</span> with</p>
<p><span class="math display">\[
g_\mathrm{m}= \frac{\partial I_\mathrm{D}(V_\mathrm{GS}, V_\mathrm{DS}, V_\mathrm{SB})}{\partial V_\mathrm{GS}},
\]</span></p>
<p>and the resistor <span class="math inline">\(g_\mathrm{ds}\)</span> models the dependency of the drain current by <span class="math inline">\(V_\mathrm{DS}\)</span>:</p>
<p><span class="math display">\[
g_\mathrm{ds}= \frac{\partial I_\mathrm{D}(V_\mathrm{GS}, V_\mathrm{DS}, V_\mathrm{SB})}{\partial V_\mathrm{DS}}
\]</span></p>
<p>The drain current dependency on the source-bulk voltage (the so-called “body effect”) is introduced by the current source <span class="math inline">\(i_\mathrm{d}= g_\mathrm{mb} v_\mathrm{sb}\)</span>:</p>
<p><span class="math display">\[
g_\mathrm{mb}= \frac{\partial I_\mathrm{D}(V_\mathrm{GS}, V_\mathrm{DS}, V_\mathrm{SB})}{\partial V_\mathrm{SB}}
\]</span></p>
<div id="cell-fig-mosfet-small-signal-model" class="cell" data-execution_count="4">
<div class="cell-output cell-output-display">
<div id="fig-mosfet-small-signal-model" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-small-signal-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-mosfet-small-signal-model-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;5: The MOSFET small-signal model."><img src="index_files/figure-html/fig-mosfet-small-signal-model-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-small-signal-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: The MOSFET small-signal model.
</figcaption>
</figure>
</div>
</div>
</div>
<p>As has been mentioned before, in many situations (and whenever we want to use a simplified model) we connect source and bulk of the MOSFET together. This results in the much simplified small-signal model shown in <a href="#fig-mosfet-small-signal-model-simplified" class="quarto-xref">Figure&nbsp;6</a>.</p>
<div id="cell-fig-mosfet-small-signal-model-simplified" class="cell" data-execution_count="5">
<div class="cell-output cell-output-display">
<div id="fig-mosfet-small-signal-model-simplified" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-small-signal-model-simplified-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-mosfet-small-signal-model-simplified-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;6: The MOSFET small-signal model when source and bulk are shorted."><img src="index_files/figure-html/fig-mosfet-small-signal-model-simplified-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-small-signal-model-simplified-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: The MOSFET small-signal model when source and bulk are shorted.
</figcaption>
</figure>
</div>
</div>
</div>
<p>As any electronic device the MOSFET introduces noise into the circuit. In this course we will only consider the <strong>drain-source current noise</strong> of the MOSFET, given by</p>
<p><span id="eq-mosfet-noise"><span class="math display">\[
\overline{I_\mathrm{n}^2} = 4 k T \gamma g_\mathrm{d0},
\tag{1}\]</span></span></p>
<p>where <span class="math inline">\(\overline{I_\mathrm{n}^2}\)</span> is the one-sided power-spectral density of the noise in A<span class="math inline">\(^2\)</span>/Hz; <span class="math inline">\(k\)</span> is the Boltzmann constant; <span class="math inline">\(T\)</span> is the absolute temperature; <span class="math inline">\(\gamma\)</span> is a (fitting) parameter in simplified theory changing between <span class="math inline">\(\gamma = 2/3\)</span> in saturation and <span class="math inline">\(\gamma =1\)</span> for triode operation; <span class="math inline">\(g_\mathrm{d0}\)</span> is equal to <span class="math inline">\(g_\mathrm{m}\)</span> in saturation and <span class="math inline">\(g_\mathrm{ds}\)</span> in triode).</p>
<div class="callout callout-style-default callout-note callout-titled" title="MOSFET Triode and Saturation Region">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
MOSFET Triode and Saturation Region
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sometimes we will refer to different operating modes of the MOSFET like “saturation” or “triode.” Generally speaking, when the drain-source voltage is small, then the MOSFET acts as a voltage-controlled resistor (since the impact of both <span class="math inline">\(V_\mathrm{GS}\)</span> and <span class="math inline">\(V_\mathrm{DS}\)</span> on <span class="math inline">\(I_\mathrm{D}\)</span> is large), and this mode of operation we call “<strong>triode</strong>” mode.</p>
<p>When the drain-source voltage <span class="math inline">\(V_\mathrm{DS}\)</span> is increased, at some point the drain-source current saturates and is only a weak function of the drain-source voltage, while still being well controlled by <span class="math inline">\(V_\mathrm{GS}\)</span>. This mode is called “<strong>saturation</strong>” mode.</p>
<p>As you can see in the large-signal investigations, these transitions happen gradually, and it is difficult to define a precise point where one operating mode switches to the other one. In this sense we use terms like “triode” and “saturation” only in an approximate sense.</p>
</div>
</div>
<p>We can also consider an even more reduced small-signal MOSFET model compared to <a href="#fig-mosfet-small-signal-model-simplified" class="quarto-xref">Figure&nbsp;6</a>, which is shown in <a href="#fig-mosfet-small-signal-model-basic" class="quarto-xref">Figure&nbsp;7</a>. In this, we just consider the transconductance <span class="math inline">\(g_\mathrm{m}\)</span>, the input capacitor <span class="math inline">\(C_\mathrm{gg}\)</span>, as well as the output conductance <span class="math inline">\(g_\mathrm{ds}\)</span>. Note that we can redraw the pi-model of <a href="#fig-mosfet-small-signal-model-basic" class="quarto-xref">Figure&nbsp;7</a> into the <span class="math inline">\(\tau\)</span>-model of <a href="#fig-mosfet-small-signal-model-basic-t" class="quarto-xref">Figure&nbsp;8</a>. Depending on the circuit configuration, either the first or the second form results in simpler calculations of the circuit equations.</p>
<div id="cell-fig-mosfet-small-signal-model-basic" class="cell" data-execution_count="6">
<div class="cell-output cell-output-display">
<div id="fig-mosfet-small-signal-model-basic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-small-signal-model-basic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-mosfet-small-signal-model-basic-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;7: The MOSFET small-signal basic pi-model."><img src="index_files/figure-html/fig-mosfet-small-signal-model-basic-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-small-signal-model-basic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: The MOSFET small-signal basic pi-model.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-mosfet-small-signal-model-basic-t" class="cell" data-execution_count="7">
<div class="cell-output cell-output-display">
<div id="fig-mosfet-small-signal-model-basic-t" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-small-signal-model-basic-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-mosfet-small-signal-model-basic-t-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure&nbsp;8: The MOSFET small-signal basic T-model."><img src="index_files/figure-html/fig-mosfet-small-signal-model-basic-t-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-small-signal-model-basic-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: The MOSFET small-signal basic T-model.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: MOSFET Model Transformation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: MOSFET Model Transformation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Can you show, with which circuit manipulations you can transform the pi-model of <a href="#fig-mosfet-small-signal-model-basic" class="quarto-xref">Figure&nbsp;7</a> into the T-model of <a href="#fig-mosfet-small-signal-model-basic-t" class="quarto-xref">Figure&nbsp;8</a>?</p>
</div>
</div>
<p>A metric which is useful to assess the speed of a MOSFET is the so-called <strong>transit frequency</strong> <span class="math inline">\(f_\mathrm{T}\)</span>. It is defined as the frequency where the small-signal current gain (output current divided by the input current) of a MOSFET driven by a voltage-source at the input and loaded by a voltage source at the output drops to unity (reaches one). It can easily be derived using the simplified MOSFET small-signal model of <a href="#fig-mosfet-small-signal-model-simplified" class="quarto-xref">Figure&nbsp;6</a> by driving it with a voltage source and shorting the output to (neglecting the feed-forward current introduced by <span class="math inline">\(C_\mathrm{gd}\)</span>) <span id="eq-mosfet-transit-frequency"><span class="math display">\[
\omega_\mathrm{T} = 2 \pi f_\mathrm{T} \approx \frac{g_\mathrm{m}}{C_\mathrm{gg}} = \frac{g_\mathrm{m}}{C_\mathrm{gs}+ C_\mathrm{gd}+ C_\mathrm{gb}}.
\tag{2}\]</span></span> This frequency is an extrapolated frequency where the MOSFET operation is dominated by several second-order effects (hence <a href="#eq-mosfet-transit-frequency" class="quarto-xref">Equation&nbsp;2</a> is not valid any longer). A rule-of-thumb is to use a MOSFET up to approximately <span class="math inline">\(f_\mathrm{T} / 10\)</span>. In any case, <span class="math inline">\(f_\mathrm{T}\)</span> is a proxy of the speed of a MOSFET; in other words, how much input capacitance <span class="math inline">\(C_\mathrm{gg}\)</span> is incurred when creating a certain <span class="math inline">\(g_\mathrm{m}\)</span>.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: MOSFET Transit Frequency">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: MOSFET Transit Frequency
</div>
</div>
<div class="callout-body-container callout-body">
<p>As a home exercise, try to derive <a href="#eq-mosfet-transit-frequency" class="quarto-xref">Equation&nbsp;2</a> starting from <a href="#fig-mosfet-small-signal-model-simplified" class="quarto-xref">Figure&nbsp;6</a>. By showing this transformation you can proof that indeed both circuits are electrically equivalent.</p>
</div>
</div>
<p>Now we need to see how the small-signal parameters seen in <a href="#fig-mosfet-small-signal-model" class="quarto-xref">Figure&nbsp;5</a> can be investigated and estimated using circuit simulation.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: MOSFET Small-Signal Parameters">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: MOSFET Small-Signal Parameters
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please try to execute the following steps and answer the following questions:</p>
<ol type="1">
<li>Reuse the LV NMOS testbench (available at <a href="https://github.com/iic-jku/analog-circuit-design/blob/main/xschem/dc_lv_nmos.sch" class="uri">https://github.com/iic-jku/analog-circuit-design/blob/main/xschem/dc_lv_nmos.sch</a>).</li>
<li>Explore the LV NMOS <code>sg13_lv_nmos</code>:
<ol type="1">
<li>How are <span class="math inline">\(g_\mathrm{m}\)</span> and <span class="math inline">\(g_\mathrm{ds}\)</span> changing when you change the dc node voltages?</li>
<li>What is the ratio of <span class="math inline">\(g_\mathrm{m}\)</span> to <span class="math inline">\(g_\mathrm{mb}\)</span>? What is the physical reason behind this ratio (you might want to revisit MOSFET device physics at this point)?</li>
<li>Take a look at the device capacitances <span class="math inline">\(C_\mathrm{gs}\)</span>, <span class="math inline">\(C_\mathrm{gd}\)</span>, and <span class="math inline">\(C_\mathrm{gb}\)</span>. Why are they important? What is the <span class="math inline">\(f_\mathrm{T}\)</span> of the MOSFET?</li>
<li>Look at the drain noise current according to the MOSFET model and compare with a hand calculation of the noise. In the noise equation there is the factor <span class="math inline">\(\gamma\)</span>, which in triode is <span class="math inline">\(\gamma=1\)</span> and in saturation is <span class="math inline">\(\gamma=2/3\)</span> according to basic text books. Which value of <span class="math inline">\(\gamma\)</span> are you calculating? Why might it be different?</li>
</ol></li>
<li>Go back to your testbench for the LVS PMOS <code>sg13_lv_pmos</code>:
<ol type="1">
<li>What is the difference in <span class="math inline">\(g_\mathrm{m}\)</span>, <span class="math inline">\(g_\mathrm{ds}\)</span>, and other parameters between the NMOS and the PMOS? Why could they be different?</li>
</ol></li>
</ol>
</div>
</div>
<div id="nte-maxwell-cap-matrix" class="callout callout-style-default callout-note callout-titled" title="Maxwell Capacitance Matrix">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;1: Maxwell Capacitance Matrix
</div>
</div>
<div class="callout-body-container callout-body">
<p>A Maxwell capacitance matrix <span class="citation" data-cites="Maxwell_1873">(<a href="#ref-Maxwell_1873" role="doc-biblioref">Maxwell 1873</a>)</span> provides the relation between voltages on a set of conductors and the charges on these conductors. For a given conductor set with <span class="math inline">\(N\)</span> conductors (and thus <span class="math inline">\(N\)</span> terminals) the relation is <span class="math display">\[
\mathbf{Q} = \mathbf{C} \cdot \mathbf{V}
\]</span> where <span class="math inline">\(\mathbf{Q}\)</span> is a vector of the charges on the <span class="math inline">\(N\)</span> conductors, <span class="math inline">\(\mathbf{C}\)</span> is a <span class="math inline">\(N \times N\)</span> capacitance matrix, and <span class="math inline">\(\mathbf{V}\)</span> is the potential vector. In the case of two conductors and physical capacitances between them, <span class="math inline">\(\mathbf{C}\)</span> is given by <span class="math display">\[
\mathbf{C} =
\begin{pmatrix}
C_{11} + C_{12} &amp; -C_{12} \\
-C_{21} &amp; C_{21} + C_{22} \\
\end{pmatrix}
\]</span> where <span class="math inline">\(C_{xx} = \partial Q_x / \partial V_x\)</span> is the auto capacitance from a conductor <span class="math inline">\(x\)</span> towards infinity (ground), and <span class="math inline">\(C_{xy} = \partial Q_x / \partial V_y\)</span> is the mutual capacitance from node/conductor <span class="math inline">\(x\)</span> to node/conductor <span class="math inline">\(y\)</span>. For a physical capacitor <span class="math inline">\(C_{xy} = C_{yx}\)</span>.</p>
<p>Using the above equation to calculate <span class="math inline">\(Q_1\)</span> (the charge on conductor <span class="math inline">\(1\)</span>) results in <span class="math display">\[
Q_1 = ( C_{11} + C_{12} ) V_1 - C_{12} V_2 = C_{11} (V_1 - 0) + C_{12} (V_1 - V_2)
\]</span> which is the expected result.</p>
<p>Such a Maxwell capacitance formulation is also used in the MOSFET model to describe the charge at a terminal as a function of potential at another terminal. So, <span class="math display">\[
C_\mathrm{GD}= \frac{\partial Q_\mathrm{G}}{\partial V_\mathrm{D}}
\]</span> or <span class="math display">\[
C_\mathrm{GG}= \frac{\partial Q_\mathrm{G}}{\partial V_\mathrm{G}}
\]</span> with <span class="math inline">\(Q_\mathrm{G}\)</span> the charge at terminal G in response to either <span class="math inline">\(V_\mathrm{D}\)</span> or <span class="math inline">\(V_\mathrm{G}\)</span>. Note that in a MOSFET, generally <span class="math inline">\(C_{xy} \ne C_{yx}\)</span>!</p>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">2.2</span> Conclusion</h2>
<p>Congratulations for making it thus far! By now you should have a solid grasp of the tool handling of Xschem and ngspice, and you should be familiar with the large- and small-signal operation of both NMOS and PMOS, and the parameters describing these behaviors. If you feel you are not sufficiently fluent in these things, please go back to the beginning of <a href="#sec-mosfet" class="quarto-xref">Section&nbsp;2.1</a> and revisit the relevant sections, or dive into further reading about the MOSFET operation, like in <span class="citation" data-cites="Chenming_Hu_2010">(<a href="#ref-Chenming_Hu_2010" role="doc-biblioref">Hu 2010</a>)</span>.</p>
</section>
</section>
<section id="sec-gmid-method" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Transistor Sizing Using gm/ID Methodology</h1>
<p>When designing integrated circuits it is an important question how to select various parameters of a MOSFET, like <span class="math inline">\(W\)</span>, <span class="math inline">\(L\)</span>, or the bias current <span class="math inline">\(I_\mathrm{D}\)</span>. In comparison to using discrete components in PCB design, or also compared to a bipolar junction transistor (BJT), we have these degrees of freedom, which make integrated circuit design so interesting.</p>
<p>Often, transistor sizing in entry-level courses is based on the square-law model, where a simple analytical equation for the drain current can be derived. However, in nanometer CMOS, the MOSFET behavior is much more complex than these simple models. Also, this highly simplified derivations introduce concepts like the threshold voltage or the overdrive voltage, which are interesting from a theoretical viewpoint, but bear little practical use.</p>
<div class="callout callout-style-default callout-note callout-titled" title="MOSFET Square-Law Model">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
MOSFET Square-Law Model
</div>
</div>
<div class="callout-body-container callout-body">
<p>One of the many simplifications of the square-law model is that the mobility of the charge carriers is assumed constant (it is not). Further, the existence of a threshold voltage is assumed, but in fact this voltage is just existing given a certain definition, and depending on definition, its value changed. In addition, in nm CMOS, the threshold voltage is a function on many thing, like <span class="math inline">\(W\)</span> and <span class="math inline">\(L\)</span>.</p>
</div>
</div>
<p>An additional shortcoming of the square-law model is that it is only valid in strong inversion, i.e.&nbsp;for large <span class="math inline">\(V_\mathrm{GS}\)</span> where the drain current is dominated by the drift current. As soon as the gate-source voltage gets smaller, the square-law model breaks, as the drain current component based on diffusion currents gets dominant. Modern compact MOSFET models (like the PSP model used in SG13G2) use hundreds of parameters and fairly complex equations to somewhat properly describe MOSFET behavior over a wide range of parameters like <span class="math inline">\(W\)</span>, <span class="math inline">\(L\)</span>, and temperature. A modern approach to MOSFET sizing is thus based on the thought to use exactly these MOSFET models, characterize them, put the resulting data into tables and charts, and thus learn about the complex MOSFET behavior and use it for MOSFET sizing.</p>
<p>Being a well-established approach we select the <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> methodology introduced by P. Jespers and B. Murmann in <span class="citation" data-cites="Jespers_Murmann_2017">(<a href="#ref-Jespers_Murmann_2017" role="doc-biblioref">Jespers and Murmann 2017</a>)</span>. A brief introduction is available <a href="https://github.com/iic-jku/analog-circuit-design/blob/main/sizing/Ref_Murmann_gmID.pdf">here</a> as well.</p>
<p>The <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> methodology has the huge advantage that is catches MOSFET behavior quite accurately over a wide range of operating conditions, and the curves look very similar for pretty much all CMOS technologies, from micrometer bulk CMOS down to nanometer FinFET devices. Of course the absolute values change, but the method applies universally.</p>
<section id="sec-techsweep-testbench" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="sec-techsweep-testbench"><span class="header-section-number">3.1</span> MOSFET Characterization Testbench</h2>
<p>In order to get the required tabulated data we use a testbench in Xschem which sweeps the terminal voltages, and records various large- and small-signal parameters, which are then stored in large tables. The testbench for the LV NMOS is shown in <a href="#fig-techsweep-nmos-tb" class="quarto-xref">Figure&nbsp;9</a>, and the TB for the LV PMOS is shown in <a href="#fig-techsweep-pmos-tb" class="quarto-xref">Figure&nbsp;10</a>.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Note on Characterization Testbench">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note on Characterization Testbench
</div>
</div>
<div class="callout-body-container callout-body">
<p>The testbenches are relatively straightforward, with one exception: The drain current noise is sensed via the drain voltage source <code>vd</code> and converted to a noise voltage (node <code>n</code>) using a current-controlled voltage source (CCVS). This is necessary as the <code>.noise</code> simulation statement works with voltages.</p>
</div>
</div>
<div id="fig-techsweep-nmos-tb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-techsweep-nmos-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/techsweep_sg13g2_lv_nmos.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Figure&nbsp;9: Testbench for LV NMOS g_\mathrm{m}/I_\mathrm{D} characterization."><img src="./xschem/techsweep_sg13g2_lv_nmos.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-techsweep-nmos-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Testbench for LV NMOS <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> characterization.
</figcaption>
</figure>
</div>
<div id="fig-techsweep-pmos-tb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-techsweep-pmos-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/techsweep_sg13g2_lv_pmos.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure&nbsp;10: Testbench for LV PMOS g_\mathrm{m}/I_\mathrm{D} characterization."><img src="./xschem/techsweep_sg13g2_lv_pmos.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-techsweep-pmos-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Testbench for LV PMOS <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> characterization.
</figcaption>
</figure>
</div>
<p>We will use Jupyter notebooks to inspect the resulting data, and interpret some important graphs. This will greatly help to understand the MOSFET behavior.</p>
</section>
<section id="sec-techsweep-nmos" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sec-techsweep-nmos"><span class="header-section-number">3.2</span> NMOS Characterization in Saturation</h2>
<p>First, we will start looking at the LV NMOS. In <a href="#sec-techsweep-pmos" class="quarto-xref">Section&nbsp;3.3</a> we have the corresponding graphs for the LV PMOS. In this lecture, we will only use the LV MOSFETs. While there are also the HV types available, they are mainly used for high-voltage circuits, like circuits connecting to the outside world. Here, we only will design low-voltage circuits running at a nominal supply voltage of <span class="math inline">\(1.5\,\text{V}\)</span>, so only the LV types are of interest to us.</p>
<p>In the plots that follow we will set <span class="math inline">\(V_\mathrm{ds}= V_\mathrm{DD}/2\)</span> to keep the MOSFET in saturation (as this is the region of operation where most MOSFET are operated when working in class-A). We will later also look at the MOSFET performance in triode operation, as this is the operation mode where the MOSFET is used as a switch. While the <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> method is primarily intended to be used for circuits where the MOSFETs are held in saturation and are biased by a certain bias current (usually referred to <a href="https://en.wikipedia.org/wiki/Power_amplifier_classes#Class_A">class-A</a>), the generated tables using the testbenches of <a href="#sec-techsweep-testbench" class="quarto-xref">Section&nbsp;3.1</a> contain the data for all MOSFET bias points.</p>
<p>The first import graph is the plot of <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> and <span class="math inline">\(f_\mathrm{T}\)</span> versus the gate-source voltage <span class="math inline">\(V_\mathrm{GS}\)</span>. First let us answer the question why <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> is a good parameter to look at, and actually this is also the central parameter in the <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> methodology. In many circuits we want to get a large amplification from a MOSFET, which corresponds to a large <span class="math inline">\(g_\mathrm{m}\)</span>. We want to achieve this by spending the minimum biasing current possible (ideally zero), as we almost always design for lowest power consumption. Thus, a high <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> ratio is good.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Power Consumption">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Power Consumption
</div>
</div>
<div class="callout-body-container callout-body">
<p>Designing for minimum power consumption is pretty much always mandated. For battery-operated equipment it is a paramount requirement, but also in other equipment electrical energy consumption is a concern, and often severely limited by the cooling capabilities of the electrical system.</p>
</div>
</div>
<p>However, as can be seen in the below plot, there exists a strong and unfortunate trade-off with device speed, characterized here by the transit frequency <span class="math inline">\(f_\mathrm{T}\)</span>. It would be ideal if there exists a design point where we get high transconductance per bias current concurrently to having the fastest operation, but unfortunately, this is clearly not the case. The <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> peaks for <span class="math inline">\(V_\mathrm{GS}&lt; 0.3\,\text{V}\)</span>, and the highest speed we get at <span class="math inline">\(V_\mathrm{GS}\approx 1.2\,\text{V}\)</span>. The dashed vertical line plots the nominal threshold voltage, as you can see in this continuum of parameter space, it marks not a particularly special point.</p>
<p>Note that <span id="eq-mosfet-gmid-weakinversion"><span class="math display">\[
\frac{g_\mathrm{m}}{I_\mathrm{D}} = \frac{1}{n V_\mathrm{T}}
\tag{3}\]</span></span> for a MOSFET in weak inversion (i.e., small gate-source voltage). <span class="math inline">\(n\)</span> is the subthreshold slope, and <span class="math inline">\(V_\mathrm{T} = k T / q\)</span> which is <span class="math inline">\(25.8\,\text{mV}\)</span> at <span class="math inline">\(300\,\text{K}\)</span>. We thus have <span class="math inline">\(n \approx 1.38\)</span> for this LV NMOS, which falls nicely into the usual range for <span class="math inline">\(n\)</span> of <span class="math inline">\(1.3\)</span> to <span class="math inline">\(1.5\)</span> for bulk CMOS (FinFET have <span class="math inline">\(n\)</span> very close to <span class="math inline">\(1\)</span>).</p>
<p>For the classical square-law model of the MOSFET in strong inversion, <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> is given as <span id="eq-mosfet-gmid-stronginversion"><span class="math display">\[
\frac{g_\mathrm{m}}{I_\mathrm{D}} = \frac{2}{V_\mathrm{GS}- V_\mathrm{th}} = \frac{2}{V_\mathrm{od}}
\tag{4}\]</span></span> with <span class="math inline">\(V_\mathrm{th}\)</span> the threshold voltage and <span class="math inline">\(V_\mathrm{od}\)</span> the so-called “overdrive voltage.”</p>
<div class="callout callout-style-default callout-note callout-titled" title="Why 300K?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why 300K?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why are we so often using a temperature of <span class="math inline">\(300\,\text{K}\)</span> for a typical condition? As this corresponds to roughly <span class="math inline">\(27^{\circ}\text{C}\)</span>, this accounts for some self heating compared to otherwise cooler usual room temperatures. Further, engineers like round numbers which are easy to remember, so <span class="math inline">\(300\,\text{K}\)</span> is used as a proxy for room temperature.</p>
</div>
</div>
<p>As we can also see from belows plot, the peak transit frequency of the LV NMOS is about <span class="math inline">\(75\,\text{GHz}\)</span>, which allows building radio-frequency circuits up to ca. <span class="math inline">\(f_\mathrm{T} / 10 = 7.5\,\text{GHz}\)</span>, which is a respectable number. It is no coincidence, that the transition for RF design in the GHz-range switched from BJT-based technologies to CMOS roughly in the time frame when 130nm CMOS became available (ca. 2000).</p>
<div class="quarto-embed-nb-cell">
<div id="cell-5" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:08.151250Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:07.778457Z&quot;}" data-tags="[&quot;fig-nmos-gmid-ft-vs-vgs&quot;]" data-execution_count="5">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-6-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-6-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>The following figure plots <span class="math inline">\(f_\mathrm{T}\)</span> against <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> for several different <span class="math inline">\(L\)</span>. As you can see, device speeds maximizes for a low <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> and a short <span class="math inline">\(L\)</span>. As you can see the drain-source voltage is kept at <span class="math inline">\(V_\mathrm{DS}= 0.75\,\text{V} = V_\mathrm{DD}/ 2\)</span>, which is a typical value keeping the MOSFET in saturation across the characterization sweeps. Further, the source-bulk voltage is kept at <span class="math inline">\(V_\mathrm{SB} = 0\,\text{V}\)</span>, which means bulk and source terminals are connected.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-8" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:08.636920Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:08.496476Z&quot;}" data-tags="[&quot;fig-nmos-ft-vs-gmid-vs-l&quot;]" data-execution_count="8">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-9-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-9-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>The next plot shows the ratio of <span class="math inline">\(g_\mathrm{m}/ g_\mathrm{ds}\)</span> versus <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span>. The ratio <span class="math inline">\(g_\mathrm{m}/ g_\mathrm{ds}\)</span> is the so-called <strong>“self-gain”</strong> of the MOSFET, and shows the maximum voltage gain we can achieve in a single transistor configuration. As one can see the self gain increases for increasing <span class="math inline">\(L\)</span>, but this also gives a slower transistor, so again there is a trade-off. This plot allows us to select the proper <span class="math inline">\(L\)</span> of a MOSFET if we know which amount of self gain we need.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-9" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:08.758497Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:08.637839Z&quot;}" data-tags="[&quot;fig-nmos-gmgds-vs-gmid-vs-l&quot;]" data-execution_count="9">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-10-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-10-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>The following figure plots the drain current density <span class="math inline">\(I_\mathrm{D}/W\)</span> as a function of <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> and <span class="math inline">\(L\)</span>. With this plot we can find out how to set the <span class="math inline">\(W\)</span> of a MOSFET once we know the biasing current <span class="math inline">\(I_\mathrm{D}\)</span>, the <span class="math inline">\(L\)</span> (selected according to self gain, <span class="math inline">\(f_\mathrm{T}\)</span>, and other considerations) and the <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> design point we selected. The drain current density <span class="math inline">\(I_\mathrm{D}/W\)</span> is a very useful normalized metric to use, because the physical action in the MOSFET establishes a charge density in the channel below the gate, and the changing of the <span class="math inline">\(W\)</span> of the device merely transforms this charge density into an absolute parameter (together with <span class="math inline">\(L\)</span>).</p>
<div class="quarto-embed-nb-cell">
<div id="cell-10" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:08.963903Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:08.759239Z&quot;}" data-tags="[&quot;fig-nmos-jd-vs-gmid-vs-l&quot;]" data-execution_count="10">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-11-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-11-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>The following plot shows the minimum drain-source voltage <span class="math inline">\(V_\mathrm{ds,sat}\)</span> that we need to establish in order to keep the MOSFET in saturation. As you can see, this value is almost independent of <span class="math inline">\(L\)</span>, and increases for small <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span>. So for low-voltage circuits, where headroom is precious, we tend to bias at <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\ge 10\)</span>, wheres for fast circuits we need to go to small <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\le 5\)</span> requiring substantial voltage headroom per MOSFET stage that we stack on top of each other.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-11" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:09.074153Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:08.964633Z&quot;}" data-tags="[&quot;fig-nmos-vdsat-vs-gmid-vs-l&quot;]" data-execution_count="11">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-12-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-12-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>For analog circuits the noise performance is usually quite important. Thermal noise of a resistor (the Johnson-Nyquist noise) has a flat power-spectral density (PSD) given by <span class="math inline">\(\overline{V_\mathrm{n}^2}/\Delta f = 4 k T R\)</span>, where <span class="math inline">\(k\)</span> is Boltzmann’s constant, <span class="math inline">\(T\)</span> absolute temperature, and <span class="math inline">\(R\)</span> the value of the resistor (the unit of <span class="math inline">\(\overline{V_\mathrm{n}^2}/\Delta f\)</span> is <span class="math inline">\(\text{V}^2/\text{Hz}\)</span>). This PSD is essentially flat until very high frequencies where <a href="https://en.wikipedia.org/wiki/Johnson–Nyquist_noise">quantum effects</a> start to kick in.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Noise Notation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Noise Notation
</div>
</div>
<div class="callout-body-container callout-body">
<p>We usually leave the <span class="math inline">\(\Delta f\)</span> away for a shorter notation, so we write <span class="math inline">\(\overline{V_\mathrm{n}^2}\)</span> when we actually mean <span class="math inline">\(\overline{V_\mathrm{n}^2}/\Delta f\)</span>. In case of doubt look at the unit of a quantity, whether is shows <span class="math inline">\(\text{V}^2\)</span> or <span class="math inline">\(\text{V}^2/\text{Hz}\)</span> or <span class="math inline">\(\text{V}/\sqrt{\text{Hz}}\)</span> (or <span class="math inline">\(\text{I}^2\)</span> or <span class="math inline">\(\text{I}^2/\text{Hz}\)</span> or <span class="math inline">\(\text{I}/\sqrt{\text{Hz}}\)</span>).</p>
<p>Please also note that the pair of <span class="math inline">\(k T\)</span> pretty much always shows up together, so when you do a calculation and you miss the one or the other, that is often a sign for miscalculation. Boltzmann’s constant <span class="math inline">\(k = 1.38 \cdot 10^{-23}\,\text{J/K}\)</span> is just a scaling factor from thermal energy expressed as a temperature <span class="math inline">\(T\)</span> to energy <span class="math inline">\(E = k T\)</span> expressed in Joule.</p>
<p>Further, when working with PSD there is the usage of a one-sided (<span class="math inline">\(0 \ge f &lt; \infty\)</span>) or two-sided power spectral density (PSD) (<span class="math inline">\(-\infty &lt; f &lt; \infty\)</span>). The default in this lecture is the usage of the <strong>one-sided PSD</strong>.</p>
</div>
</div>
<p>In this lecture the only MOSFET noise we consider is the drain noise (as discussed in <a href="#sec-mosfet-smallsignal-model" class="quarto-xref">Section&nbsp;2.1.2</a>), showing up as a current noise between drain and source. For a for realistic MOSFET noise model, also a (correlated) gate noise component and the thermal noise of the gate resistance needs to be considered.</p>
<p>The factor <span class="math inline">\(\gamma\)</span> (<a href="#eq-mosfet-noise" class="quarto-xref">Equation&nbsp;1</a>) is a function of many things (in classical theory, <span class="math inline">\(\gamma = 2/3\)</span> in saturation and <span class="math inline">\(\gamma = 1\)</span> in triode), and it is characterized in the following plot as a function of <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> and <span class="math inline">\(L\)</span>. So when calculating MOSFET noise we can lookup <span class="math inline">\(\gamma\)</span> in the below plot, and use <a href="#eq-mosfet-noise" class="quarto-xref">Equation&nbsp;1</a> to calculate the effective drain current noise.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-12" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:09.243573Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:09.074949Z&quot;}" data-tags="[&quot;fig-nmos-gamma-vs-gmid-vs-l&quot;]" data-execution_count="12">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-13-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-13-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>In a MOSFET, unfortunately, besides the thermal noise according to <a href="#eq-mosfet-noise" class="quarto-xref">Equation&nbsp;1</a>, there is also a substantial low-frequency excess noise, called “flicker noise” due to its characteristic <span class="math inline">\(\overline{I_\mathrm{d,nf}^2} = K_\mathrm{f}/f\)</span> behavior (this means that this noise PSD decreases versus frequency). In order to characterize this flicker noise the following plot shows the cross-over frequency <span class="math inline">\(f_\mathrm{co}\)</span>, where the flicker noise is as large as the thermal noise. As can be seen in the below plot, this frequency is a strong function of <span class="math inline">\(L\)</span> and <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span>. Generally, the flicker noise is proportional to <span class="math inline">\((W L)^{-1}\)</span>, so the larger the device is, the lower the flicker noise. The parameter <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> largely stays constant when we keep <span class="math inline">\(W/L\)</span> constant, so for a given <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> flicker noise is proportional to <span class="math inline">\(1/L^2\)</span>. However, increasing <span class="math inline">\(L\)</span> lowers device speed dramatically, so here we have a trade-off between flicker-noise performance and MOSFET speed, and this can have dramatic consequences for high-speed circuits.</p>
<div class="callout callout-style-default callout-note callout-titled" title="MOSFET Flicker Noise">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
MOSFET Flicker Noise
</div>
</div>
<div class="callout-body-container callout-body">
<p>The physical origin of flicker noise is the crystal interface between silicon (Si) and the silicon dioxide (SiO<sub>2</sub>). Since these are different materials, there are dangling bonds, which can capture charge carriers traveling in the channel. After a random time, these carriers are released, and flicker noise is the result. The amount of flicker noise is a function of the manufacturing process, and will generally be different between device types and wafer foundries.</p>
</div>
</div>
<p>As you can see in the following plot, <span class="math inline">\(f_\mathrm{co}\)</span> can reach well into the 10’s of MHz for short MOSFETs, significantly degrading the noise performance of a circuit.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-13" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:09.478093Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:09.244904Z&quot;}" data-tags="[&quot;fig-nmos-fco-vs-gmid-vs-l&quot;]" data-execution_count="13">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_nmos-cell-14-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="sec-techsweep-pmos" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="sec-techsweep-pmos"><span class="header-section-number">3.3</span> PMOS Characterization in Saturation</h2>
<p>In the following, we have the same plots as discussed in <a href="#sec-techsweep-nmos" class="quarto-xref">Section&nbsp;3.2</a>, but now for the PMOS.</p>
<div class="callout callout-style-default callout-note callout-titled" title="PMOS Sign Convention">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
PMOS Sign Convention
</div>
</div>
<div class="callout-body-container callout-body">
<p>In all PMOS plots we plot positive values for voltages and currents, to have compatible plots to the NMOS. Of course, in a PMOS, voltages and currents have different polarity compared to the NMOS.</p>
</div>
</div>
<p><span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> and <span class="math inline">\(f_\mathrm{T}\)</span> versus the gate-source voltage <span class="math inline">\(V_\mathrm{GS}\)</span>:</p>
<div class="quarto-embed-nb-cell">
<div id="cell-5" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:08.151250Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:07.778457Z&quot;}" data-tags="[&quot;fig-pmos-gmid-ft-vs-vgs&quot;]" data-execution_count="5">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-6-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-6-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p><span class="math inline">\(f_\mathrm{T}\)</span> against <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> for several different <span class="math inline">\(L\)</span>. One can see significantly lower top speed for the PMOS compared to the NMOS, which means for high-speed circuits the NMOS should be used.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-8" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:08.636920Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:08.496476Z&quot;}" data-tags="[&quot;fig-pmos-ft-vs-gmid-vs-l&quot;]" data-execution_count="8">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-9-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-9-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p><span class="math inline">\(g_\mathrm{m}/ g_\mathrm{ds}\)</span> versus <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span>. Unfortunately, one can see a modelling error for the PMOS in this plot. The self gain <span class="math inline">\(g_\mathrm{m}/ g_\mathrm{ds}\)</span> reaches non-physical values, which indicates an issue with the <span class="math inline">\(g_\mathrm{ds}\)</span> modelling for the PMOS. We can not use these values for our circuit sizing, so we will use the respective NMOS plots also for the PMOS.</p>
<div class="callout callout-style-default callout-important callout-titled" title="Beware of Modelling Issues">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Beware of Modelling Issues
</div>
</div>
<div class="callout-body-container callout-body">
<p>This example shows how important it is to benchmark the device models when starting to use a new technology. Modelling artifacts like the one shown are quite often happening, as setting up the device compact models and parametrize them according to measurement data is a very complex task. In any case, just be aware that modelling issues could exist in whatever PDK you are going to use!</p>
</div>
</div>
<div class="quarto-embed-nb-cell">
<div id="cell-9" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:08.758497Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:08.637839Z&quot;}" data-tags="[&quot;fig-pmos-gmgds-vs-gmid-vs-l&quot;]" data-execution_count="9">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-10-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-10-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>Drain current density <span class="math inline">\(I_\mathrm{D}/W\)</span> as a function of <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> and <span class="math inline">\(L\)</span>:</p>
<div class="quarto-embed-nb-cell">
<div id="cell-10" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:08.963903Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:08.759239Z&quot;}" data-tags="[&quot;fig-pmos-jd-vs-gmid-vs-l&quot;]" data-execution_count="10">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-11-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-11-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>Minimum drain-source voltage <span class="math inline">\(V_\mathrm{ds,sat}\)</span> versus <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> and <span class="math inline">\(L\)</span>:</p>
<div class="quarto-embed-nb-cell">
<div id="cell-11" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:09.074153Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:08.964633Z&quot;}" data-tags="[&quot;fig-pmos-vdsat-vs-gmid-vs-l&quot;]" data-execution_count="11">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-12-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-22"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-12-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>Noise factor <span class="math inline">\(\gamma\)</span> versus <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> and <span class="math inline">\(L\)</span>:</p>
<div class="quarto-embed-nb-cell">
<div id="cell-12" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:09.243573Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:09.074949Z&quot;}" data-tags="[&quot;fig-pmos-gamma-vs-gmid-vs-l&quot;]" data-execution_count="12">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-13-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-23"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-13-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>Flicker noise corner frequency <span class="math inline">\(f_\mathrm{co}\)</span> versus <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> and <span class="math inline">\(L\)</span>. If you compare this figure carefully with the NMOS figure you can see that for some operating points the flicker noise for the PMOS is lower than for the NMOS. This is often true for CMOS technologies, so it can be an advantage to use a PMOS transistor in places where flicker noise is critical, like an OTA input stage. Using PMOS has the further advantage that the bulk node can be tied to source (which for NMOS is only possible in a triple-well technology, which is often not available), which gets rid of the <a href="https://en.wikipedia.org/wiki/Threshold_voltage">body effect</a>.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-13" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-08-02T08:03:09.478093Z&quot;,&quot;start_time&quot;:&quot;2024-08-02T08:03:09.244904Z&quot;}" data-tags="[&quot;fig-pmos-fco-vs-gmid-vs-l&quot;]" data-execution_count="13">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-24"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_pmos-cell-14-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="nmos-and-pmos-characterization-in-triode" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="nmos-and-pmos-characterization-in-triode"><span class="header-section-number">3.4</span> NMOS and PMOS Characterization in Triode</h2>
<p>Besides using the MOSFET as a transconductor in saturation we often use the MOSFET as a switch in triode mode (to either switch voltages or currents). In this triode/switch mode of operation we are mainly interested in two parameters:</p>
<ul>
<li>The resistance of the switch/MOSFET when it is turned on (<span class="math inline">\(R_\mathrm{on} = 1 / g_\mathrm{ds}\)</span>).</li>
<li>The shunt capacitance of the switch when it is turned off (<span class="math inline">\(C_\mathrm{off}\)</span> is defined by the coupling capacitances between drain and source).</li>
</ul>
<p>In the operation of the NMOS as a switch the gate is usually pulled to <span class="math inline">\(V_\mathrm{DD}\)</span> and the bulk is permanently connected to <span class="math inline">\(V_\mathrm{SS}\)</span> to achieve the lowest <span class="math inline">\(R_\mathrm{on}\)</span> (to turn the switch off the gate is pulled towards <span class="math inline">\(V_\mathrm{SS}\)</span>). Likewise, to turn on a PMOS, the gate is usually pulled to <span class="math inline">\(V_\mathrm{SS}\)</span> and the bulk is connected to <span class="math inline">\(V_\mathrm{DD}\)</span>. In this situation the drain/source potential is somewhere between <span class="math inline">\(V_\mathrm{DD}\)</span> and <span class="math inline">\(V_\mathrm{SS}\)</span>, so the MOSFET will experience a <span class="math inline">\(V_\mathrm{SB}\neq 0\)</span>, leading to a quite noticeable bulk effect. Once the drain/source potential is sufficiently high for NMOS (low PMOS) the switch resistance will drastically degrade.</p>
<p>In order to get a feeling for the behavior of the MOSFET as a switch the following characterization plots show <span class="math inline">\(R_\mathrm{on}\)</span> and <span class="math inline">\(C_\mathrm{off}\)</span> for the NMOS and the PMOS, respectively. Both plots are for <span class="math inline">\(L = L_\mathrm{min} = 0.13\mu m\)</span>, as for switches usually minimum length devices are used. Only for special applications (e.g., the leakage current in off-mode is a concern) MOSFETs with increased <span class="math inline">\(L\)</span> are used.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-3" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-11-19T16:09:53.483405Z&quot;,&quot;start_time&quot;:&quot;2024-11-19T16:09:53.204584Z&quot;}" data-tags="[&quot;fig-triode-ron-vs-vsource-1&quot;]" data-execution_count="3">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_triode-cell-4-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-25"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_triode-cell-4-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>As can be seen in the previous plot, an NMOS can be used to switch at potentials close to <span class="math inline">\(V_\mathrm{SS}\)</span>, while a PMOS can be used to switch at potentials close to <span class="math inline">\(V_\mathrm{DD}\)</span>. To construct a switch which can work for all voltage levels between <span class="math inline">\(V_\mathrm{DD}\)</span> and <span class="math inline">\(V_\mathrm{SS}\)</span> an NMOS is put in parallel to a PMOS, resulting in the well-known <strong>transmission gate</strong>.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-6" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-11-19T16:09:53.680720Z&quot;,&quot;start_time&quot;:&quot;2024-11-19T16:09:53.597301Z&quot;}" data-tags="[&quot;fig-triode-coff-vs-vsource&quot;]" data-execution_count="6">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/.-sizing-techsweep_sg13_plots_triode-cell-7-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-26"><img src="index_files/figure-html/.-sizing-techsweep_sg13_plots_triode-cell-7-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<p>As the switch on-resistance gets lower when increasing <span class="math inline">\(W\)</span>, the off-capacitance gets larger. Thus, a good performance indicator for comparing switches in a given technology is the <span class="math inline">\(R_\mathrm{on} C_\mathrm{off}\)</span> product.</p>
</section>
</section>
<section id="sec-mosfet-diode" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> First Circuit: MOSFET Diode</h1>
<p>The first (simple) circuit we will investigate is a MOSFET, where the gate is shorted with a drain, a so-called MOSFET “diode”, which is shown in <a href="#fig-mosfet-diode" class="quarto-xref">Figure&nbsp;11</a>. This diode is one half of a current mirror, which we will investigate in a future section.</p>
<div id="cell-fig-mosfet-diode" class="cell" data-execution_count="8">
<div class="cell-output cell-output-display">
<div id="fig-mosfet-diode" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-diode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-mosfet-diode-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-27" title="Figure&nbsp;11: A MOSFET connected as a diode."><img src="index_files/figure-html/fig-mosfet-diode-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-diode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: A MOSFET connected as a diode.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Why looking at a single-transistor circuit at all? By starting with the simplest possible circuit we can develop important skills in circuit analysis (setting up and calculating a small-signal model, calculating open-loop gain, calculate noise) and Xschem/ngspice simulation testbench creation. We safely assume that also the Mona Lisa was not Leonardo da Vinci’s first painting, so let’s start slow.</p>
<p>This diode is usually biased by a current source, shown as <span class="math inline">\(I_\mathrm{bias}\)</span> in the figure. Depending on MOSFET sizing with <span class="math inline">\(W\)</span> and <span class="math inline">\(L\)</span>, a certain gate-source voltage <span class="math inline">\(V_\mathrm{GS}\)</span> will develop. This voltage can be used as a biasing voltage for other circuit parts, for example.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Feedback in the MOSFET Diode">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Feedback in the MOSFET Diode
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is important to realize that this configuration essentially employs a feedback loop for operation. The voltage at the drain of the MOSFET is sensed by the gate, and the gate voltage changes until the <span class="math inline">\(I_\mathrm{D}\)</span> is exactly equal to <span class="math inline">\(I_\mathrm{bias}\)</span>. In this sense this is probably the smallest feedback circuit one can build.</p>
</div>
</div>
<section id="mosfet-diode-sizing" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="mosfet-diode-sizing"><span class="header-section-number">4.1</span> MOSFET Diode Sizing</h2>
<p>We will now build this circuit in Xschem. For sizing the MOSFET we will use the <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> methodology introduced in <a href="#sec-gmid-method" class="quarto-xref">Section&nbsp;3</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: MOSFET Diode Sizing">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: MOSFET Diode Sizing
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please build a MOSFET diode circuit in Xschem where you use an LV NMOS, set <span class="math inline">\(I_\mathrm{bias} = 20\,\mu\text{A}\)</span>, <span class="math inline">\(L = 0.13\,\mu\text{m}\)</span>, and we want to use <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}= 10\)</span> (often a suitable compromise between transistor speed and <span class="math inline">\(g_\mathrm{m}\)</span> efficiency).</p>
<ol type="1">
<li>Use the figures in <a href="#sec-techsweep-nmos" class="quarto-xref">Section&nbsp;3.2</a> to find out the proper value for <span class="math inline">\(W\)</span>.</li>
<li>What is <span class="math inline">\(f_\mathrm{T}\)</span> for this MOSFET? What is the value for <span class="math inline">\(g_\mathrm{m}\)</span> and <span class="math inline">\(g_\mathrm{ds}\)</span>?</li>
<li>Draw the circuit in Xschem, and simulate the operating point. Do the values match to the values found out before during circuit sizing?</li>
</ol>
</div>
</div>
<p>Before continuing, please finish the previous exercise. Once you are done, compare with the below provided solution.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Solution: MOSFET Diode Sizing">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-25-contents" aria-controls="callout-25" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution: MOSFET Diode Sizing
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-25" class="callout-25-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li>Using the fact that <span class="math inline">\(I_\mathrm{bias} = I_\mathrm{D} = 20\,\mu\text{A}\)</span> and <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}= 10\)</span> directly provides <span class="math inline">\(g_\mathrm{m}= 0.2\,\text{mS}\)</span>.</li>
<li>Using the self-gain plot, we see that <span class="math inline">\(g_\mathrm{m}/g_\mathrm{ds}\approx 21\)</span>, so <span class="math inline">\(g_\mathrm{ds}\approx 9.5\,\mu\text{S}\)</span>. The <span class="math inline">\(f_\mathrm{T}\)</span> can easily be found in the respective plot to be <span class="math inline">\(f_\mathrm{T} = 23\,\text{GHz}\)</span>.</li>
<li>The <span class="math inline">\(W\)</span> of the MOSFET we find using the drain current density plot and the given bias current. Rounding to half-microns results in <span class="math inline">\(W = 1\,\mu\text{m}\)</span>.</li>
<li>Since we are looking at the graphs, we further find <span class="math inline">\(\gamma = 0.84\)</span>, <span class="math inline">\(V_\mathrm{ds,sat} = 0.18\,\text{V}\)</span>, and <span class="math inline">\(f_\mathrm{co} \approx 15\,\text{MHz}\)</span>.</li>
<li>In addition, we expect <span class="math inline">\(V_\mathrm{GS}\approx 0.6\,\text{V}\)</span>.</li>
</ol>
<p>An example Jupyter notebook to extract these values accurately you can find <a href="./sizing/sizing_mosfet_diode-preview.html">here</a>. An Xschem schematic for this exercise is provide <a href="./xschem/mosfet_diode_sizing.sch">as well</a>.</p>
</div>
</div>
</div>
</section>
<section id="mosfet-diode-large-signal-behavior" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="mosfet-diode-large-signal-behavior"><span class="header-section-number">4.2</span> MOSFET Diode Large-Signal Behavior</h2>
<p>As discussed above, the MOSFET diode configuration is essentially a feedback loop. Before we will analyze this loop in small-signal, we want to investigate how this loop settles in the time domain, and by doing this we can observe the large-signal settling behavior. To simulate this, we change the dc bias source from the previous example to a transient current source, which we will turn on after some ns. The resulting Xschem testbench is shown in <a href="#fig-mosfet-diode-settling-tb" class="quarto-xref">Figure&nbsp;12</a>.</p>
<div id="fig-mosfet-diode-settling-tb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-diode-settling-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/mosfet_diode_settling.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-28" title="Figure&nbsp;12: Testbench for MOSFET diode transient settling."><img src="./xschem/mosfet_diode_settling.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-diode-settling-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Testbench for MOSFET diode transient settling.
</figcaption>
</figure>
</div>
<p>In <a href="#fig-mosfet-diode-settling-tb" class="quarto-xref">Figure&nbsp;12</a> another interesting effect can be observed: While the turn-on happens quite rapidly (essentially the bias current source charges the gate capacitance, until the gate-source voltage is large enough that the drain current counteracts the bias current), the turn-off shows a very long settling tail. This is due to the fact that as the gate capacitance is discharged by the drain current the <span class="math inline">\(V_\mathrm{GS}\)</span> drops, which in turn reduces the drain current, which will make the discharge even slower. We have an effect similar to the capacitor discharge by a diode <span class="citation" data-cites="Hellen_2003">(<a href="#ref-Hellen_2003" role="doc-biblioref">Hellen 2003</a>)</span>.</p>
<p>It is thus generally a good idea to add power-down switches to the circuits to disable the circuit quickly by pulling floating nodes to a defined potential (usually <span class="math inline">\(V_\mathrm{DD}\)</span> or <span class="math inline">\(V_\mathrm{SS}\)</span>) and to avoid long intermediate states during power down. This will also allow a turn-on from a well-defined off-state.</p>
</section>
<section id="mosfet-diode-small-signal-analysis" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="mosfet-diode-small-signal-analysis"><span class="header-section-number">4.3</span> MOSFET Diode Small-Signal Analysis</h2>
<p>We now want to investigate the small-signal behavior of the MOSFET diode. Based on the small-signal model of the MOSFET in <a href="#fig-mosfet-small-signal-model" class="quarto-xref">Figure&nbsp;5</a> we realize that gate and drain are shorted, and we also connect bulk to source. We can thus simplify the circuit to the one shown in <a href="#fig-mosfet-diode-small-signal" class="quarto-xref">Figure&nbsp;13</a>.</p>
<div id="cell-fig-mosfet-diode-small-signal" class="cell" data-execution_count="9">
<div class="cell-output cell-output-display">
<div id="fig-mosfet-diode-small-signal" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-diode-small-signal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-mosfet-diode-small-signal-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-29" title="Figure&nbsp;13: The MOSFET diode small-signal model."><img src="index_files/figure-html/fig-mosfet-diode-small-signal-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-diode-small-signal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: The MOSFET diode small-signal model.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Ground Node Selection">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ground Node Selection
</div>
</div>
<div class="callout-body-container callout-body">
<p>For small-signal analysis we would not need to declare one node as the ground potential. However, when doing so, and selecting the ground node strategically, we can simplify the analysis, as we usually do not formulate KCL for the ground node (as we have only <span class="math inline">\(N-1\)</span> independent KCL equations, <span class="math inline">\(N\)</span> being the number of nodes in the circuit), and the potential difference equations are simpler if one node is at <span class="math inline">\(0\,V\)</span>.</p>
</div>
</div>
<p>For calculating the small-signal impedance of the MOSFET diode we formulate KCL at the top node to get <span class="math display">\[
i_\mathrm{bias} - s C_\mathrm{gs}v_\mathrm{gs}- g_\mathrm{m}v_\mathrm{gs}- g_\mathrm{ds}v_\mathrm{gs}= 0.
\]</span></p>
<p>It follows that <span id="eq-mosfet-diode-impedance"><span class="math display">\[
Z_\mathrm{diode}(s) = \frac{v_\mathrm{gs}}{i_\mathrm{bias}} = \frac{1}{g_\mathrm{m}+ g_\mathrm{ds}+ s C_\mathrm{gs}}.
\tag{5}\]</span></span></p>
<p>When neglecting <span class="math inline">\(g_\mathrm{ds}\)</span> and at dc we get <span class="math inline">\(Z_\mathrm{diode} = 1 / g_\mathrm{m}\)</span>, which is an important result and should be memorized.</p>
<div class="callout callout-style-default callout-important callout-titled" title="The Admittance is Your Friend">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Admittance is Your Friend
</div>
</div>
<div class="callout-body-container callout-body">
<p>In circuit analysis it is often algebraically easier to work with admittance instead of impedance, so please remember that Ohm’s law for a conductance is <span class="math inline">\(I = G \cdot V\)</span>, and for a capacitance is <span class="math inline">\(I = s C \cdot V\)</span>. When writing equations, it is also practical to keep <span class="math inline">\(s C\)</span> together, so we will strive to sort terms accordingly.</p>
</div>
</div>
<p>Looking at <a href="#eq-mosfet-diode-impedance" class="quarto-xref">Equation&nbsp;5</a> we see that for low frequencies, the diode impedance is resistive, and for high frequencies it becomes capacitive as the gate-source capacitance starts to dominate. The corner frequency of this low-pass can be calculated as <span class="math display">\[
\omega_\mathrm{c} = \frac{g_\mathrm{m}+ g_\mathrm{ds}}{C_\mathrm{gs}} \approx \omega_\mathrm{T}
\]</span> which is pretty much the transit frequency of the MOSFET!</p>
</section>
<section id="mosfet-diode-stability-analysis" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="mosfet-diode-stability-analysis"><span class="header-section-number">4.4</span> MOSFET Diode Stability Analysis</h2>
<p>The diode-connected MOSFET forms a feedback loop. What is the open-loop gain? For calculating it, we are breaking the loop, and apply a dummy <span class="math inline">\(C_\mathrm{gs}^{*}\)</span> at the right side to keep the impedances correct. A circuit diagram is shown in <a href="#fig-mosfet-diode-openloop" class="quarto-xref">Figure&nbsp;14</a>, we break the loop at the dotted connection. As we can see in this example, it is critically important when breaking up a loop for analysis (also for simulation!) to keep the terminal impedances the same. Only in special cases where the load impedance is very high or the driving impedance is very low is it acceptable to disregard loading effects!</p>
<div id="cell-fig-mosfet-diode-openloop" class="cell" data-execution_count="10">
<div class="cell-output cell-output-display">
<div id="fig-mosfet-diode-openloop" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-diode-openloop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-mosfet-diode-openloop-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-30" title="Figure&nbsp;14: The MOSFET diode small-signal circuit for open-loop analysis."><img src="index_files/figure-html/fig-mosfet-diode-openloop-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-diode-openloop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14: The MOSFET diode small-signal circuit for open-loop analysis.
</figcaption>
</figure>
</div>
</div>
</div>
<p>By inspecting <a href="#fig-mosfet-diode-openloop" class="quarto-xref">Figure&nbsp;14</a> we see that <span class="math display">\[
v_\mathrm{out} = - g_\mathrm{m}v_\mathrm{in} \frac{1}{g_\mathrm{ds}+ s C_\mathrm{gs}}.
\]</span></p>
<p>The open-loop gain <span class="math inline">\(H_\mathrm{ol}(s)\)</span> is thus <span id="eq-mosfet-diode-openloop-gain"><span class="math display">\[
H_\mathrm{ol}(s) = \frac{v_\mathrm{out}}{v_\mathrm{in}} = -\frac{g_\mathrm{m}}{g_\mathrm{ds}+ s C_\mathrm{gs}}.
\tag{6}\]</span></span></p>
<p>Inspecting <a href="#eq-mosfet-diode-openloop-gain" class="quarto-xref">Equation&nbsp;6</a> we realize that</p>
<ol type="1">
<li>the dc gain <span class="math inline">\(g_\mathrm{m}/ g_\mathrm{ds}\)</span> is the self-gain of the MOSFET, so <span class="math inline">\(20 \log(0.2 \cdot 10^{-3} / 9.6 \cdot 10 ^{-6}) = 26.4\,\text{dB}\)</span>, and</li>
<li>there is a pole at <span class="math inline">\(\omega_\mathrm{p} = -g_\mathrm{ds}/ C_\mathrm{gs}\)</span>, which is at <span class="math inline">\(9.6 \cdot 10 ^{-6} / (2 \pi \cdot 1.4 \cdot 10^{-15}) = 1.1\,\text{GHz}\)</span>.</li>
</ol>
<p>With this single pole location in <span class="math inline">\(H_\mathrm{ol}(s)\)</span> this loop is perfectly stable at under all conditions.</p>
<p>The question is now how to simulate this open-loop gain, and how to break the loop open in simulation? In general there are various methods, as we can use artificially large (ideal) inductors and capacitors to break loops open and still establish the correct dc operating points for the ac loop analysis. However, mimicking the correct loading can be an issue, and requires a lot of careful consideration.</p>
<p>There is an alternative method which breaks the loop open only by adding an ac voltage source in series (thus keeps the dc operating point intact), or injects current using a current source. Based on both measurements the open-loop gain can be calculated. This is called <strong>Middlebrook’s method</strong> <span class="citation" data-cites="Middlebrook_1975">(<a href="#ref-Middlebrook_1975" role="doc-biblioref">Middlebrook 1975</a>)</span> which is based on double injection, and we will use it for our loop simulations. This method is detailed in <a href="#sec-middlebrook-method" class="quarto-xref">Section&nbsp;15</a>.</p>
<p>We now want to simulate the open-loop transfer function <span class="math inline">\(H_\mathrm{ol}(s)\)</span> by using Middlebrook’s method and confirm our analysis above.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: MOSFET Diode Loop Analysis">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: MOSFET Diode Loop Analysis
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please build a simulation testbench in Xschem to simulate the open-loop transfer function of the MOSFET diode. Confirm the dc gain and pole location as given by <a href="#eq-mosfet-diode-openloop-gain" class="quarto-xref">Equation&nbsp;6</a>.</p>
<p>If you are getting stuck you can look at this Xschem <a href="./xschem/mosfet_diode_loopgain.sch">testbench</a>, shown in <a href="#fig-mosfet-diode-loopgain-tb" class="quarto-xref">Figure&nbsp;15</a>.</p>
<div id="fig-mosfet-diode-loopgain-tb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-diode-loopgain-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/mosfet_diode_loopgain.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-31" title="Figure&nbsp;15: Testbench for MOSFET diode stability analysis."><img src="./xschem/mosfet_diode_loopgain.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-diode-loopgain-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15: Testbench for MOSFET diode stability analysis.
</figcaption>
</figure>
</div>
</div>
</div>
<p>From simulation we see that the open-loop gain is <span class="math inline">\(24.9\,\text{dB}\)</span> at low frequencies, which matches quite well our prediction of <span class="math inline">\(26.4\,\text{dB}\)</span>. In the Bode plot we see a low-pass with a <span class="math inline">\(-3\,\text{dB}\)</span> corner frequency of <span class="math inline">\(1.4\,\text{GHz}\)</span>, which again is fairly close to our prediction of <span class="math inline">\(1.1\,\text{GHz}\)</span>.</p>
</section>
<section id="mosfet-diode-noise-calculation" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="mosfet-diode-noise-calculation"><span class="header-section-number">4.5</span> MOSFET Diode Noise Calculation</h2>
<p>As a final exercise on the MOSFET diode circuit we want to calculate the output noise when we consider <span class="math inline">\(V_\mathrm{GS}\)</span> the output reference voltage which is created when passing a bias current through the MOSFET diode. The bias current we will assume noiseless.</p>
<p>We will use the small-signal circuit shown in <a href="#fig-mosfet-diode-small-signal-w-noise" class="quarto-xref">Figure&nbsp;16</a>.</p>
<div id="cell-fig-mosfet-diode-small-signal-w-noise" class="cell" data-execution_count="11">
<div class="cell-output cell-output-display">
<div id="fig-mosfet-diode-small-signal-w-noise" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-diode-small-signal-w-noise-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-mosfet-diode-small-signal-w-noise-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-32" title="Figure&nbsp;16: The MOSFET diode small-signal model with drain noise source."><img src="index_files/figure-html/fig-mosfet-diode-small-signal-w-noise-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-diode-small-signal-w-noise-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16: The MOSFET diode small-signal model with drain noise source.
</figcaption>
</figure>
</div>
</div>
</div>
<p>As we have already calculated the small-signal diode impedance in <a href="#eq-mosfet-diode-impedance" class="quarto-xref">Equation&nbsp;5</a> we will use this result, and just note that the drain current noise of the MOSFET flows through this impedance. The noise voltage at <span class="math inline">\(v_\mathrm{gs}\)</span> is thus given as <span class="math display">\[
\overline{V_\mathrm{n}^2} = Z_\mathrm{diode}^2 \overline{I_\mathrm{n,d}^2}.
\]</span></p>
<p>The drain current noise of the MOSFET is given as (introduced in <a href="#sec-mosfet-smallsignal-model" class="quarto-xref">Section&nbsp;2.1.2</a>) <span class="math display">\[
\overline{I_\mathrm{n,d}^2} = 4 k T \gamma g_\mathrm{m}.
\]</span></p>
<p>For low frequencies (ignoring <span class="math inline">\(g_\mathrm{ds}\)</span> and <span class="math inline">\(C_\mathrm{gs}\)</span>) we get <span class="math display">\[
\overline{V_\mathrm{n}^2} = Z_\mathrm{diode}^2 \overline{I_\mathrm{n,d}^2} = \frac{1}{g_\mathrm{m}^2} 4 k T \gamma g_\mathrm{m}= \frac{4 k T \gamma}{g_\mathrm{m}}
\]</span> which is the thermal noise of a resistor of value <span class="math inline">\(1 / g_\mathrm{m}\)</span> enhanced by the factor <span class="math inline">\(\gamma\)</span>.</p>
<p>We now calculate the full equation, and after a bit of algebra arrive at <span id="eq-mosfet-diode-noise-psd"><span class="math display">\[
\overline{V_\mathrm{n}^2}(f) = \frac{4 k T \gamma g_\mathrm{m}}{(g_\mathrm{m}+ g_\mathrm{ds})^2 + (2 \pi f C_\mathrm{gs})^2}.
\tag{7}\]</span></span></p>
<p>If we are interested in the PSD of the noise then <a href="#eq-mosfet-diode-noise-psd" class="quarto-xref">Equation&nbsp;7</a> gives us the result. If we are interested in the rms value (the total noise) we need to integrate this equation, using the following identity:</p>
<div class="callout callout-style-default callout-note callout-titled" title="Useful Integral for Noise Calculations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Useful Integral for Noise Calculations
</div>
</div>
<div class="callout-body-container callout-body">
<p><span id="eq-integral-identity"><span class="math display">\[
\int_0^\infty {\frac{a}{b^2 + c^2 f^2} df} = \frac{\pi}{2} \frac{a}{b \cdot c}
\tag{8}\]</span></span></p>
</div>
</div>
<p>Using the integral help in <a href="#eq-integral-identity" class="quarto-xref">Equation&nbsp;8</a>, we can easily transform <a href="#eq-mosfet-diode-noise-psd" class="quarto-xref">Equation&nbsp;7</a> to <span id="eq-mosfet-diode-noise-rms"><span class="math display">\[
V_\mathrm{n,rms}^2 = \int_0^\infty \overline{V_\mathrm{n}^2}(f) df = \frac{k T \gamma g_\mathrm{m}}{(g_\mathrm{m}+ g_\mathrm{ds}) C_\mathrm{gs}}.
\tag{9}\]</span></span></p>
<p>The form of <a href="#eq-mosfet-diode-noise-rms" class="quarto-xref">Equation&nbsp;9</a> is the exact solution, but we gain additional insight if we assume that <span class="math inline">\(g_\mathrm{m}+ g_\mathrm{ds}\approx g_\mathrm{m}\)</span> and then <span id="eq-mosfet-diode-noise-rms-simplified"><span class="math display">\[
V_\mathrm{n,rms}^2 = \frac{k T \gamma}{C_\mathrm{gs}}.
\tag{10}\]</span></span></p>
<p>Inspecting <a href="#eq-mosfet-diode-noise-rms-simplified" class="quarto-xref">Equation&nbsp;10</a> we see our familiar <span class="math inline">\(kT/C\)</span> noise enhanced by the factor <span class="math inline">\(\gamma\)</span>! Calculating this value for our MOSFET diode we get <span class="math inline">\(\sqrt{V_\mathrm{n,rms}^2} = \sqrt{1.38 \cdot 10^{-23} \cdot 300 \cdot 0.84 / 1.4 \cdot 10^{-15}} = 1.58\,\text{mV}\)</span>, which is a sizeable value! We run circuits in this technology at <span class="math inline">\(V_\mathrm{DD}= 1.5\,\mathrm{V}\)</span>, which leaves us with a signal swing of ca. <span class="math inline">\(1.1\,\mathrm{V_{pp}}\)</span>, resulting in a dynamic range in this case of <span class="math inline">\(20 \log (1.58 \cdot 10^{-3} / 0.39) \approx -48\,\text{dB}\)</span>.</p>
<div class="callout callout-style-default callout-important callout-titled" title="Large Bandwidth and Noise">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Large Bandwidth and Noise
</div>
</div>
<div class="callout-body-container callout-body">
<p>Large BW circuits can integrate noise over a wide bandwidth resulting in considerable rms noise.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: MOSFET Diode Noise">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: MOSFET Diode Noise
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please build a simulation testbench in Xschem to simulate the noise performance of the MOSFET diode, and confirm the rms noise value that we just calculated. Look at the rms value and the PSD of the noise, and play around with the integration limits. What is the effect? Can you see the flicker noise in the PSD? How much is its contribution to the rms noise? What is the value of <span class="math inline">\(f_\mathrm{co}\)</span>, and does it correspond to the above calculated one?</p>
<p>If you are getting stuck you can look at this Xschem <a href="./xschem/mosfet_diode_noise.sch">testbench</a>, shown in <a href="#fig-mosfet-diode-noise-tb" class="quarto-xref">Figure&nbsp;17</a>.</p>
<div id="fig-mosfet-diode-noise-tb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosfet-diode-noise-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/mosfet_diode_noise.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-33" title="Figure&nbsp;17: Testbench for MOSFET diode noise analysis."><img src="./xschem/mosfet_diode_noise.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosfet-diode-noise-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;17: Testbench for MOSFET diode noise analysis.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion-1" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="conclusion-1"><span class="header-section-number">4.6</span> Conclusion</h2>
<p>In this section we investigated the simple MOSFET-diode circuit. We learned important skills like how to derive a small-signal model, how to calculate important features like noise and open-loop gain for stability analysis. We introduced Middlebrook’s method to have a mechanism to open up loops in simulation (and calculation) without disturbing operating points for change loading conditions.</p>
<p>If you feel that you have not yet mastered these topics or are uncertain in the operation of ngspice, please go back to the beginning of the section and read through the theory and redo the exercises.</p>
</section>
</section>
<section id="sec-cs-amplifier" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Common-Source Amplifier</h1>
<p>We now want to design something more useful, and we will use a basic circuit structure, namely a single-ended common-source amplifier. The structure of this circuit, using a resistor as a load, is shown in <a href="#fig-cs-amplifier" class="quarto-xref">Figure&nbsp;18</a>.</p>
<div id="cell-fig-cs-amplifier" class="cell" data-execution_count="12">
<div class="cell-output cell-output-display">
<div id="fig-cs-amplifier" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cs-amplifier-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-cs-amplifier-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-34" title="Figure&nbsp;18: A MOSFET common-source amplifier with resistive load."><img src="index_files/figure-html/fig-cs-amplifier-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cs-amplifier-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18: A MOSFET common-source amplifier with resistive load.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The function of this circuit is as follows: Assuming the MOSFET <span class="math inline">\(M_1\)</span> is kept in saturation, then a small-signal voltage <span class="math inline">\(v_\mathrm{in}\)</span> applied at the gate is converted into a drain current <span class="math inline">\(i_\mathrm{d}\)</span> using the MOSFET’s transconductance <span class="math inline">\(g_\mathrm{m}\)</span>. Then, this current is converted into a voltage again in the resistor <span class="math inline">\(R_1\)</span>. Ultimately, we have a voltage gain <span class="math inline">\(A_\mathrm{v}\)</span> of</p>
<p><span class="math display">\[
A_\mathrm{v} = \frac{v_\mathrm{out}}{v_\mathrm{in}} \approx - \frac{g_\mathrm{m}v_\mathrm{in} R_1}{v_\mathrm{in}} = - g_\mathrm{m}R_1
\]</span></p>
<section id="sense-amplifier-for-50ohm-load" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="sense-amplifier-for-50ohm-load"><span class="header-section-number">5.1</span> Sense Amplifier for 50Ohm Load</h2>
<p>Let us now size and design an exemplary implementation (of course using the <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> method). In order to have useful real-life specifications, we want to build an amplifier which can be used to sense an on-chip voltage and drive external measurement equipment. Often, this equipment has a load impedance of 50<span class="math inline">\(\Omega\)</span>, and we want to have an impedance-matched output. The voltage gain shall be set to 1 (essentially, we want to sense a voltage and drive the measurement equipment).</p>
<p>The resulting circuit is shown in <a href="#fig-meas-amplifier" class="quarto-xref">Figure&nbsp;19</a>. As the load is usually ground-referred, and as we want to avoid an ac-block at the output, we use a PMOS amplifier stage (compare with <a href="#fig-cs-amplifier" class="quarto-xref">Figure&nbsp;18</a>).</p>
<div id="cell-fig-meas-amplifier" class="cell" data-execution_count="13">
<div class="cell-output cell-output-display">
<div id="fig-meas-amplifier" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-meas-amplifier-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-meas-amplifier-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-35" title="Figure&nbsp;19: A MOSFET common-source amplifier with 50 Ohm load."><img src="index_files/figure-html/fig-meas-amplifier-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-meas-amplifier-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19: A MOSFET common-source amplifier with 50 Ohm load.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: PMOS-Based Measurement Amplifier">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: PMOS-Based Measurement Amplifier
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please think about why exactly we want this measurement amplifier be based on a PMOS instead of an NMOS.</p>
</div>
</div>
<p>The <a href="https://en.wikipedia.org/wiki/Impedance_matching">power matching</a> condition at the output mandates that <span class="math inline">\(R_1 = R_\mathrm{load}\)</span>, so <span class="math inline">\(R'_1 = R_\mathrm{load} \parallel R_1 = 25\,\Omega\)</span>. The voltage gain requirement of <span class="math inline">\(|A_\mathrm{v}| = 1\)</span> results in <span class="math inline">\(g_\mathrm{m}= 1 / R'_1 = 40\,\text{mS}\)</span>.</p>
<p>We now need to find <span class="math inline">\(W\)</span> and <span class="math inline">\(L\)</span> of <span class="math inline">\(M_1\)</span> and set the required bias current <span class="math inline">\(I_\mathrm{D}\)</span>. We also need to find out the proper <span class="math inline">\(V_\mathrm{GS}\)</span> to set this current. As usual, we use a Jupyter notebook to calculate these values. Since we require modest speed of this buffer we use a <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}=8\)</span> and set <span class="math inline">\(L = 0.13\,\mu\text{m}\)</span>. The notebook is available <a href="./sizing/sizing_measurement_amplifier-preview.html">here</a>. The resulting circuit including all component values is shown at the end of the notebook (the red input capacitor shows the <span class="math inline">\(C_\mathrm{gg}\)</span> of the MOSFET).</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: Measurement Amplifier Simulation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: Measurement Amplifier Simulation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please go through the <a href="./sizing/sizing_measurement_amplifier-preview.html">sizing notebook</a> of the measurement amplifier and double-check the calculations. Do you agree that the calculations are correct?</p>
<p>Once you agree with the circuit sizing please build an Xschem simulation testbench where you simulate the small-signal voltage of this measurement amplifier if it is driven with an ideal voltage source. Keep in mind that the maximum MOSFET finger width is 10µm in this technology, so you need to set the parameter <code>ng</code> accordingly (the shown <span class="math inline">\(W\)</span> is the total width of the MOSFET, and <span class="math inline">\(W / \text{ng} \le 10\mu\text{m}\)</span> is the width per MOSFET gate finger).</p>
<ul>
<li>What is the dc gain of this amplifier when loaded with 50<span class="math inline">\(\Omega\)</span>?</li>
<li>The dc gain is likely not 0dB. Why is this so?</li>
<li>Increase the width <span class="math inline">\(W\)</span> of the PMOS until the gain is correct. What is the <span class="math inline">\(W\)</span> that you had to set, and how much is <span class="math inline">\(I_\mathrm{D}\)</span> now?</li>
<li>What is the bandwidth (i.e., the -3dB corner frequency) of the output, when the voltage source has a source resistance of 1k<span class="math inline">\(\Omega\)</span>?</li>
</ul>
<p>If you get stuck, <a href="./xschem/measurement_amplifier.sch">here</a> is the solution to this exercise, and it is also shown in <a href="#fig-meas-amp-tb" class="quarto-xref">Figure&nbsp;20</a>.</p>
<div id="fig-meas-amp-tb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-meas-amp-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/measurement_amplifier.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-36" title="Figure&nbsp;20: Simulation schematic of the common-source measurement amplifier."><img src="./xschem/measurement_amplifier.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-meas-amp-tb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20: Simulation schematic of the common-source measurement amplifier.
</figcaption>
</figure>
</div>
</div>
</div>
<p>By now we have designed a measurement amplifier based on a common-source stage. One problem with this stage is the relatively large input capacitance of approx. 0.3pF, which loads the input. Another issue even more severe is that the fact that the bias point in the circuit is set by the dc voltage level at the input. In general, we want a setup where the bias points of the circuit are largely independent of the dc input voltages. This is why in integrated circuit design we often design differential circuits where the input and output signals are given by the differential voltages, and are largely independent from the common-mode voltages. This is usually an advantage.</p>
</section>
</section>
<section id="sec-current-mirror" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Current Mirror</h1>
<p>In this section we will look into a fundamental building block which is often used in integrated circuit design, the <strong>current mirror</strong>. A diagram is shown in <a href="#fig-current-mirror" class="quarto-xref">Figure&nbsp;21</a> with one MOSFET diode converting the incoming bias current into a voltage, and two output MOSFETs working as current sources, which are biased from the diode. By properly selecting all <span class="math inline">\(W\)</span> and <span class="math inline">\(L\)</span> the input current can be scaled, and multiple copies can be created at once. Shown in the figure are two output currents, but any number of parallel branches can be realized.</p>
<div id="cell-fig-current-mirror" class="cell" data-execution_count="14">
<div class="cell-output cell-output-display">
<div id="fig-current-mirror" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-current-mirror-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-current-mirror-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-37" title="Figure&nbsp;21: A current mirror with two output branches."><img src="index_files/figure-html/fig-current-mirror-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-current-mirror-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21: A current mirror with two output branches.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The output current <span class="math inline">\(I_\mathrm{out1}\)</span> is then given by <span class="math display">\[
I_\mathrm{out1} = I_\mathrm{bias} \frac{W_2}{L_2} \frac{L_1}{W_1}
\]</span> and the output current <span class="math inline">\(I_\mathrm{out2}\)</span> is given by <span class="math display">\[
I_\mathrm{out2} = I_\mathrm{bias} \frac{W_3}{L_3} \frac{L_1}{W_1}.
\]</span></p>
<p>For good matching in layout care has to be taken that the MOSFET widths and lengths are constructed out of <strong>unit elements</strong> of identical size, where an appropriate amount of these single units are then arranged in series or parallel configuration to arrive at the target <span class="math inline">\(W\)</span> and <span class="math inline">\(L\)</span>.</p>
<p>As we know from earlier investigations of the MOSFET performance in <a href="#sec-gmid-method" class="quarto-xref">Section&nbsp;3</a> the drain current of a MOSFET is a function of <span class="math inline">\(V_\mathrm{GS}\)</span> and <span class="math inline">\(V_\mathrm{DS}\)</span>. As long as the MOSFET stays in saturation (i.e., <span class="math inline">\(V_\mathrm{DS}&gt; V_\mathrm{ds,dsat}\)</span>) the drain current is just a mild function of <span class="math inline">\(V_\mathrm{DS}\)</span> (essentially the effect of <span class="math inline">\(g_\mathrm{ds}\)</span>, which is the output conductance of the MOSFET). A fundamental flaw of the basic current mirror shown in <a href="#fig-current-mirror" class="quarto-xref">Figure&nbsp;21</a> is the mismatch of the <span class="math inline">\(V_\mathrm{DS}\)</span> of the MOSFET. The input-side diode has <span class="math inline">\(V_\mathrm{GS}= V_\mathrm{DS}\)</span>, whereas the output current sources have a <span class="math inline">\(V_\mathrm{DS}\)</span> depending on the connected circuitry. Improved current mirrors exist (basically fixing this flaw), still, when just a simple current mirror is required this structure is used for its simplicity.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: Current Mirror">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: Current Mirror
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please construct a current mirror based on the MOSFET-diode which we sized in <a href="#sec-mosfet-diode" class="quarto-xref">Section&nbsp;4</a>. The input current <span class="math inline">\(I_\mathrm{bias} = 20\,\mu\text{A}\)</span>, and we want three output currents of size <span class="math inline">\(10\,\mu\text{A}\)</span>, <span class="math inline">\(20\,\mu\text{A}\)</span>, and <span class="math inline">\(40\,\mu\text{A}\)</span>.</p>
<p>Sweep the output voltage of all three current branches and see over which voltage range an acceptable current is created. For which output voltage range is the current departing from its ideal value, and why?</p>
<p>You see that the slope of the output current is quite bad, as <span class="math inline">\(g_\mathrm{ds}\)</span> is too large. We can improve this by changing the length to <span class="math inline">\(L = 5\,\mu\text{m}\)</span> (for motivation, please look at the graphs in <a href="#sec-gmid-method" class="quarto-xref">Section&nbsp;3</a>). In addition, for a current mirror we are not interested in a high <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> value, so we can use <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}= 5\)</span> in this case. Please size the current mirror MOSFETs accordingly (please round the <span class="math inline">\(W\)</span> to half micron, to keep sizes a bit more practical). Compare this result to the previous one, what changed?</p>
<p>In case you get stuck, here are Xschem schematics for the <a href="./xschem/current_mirror.sch">original</a> and the <a href="./xschem/current_mirror_improved.sch">improved</a> current mirrors.</p>
</div>
</div>
</section>
<section id="sec-diff-pair" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Differential Pair</h1>
<p>Like the current mirror in <a href="#sec-current-mirror" class="quarto-xref">Section&nbsp;6</a> the <strong>differential pair</strong> is an ubiquitous building block often used in integrated circuit design. The fundamental structure is given in <a href="#fig-differential-pair" class="quarto-xref">Figure&nbsp;22</a>.</p>
<div id="cell-fig-differential-pair" class="cell" data-execution_count="15">
<div class="cell-output cell-output-display">
<div id="fig-differential-pair" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-differential-pair-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-differential-pair-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-38" title="Figure&nbsp;22: A differential pair."><img src="index_files/figure-html/fig-differential-pair-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-differential-pair-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22: A differential pair.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In order to understand its operation it is instructive to separate the input condition into (1) a purely differential voltage, and (2) into a common-mode voltage, and see what the impact on the output currents is.</p>
<section id="differential-operation-of-the-diffpair" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="differential-operation-of-the-diffpair"><span class="header-section-number">7.1</span> Differential Operation of the Diffpair</h2>
<p>For a differential mode of operation we assume that the input common mode voltage is constant, i.e.&nbsp;<span class="math inline">\(V_\mathrm{in,p} + V_\mathrm{in,n} = V_\mathrm{CM}\)</span>. A differential input voltage <span class="math inline">\(v_\mathrm{in}\)</span> then results in <span class="math display">\[
V_\mathrm{in,p} = V_\mathrm{CM} + \frac{v_\mathrm{in}}{2}
\]</span> and <span class="math display">\[
V_\mathrm{in,n} = V_\mathrm{CM} - \frac{v_\mathrm{in}}{2}.
\]</span></p>
<p>For a small-signal differential drive the potential at the tail point stays constant and we can treat it as a virtual ground. The output current on each side is then given by (neglecting <span class="math inline">\(g_\mathrm{ds}\)</span> and <span class="math inline">\(g_\mathrm{mb}\)</span> of <span class="math inline">\(M_1\)</span> and <span class="math inline">\(M_2\)</span>) <span class="math display">\[
i_\mathrm{out,p} = g_\mathrm{m1} \left( \frac{v_\mathrm{in}}{2} \right)
\]</span> and <span class="math display">\[
i_\mathrm{out,n} = g_\mathrm{m2} \left( -\frac{v_\mathrm{in}}{2} \right).
\]</span></p>
<p>Usually we assume symmetry in the differential pair, so <span class="math inline">\(g_\mathrm{m1} = g_\mathrm{m2} = g_\mathrm{m}\)</span>. The differential output current <span class="math inline">\(i_\mathrm{out}\)</span> is then given by <span id="eq-differential-pair-dm"><span class="math display">\[
i_\mathrm{out} = i_\mathrm{out,p} - i_\mathrm{out,n} = g_\mathrm{m}v_\mathrm{in}
\tag{11}\]</span></span></p>
<p>We see in <a href="#eq-differential-pair-dm" class="quarto-xref">Equation&nbsp;11</a> that the differential output current is simply the differential input voltage multiplied by the <span class="math inline">\(g_\mathrm{m}\)</span> of the individual transistor. We also note that the bottom conductance <span class="math inline">\(g_\mathrm{tail}\)</span> plays no role for the small-signal differential operation.</p>
</section>
<section id="common-mode-operation-of-the-diffpair" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="common-mode-operation-of-the-diffpair"><span class="header-section-number">7.2</span> Common-Mode Operation of the Diffpair</h2>
<p>Usually, the source conductance <span class="math inline">\(g_\mathrm{tail}\)</span> is realized by a current source and ideally should be <span class="math inline">\(g_\mathrm{tail} = 0\)</span>. If this is the case, then the output currents are not a function of the common-mode input voltage, and (<span class="math inline">\(I_\mathrm{tail}\)</span> is set by the tail current source) <span class="math display">\[
I_\mathrm{out,p} = I_\mathrm{out,n} = \frac{I_\mathrm{tail}}{2}.
\]</span></p>
<p>However, if we assume a realistic tail current source then <span class="math inline">\(g_\mathrm{tail} &gt; 0\)</span>. For analysis we can simply look at a half circuit since everything is symmetric. In order to simplify the analysis a bit we remove all capacitors from the MOSFET small-signal model and set <span class="math inline">\(g_\mathrm{ds}= g_\mathrm{mb}= 0\)</span>. We arrive then at the small-signal equivalent circuit shown in <a href="#fig-differential-pair-cm" class="quarto-xref">Figure&nbsp;23</a> (note that we set <span class="math inline">\(v_\mathrm{in,p} = v_\mathrm{in,n} = v_\mathrm{in}\)</span> and <span class="math inline">\(i_\mathrm{out,p} = i_\mathrm{out,n} = i_\mathrm{out}\)</span> under symmetry considerations).</p>
<div id="cell-fig-differential-pair-cm" class="cell" data-execution_count="16">
<div class="cell-output cell-output-display">
<div id="fig-differential-pair-cm" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-differential-pair-cm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-differential-pair-cm-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-39" title="Figure&nbsp;23: Small-signal model of the differential pair half-circuit in common-mode operation."><img src="index_files/figure-html/fig-differential-pair-cm-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-differential-pair-cm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;23: Small-signal model of the differential pair half-circuit in common-mode operation.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Formulating KVL for the input-side loop we get <span class="math display">\[
v_\mathrm{in} = v_\mathrm{gs}+ \frac{i_\mathrm{d}}{g_\mathrm{tail}}.
\]</span></p>
<p>With <span class="math inline">\(i_\mathrm{out} = i_\mathrm{d}= g_\mathrm{m}v_\mathrm{gs}\)</span> we arrive at <span id="eq-differential-pair-cm"><span class="math display">\[
i_\mathrm{out} = \frac{g_\mathrm{m}g_\mathrm{tail}}{g_\mathrm{m}+ g_\mathrm{tail}} v_\mathrm{in}
\tag{12}\]</span></span></p>
<p>Interpreting <a href="#eq-differential-pair-cm" class="quarto-xref">Equation&nbsp;12</a> we can distinguish the following extreme cases:</p>
<ol type="1">
<li>If <span class="math inline">\(g_\mathrm{tail} = 0\)</span> (ideal tail current source) then <span class="math inline">\(i_\mathrm{out} = 0\)</span>, the common-mode voltage variation from the input is suppressed and does not show up at the common-mode output current (which is constant due to the ideal tail current source). This is usually the case that we want to achieve.</li>
<li>If <span class="math inline">\(g_\mathrm{tail} = \infty\)</span> then <span class="math inline">\(i_\mathrm{out} = g_\mathrm{m}v_\mathrm{in}\)</span>, which means the output current is a function of the MOSFET <span class="math inline">\(g_\mathrm{m}\)</span>. If everything is perfectly matched, then the differential output current is zero, but the common-mode output current changes according to the common-mode input voltage. In special cases this can be a wanted behavior, this configuration is called a “pseudo-differential pair.”</li>
</ol>
</section>
</section>
<section id="sec-basic-ota" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> A Basic 5-Transistor OTA</h1>
<p>Suited with the knowledge of basic transistor operation (<a href="#sec-first-steps" class="quarto-xref">Section&nbsp;2</a> and <a href="#sec-gmid-method" class="quarto-xref">Section&nbsp;3</a>) and the working knowledge of the current mirror (<a href="#sec-mosfet-diode" class="quarto-xref">Section&nbsp;4</a> and <a href="#sec-current-mirror" class="quarto-xref">Section&nbsp;6</a>) as well as the differential pair (<a href="#sec-diff-pair" class="quarto-xref">Section&nbsp;7</a>) we can now start to design our first real circuit. A fundamental (simple) circuit that is often used for basic tasks is the 5-transistor operational transconductance amplifier (OTA). A circuit diagram of this 5T-OTA is shown in <a href="#fig-basic-ota" class="quarto-xref">Figure&nbsp;24</a>.</p>
<div id="cell-fig-basic-ota" class="cell" data-execution_count="17">
<div class="cell-output cell-output-display">
<div id="fig-basic-ota" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-basic-ota-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-basic-ota-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-40" title="Figure&nbsp;24: The 5-transistor OTA."><img src="index_files/figure-html/fig-basic-ota-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-basic-ota-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;24: The 5-transistor OTA.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled" title="Refresh MOSFET Basic Circuits">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Refresh MOSFET Basic Circuits
</div>
</div>
<div class="callout-body-container callout-body">
<p>While we repeat the basics of elementary MOSFET amplifier stages (like common-source stage, common-gate stage, and current mirror) in this course material, the following compendium <span class="citation" data-cites="murmann_mos_stages_2013">(<a href="#ref-murmann_mos_stages_2013" role="doc-biblioref">Murmann 2013</a>)</span> is recommended for review. It is freely available at <a href="https://github.com/bmurmann/Book-on-MOS-stages" class="uri">https://github.com/bmurmann/Book-on-MOS-stages</a>.</p>
<p>In addition, we can highly recommend these references <span class="citation" data-cites="Gray_Mayer_5th_ed">Razavi (<a href="#ref-Razavi_Analog_CMOS" role="doc-biblioref">2017</a>)</span> for further study.</p>
</div>
</div>
<p>The operation is as follows: <span class="math inline">\(M_{1,2}\)</span> form a differential pair which is biased by the current source <span class="math inline">\(M_5\)</span>. <span class="math inline">\(M_{5,6}\)</span> form a current mirror, thus the input bias current <span class="math inline">\(I_\mathrm{bias}\)</span> sets the bias current in the OTA. The differential pair <span class="math inline">\(M_{1,2}\)</span> is loaded by the current mirror <span class="math inline">\(M_{3,4}\)</span> which mirrors the output current of <span class="math inline">\(M_1\)</span> to the right side. Here, the currents from <span class="math inline">\(M_4\)</span> and <span class="math inline">\(M_2\)</span> are summed, and together with the conductance effective at the output node a voltage builds up.</p>
<p>We note that <span class="math inline">\(M_{1,2}\)</span> and <span class="math inline">\(M_{3,4}\)</span> need to be symmetric, thus will have the same <span class="math inline">\(W\)</span> and <span class="math inline">\(L\)</span> dimensioning. <span class="math inline">\(M_{5,6}\)</span> we scale accordingly to set the correct bias current in the OTA.</p>
<p>As this is an OTA the output is a current; if the load impedance is high (i.e., purely capacitive, which is often the case in integrated circuits when driving MOSFET inputs) then the voltage gain of the OTA can be high (of course, in this simple OTA it is limited). With a high-impedance loading this OTA can provide a voltage output, and this is actually how OTAs are mostly operated.</p>
<section id="voltage-buffer-with-ota" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="voltage-buffer-with-ota"><span class="header-section-number">8.1</span> Voltage Buffer with OTA</h2>
<p>In order to design an OTA we need an application, and from this we need to derive the circuit specifications. We want to use this OTA to realize a voltage buffer which lightly loads a voltage source and can drive a large capacitive load. Such a configuration is often used to, e.g., buffer a reference voltage that is needed (and thus loaded) by another circuit. The block diagram of this configuration is shown in <a href="#fig-voltage-buffer-ota" class="quarto-xref">Figure&nbsp;25</a>.</p>
<div id="cell-fig-voltage-buffer-ota" class="cell" data-execution_count="18">
<div class="cell-output cell-output-display">
<div id="fig-voltage-buffer-ota" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-voltage-buffer-ota-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-voltage-buffer-ota-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-41" title="Figure&nbsp;25: A voltage buffer (based on OTA) driving a capacitive load."><img src="index_files/figure-html/fig-voltage-buffer-ota-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-voltage-buffer-ota-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;25: A voltage buffer (based on OTA) driving a capacitive load.
</figcaption>
</figure>
</div>
</div>
</div>
<p>If the voltage gain of the OTA in <a href="#fig-voltage-buffer-ota" class="quarto-xref">Figure&nbsp;25</a> is high, then <span class="math inline">\(V_\mathrm{out} \approx V_\mathrm{in}\)</span>. We now want to design an OTA for this application for the following specification values (see <a href="#tbl-voltage-buffer-spec" class="quarto-xref">Table&nbsp;2</a>). These values are rather typical of what could be expected for such a buffer design.</p>
<div id="tbl-voltage-buffer-spec" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-voltage-buffer-spec-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Voltage buffer specification
</figcaption>
<div aria-describedby="tbl-voltage-buffer-spec-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 55%">
<col style="width: 35%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Specification</th>
<th style="text-align: center;">Value</th>
<th style="text-align: center;">Unit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Supply voltage</td>
<td style="text-align: center;"><span class="math inline">\(1.45 &lt; \underline{1.5} &lt; 1.55\)</span></td>
<td style="text-align: center;">V</td>
</tr>
<tr class="even">
<td style="text-align: left;">Temperature range (industrial)</td>
<td style="text-align: center;"><span class="math inline">\(-40 &lt; \underline{27} &lt; 125\)</span></td>
<td style="text-align: center;">degC</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Load capacitance <span class="math inline">\(C_\mathrm{load}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(50\)</span></td>
<td style="text-align: center;">fF</td>
</tr>
<tr class="even">
<td style="text-align: left;">Input voltage range (for buffering 2/3 bandgap voltage)</td>
<td style="text-align: center;"><span class="math inline">\(0.7 &lt; \underline{0.8} &lt; 0.9\)</span></td>
<td style="text-align: center;">V</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Signal bandwidth (3dB)</td>
<td style="text-align: center;"><span class="math inline">\(&gt;10\)</span></td>
<td style="text-align: center;">MHz</td>
</tr>
<tr class="even">
<td style="text-align: left;">Output voltage error</td>
<td style="text-align: center;"><span class="math inline">\(&lt;3\)</span></td>
<td style="text-align: center;">%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Total output noise (rms)</td>
<td style="text-align: center;"><span class="math inline">\(&lt;1\)</span></td>
<td style="text-align: center;">mV<sub>rms</sub></td>
</tr>
<tr class="even">
<td style="text-align: left;">Supply current (as low as possible)</td>
<td style="text-align: center;"><span class="math inline">\(&lt;10\)</span></td>
<td style="text-align: center;">µA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Stability</td>
<td style="text-align: center;">stable for rated <span class="math inline">\(C_\mathrm{load}\)</span></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Turn-on time (settled to with 1%)</td>
<td style="text-align: center;"><span class="math inline">\(&lt;10\)</span></td>
<td style="text-align: center;">µs</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Externally provided bias current (nominal)</td>
<td style="text-align: center;"><span class="math inline">\(20\)</span></td>
<td style="text-align: center;">µA</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="sec-basic-ota-large-signal" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="sec-basic-ota-large-signal"><span class="header-section-number">8.2</span> Large-Signal Analysis of the OTA</h2>
<p>The first step when receiving a design task is to look at the specifications, and see whether they make sense. Detailed performance of the design will be the result of the circuit simulation, but before we step into sizing we need to do a few simple calculations to (a) allows to do back-of-the-envelope gauging if the specification makes sense, and (b) the derived analytical equations will serve as guide for the sizing procedure.</p>
<ul>
<li>In terms of large-signal operation, we will now check whether the input and output voltage range, as well as the settling time can be roughly met.</li>
<li>When the input is at its maximum of <span class="math inline">\(0.9\,\text{V}\)</span>, we see that we need to keep <span class="math inline">\(M_1\)</span> in saturation. We can calculate that <span class="math inline">\(V_\mathrm{DS1} = V_\mathrm{DD}- |V_\mathrm{GS3}| + V_\mathrm{GS1} - V_\mathrm{in} = 1.45 - 0.6 + 0.6 - 0.9 = 0.55\,\text{V}\)</span>, which leaves enough margin.</li>
<li>When the input is at its minimum of <span class="math inline">\(0.7\,\text{V}\)</span>, we see that the <span class="math inline">\(V_\mathrm{DS5}\)</span> of <span class="math inline">\(M_5\)</span> is calculated as <span class="math inline">\(V_\mathrm{DS5} = V_\mathrm{in} - V_\mathrm{GS1} = 0.7 - 0.6 = 0.1\,\text{V}\)</span>, so this leaves little margin, but likely <span class="math inline">\(V_\mathrm{GS1}\)</span> will be smaller, so it should work out.</li>
<li>For the output voltage, when the output voltage is on the high side, it leaves <span class="math inline">\(|V_\mathrm{DS4}| = V_\mathrm{DD}- V_\mathrm{out} = 1.45 - 0.9 = 0.55\,\text{V}\)</span>, which is enough margin.</li>
</ul>
<p>In summary, we think that we can make an NMOS-input OTA like the one in <a href="#fig-basic-ota" class="quarto-xref">Figure&nbsp;24</a> work for the required supply and input- and output voltages. If this would not work out, we need to look for further options, like a PMOS-input OTA, or a NMOS/PMOS-input OTA.</p>
<p>Another large-signal specification item that we can quickly check is the settling time. Under slewing conditions, the complete bias current in the OTA is steered towards the output (try to understand why this is the case), so when the output capacitor is fully discharged, and we assume just a linear ramp due to constant-current charging of the output capacitor, the settling time is <span class="math display">\[
T_\mathrm{slew} \approx \frac{C_\mathrm{load} V_\mathrm{out}}{I_\mathrm{tail}} = \frac{50 \cdot 10^{-15} \cdot 1.3}{10 \cdot 10^{-6}} = 6.5\,\text{ns}
\]</span> so this leaves plenty of margin for additional slow-signal settling due to the limited bandwidth, as well as reducing the supply current.</p>
<p>The small-signal settling (assuming one pole at the bandwidth corner frequency) leads to an approximate settling time (1% error corresponds to <span class="math inline">\(\approx 5 \tau\)</span>) of <span class="math display">\[
T_\mathrm{slew} \approx \frac{5}{2 \pi f_\mathrm{c}} = \frac{5}{2 \pi \cdot 1 \cdot 10^{-6}} = 0.8\,\mu\text{s}.
\]</span> which also checks out.</p>
</section>
<section id="sec-basic-ota-small-signal" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="sec-basic-ota-small-signal"><span class="header-section-number">8.3</span> Small-Signal Analysis of the OTA</h2>
<p>In order to size the OTA components we need to derive how MOSFET parameters define the performance. The important small-signal metrics are</p>
<ul>
<li>dc gain <span class="math inline">\(A_0\)</span></li>
<li>gain-bandwidth product (GBW)</li>
<li>output noise</li>
</ul>
<p>The specification for GBW is given in <a href="#tbl-voltage-buffer-spec" class="quarto-xref">Table&nbsp;2</a>, the dc gain we have to calculate from the voltage accuracy specification. For a voltage follower in the configuration shown in <a href="#fig-voltage-buffer-ota" class="quarto-xref">Figure&nbsp;25</a> the voltage gain is given by <span id="eq-voltage-buffer-tolerance"><span class="math display">\[
\frac{V_\mathrm{out}}{V_\mathrm{in}} = \frac{A_0}{1 + A_0}.
\tag{13}\]</span></span></p>
<p>So in order to reach an output voltage accuracy of at least 3% we need a dc gain of <span class="math inline">\(A_0 &gt; 30.2\,\text{dB}\)</span>. To allow for process and temperature variation we need to add a bit of extra gain as margin.</p>
<section id="ota-small-signal-transfer-function" class="level3" data-number="8.3.1">
<h3 data-number="8.3.1" class="anchored" data-anchor-id="ota-small-signal-transfer-function"><span class="header-section-number">8.3.1</span> OTA Small-Signal Transfer Function</h3>
<p>In order to derive the governing equations for the OTA we will make a few simplifications:</p>
<ul>
<li>We will set <span class="math inline">\(g_\mathrm{mb}= 0\)</span> for all MOSFETs.</li>
<li>We will further set <span class="math inline">\(C_\mathrm{gd}= 0\)</span> for all MOSFETs except for <span class="math inline">\(M_4\)</span> where we expect a Miller effect on this capacitor, and we could add its effect by increasing the capacitance at the gate node of <span class="math inline">\(M_{3,4}\)</span> (for background please see <a href="#sec-miller-theorem" class="quarto-xref">Section&nbsp;16</a>). However, as this does not create a dominant pole in this circuit, we consider this a minor effect (see <a href="#eq-simple-ota-gain" class="quarto-xref">Equation&nbsp;16</a>). Thus, only <span class="math inline">\(C_\mathrm{gs34}\)</span> is considered at the gate node of the current mirror load.</li>
<li>We assume <span class="math inline">\(g_\mathrm{m}\gg g_\mathrm{ds}\)</span>, so we set <span class="math inline">\(g_\mathrm{ds1} = g_\mathrm{ds3} = 0\)</span>.</li>
<li>The drain capacitance of <span class="math inline">\(M_2\)</span> and <span class="math inline">\(M_4\)</span>, as well as the gate capacitance of <span class="math inline">\(M_2\)</span> we can add to the load capacitance <span class="math inline">\(C_\mathrm{load}\)</span>. Note that <span class="math inline">\(C_\mathrm{gs2}\)</span> can be added because of the feedback connection between the inverting input and the output. However, this is not shown in the small-signal equivalent circuits below, because we are interested in the open-loop transfer function.</li>
</ul>
<p>The resulting small-signal equivalent circuit is shown in <a href="#fig-basic-ota-small-signal" class="quarto-xref">Figure&nbsp;26</a>.</p>
<div class="callout callout-style-default callout-warning callout-titled" title="Refresh MOSFET Small-Signal Model">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Refresh MOSFET Small-Signal Model
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please review the MOSFET small-signal equivalent model in <a href="#fig-mosfet-small-signal-model" class="quarto-xref">Figure&nbsp;5</a> at this point. For the PMOS just flip the model upside-down.</p>
</div>
</div>
<div id="cell-fig-basic-ota-small-signal" class="cell" data-execution_count="19">
<div class="cell-output cell-output-display">
<div id="fig-basic-ota-small-signal" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-basic-ota-small-signal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-basic-ota-small-signal-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-42" title="Figure&nbsp;26: 5-transistor OTA small-signal model."><img src="index_files/figure-html/fig-basic-ota-small-signal-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-basic-ota-small-signal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;26: 5-transistor OTA small-signal model.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can further simplify the output side by recognizing that the impedance looking from the output down we have <span class="math inline">\(g_\mathrm{ds2}\)</span> in series with <span class="math inline">\(g_\mathrm{ds5} + g_\mathrm{m12}\)</span> (since we treat <span class="math inline">\(M_1\)</span> as a common-gate stage when looking from the output, and since it is loaded by a low impedance of <span class="math inline">\(g_\mathrm{m34}^{-1}\)</span> we can approximate the impedance looking into the source of <span class="math inline">\(M_1\)</span> with <span class="math inline">\(g_\mathrm{m12}^{-1}\)</span>). With the approximation that <span class="math inline">\(g_\mathrm{m}\gg g_\mathrm{ds}\)</span> the parallel connection of <span class="math inline">\(g_\mathrm{m12}\)</span> and <span class="math inline">\(g_\mathrm{ds5}\)</span> is dominated by <span class="math inline">\(g_\mathrm{m12}\)</span> and series connection by <span class="math inline">\(g_\mathrm{ds2}\)</span>. Therefore, we can move <span class="math inline">\(g_\mathrm{ds2} + g_\mathrm{ds4}\)</span> in parallel to <span class="math inline">\(C_\mathrm{load}\)</span>. Further, assuming a differential drive with a virtual ground at the tailpoint we can remove <span class="math inline">\(g_\mathrm{ds5}\)</span>. The current source <span class="math inline">\(g_\mathrm{m34} v_\mathrm{gs34}\)</span> is replace with the equivalent conductance <span class="math inline">\(g_\mathrm{m34}\)</span>. This results in the further simplified equivalent circuit shown in <a href="#fig-basic-ota-small-signal-simplified" class="quarto-xref">Figure&nbsp;27</a>.</p>
<div id="cell-fig-basic-ota-small-signal-simplified" class="cell" data-execution_count="20">
<div class="cell-output cell-output-display">
<div id="fig-basic-ota-small-signal-simplified" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-basic-ota-small-signal-simplified-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-basic-ota-small-signal-simplified-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-43" title="Figure&nbsp;27: 5-transistor OTA small-signal model with further simplifications."><img src="index_files/figure-html/fig-basic-ota-small-signal-simplified-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-basic-ota-small-signal-simplified-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;27: 5-transistor OTA small-signal model with further simplifications.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In the simplified circuit model in <a href="#fig-basic-ota-small-signal-simplified" class="quarto-xref">Figure&nbsp;27</a> we can see that we have two poles in the circuit, one at the gate note of <span class="math inline">\(M_{3,4}\)</span>, and one at the output. Realizing that <span class="math inline">\(v_\mathrm{in,p} = v_\mathrm{in}/2\)</span> and <span class="math inline">\(v_\mathrm{in,n} = - v_\mathrm{in}/2\)</span> we can formulate KCL at the output node to <span id="eq-simple-ota-eq1"><span class="math display">\[
-g_\mathrm{m34} V_\mathrm{gs34} - \left( -g_\mathrm{m12} \frac{V_\mathrm{in}}{2} \right) - V_\mathrm{out} (g_\mathrm{ds2} + g_\mathrm{ds4} + s C_\mathrm{load}) = 0.
\tag{14}\]</span></span> We further realize that <span id="eq-simple-ota-eq2"><span class="math display">\[
V_\mathrm{gs34} = -g_\mathrm{m12} \frac{V_\mathrm{in}}{2} \frac{1}{g_\mathrm{m34} + s C_\mathrm{gs34}}.
  \tag{15}\]</span></span></p>
<p>By combining <a href="#eq-simple-ota-eq1" class="quarto-xref">Equation&nbsp;14</a> and <a href="#eq-simple-ota-eq2" class="quarto-xref">Equation&nbsp;15</a> and after a bit of algebraic manipulation we arrive at <span id="eq-simple-ota-gain"><span class="math display">\[
A(s) = \frac{V_\mathrm{out}}{V_\mathrm{in}} = \frac{g_\mathrm{m12}}{2} \frac{2 g_\mathrm{m34} + s C_\mathrm{gs34}}{(g_\mathrm{m34} + s C_\mathrm{gs34}) (g_\mathrm{ds2} + g_\mathrm{ds4} + s C_\mathrm{load})}.
\tag{16}\]</span></span></p>
<p>When we now inspect <a href="#eq-simple-ota-gain" class="quarto-xref">Equation&nbsp;16</a> we can see that for low frequencies the gain is <span id="eq-simple-ota-gain-dc"><span class="math display">\[
A(s \rightarrow 0) = A_0 = \frac{g_\mathrm{m12}}{g_\mathrm{ds2} + g_\mathrm{ds4}}
\tag{17}\]</span></span> which is plausible, and confirms the requirement of a high impedance at the output node. For very large frequencies we get <span id="eq-simple-ota-highf"><span class="math display">\[
A (s \rightarrow \infty) = \frac{g_\mathrm{m12}}{2 s C_\mathrm{load}}
\tag{18}\]</span></span> which is essentially the behavior of an integrator, and we can use <a href="#eq-simple-ota-highf" class="quarto-xref">Equation&nbsp;18</a> to calculate the frequency where the gain drops to <span class="math inline">\(1\)</span>: <span class="math display">\[
f_\mathrm{ug} = \frac{g_\mathrm{m12}}{4 \pi C_\mathrm{load}}
\]</span></p>
<p>when looking at <a href="#eq-simple-ota-gain" class="quarto-xref">Equation&nbsp;16</a> we see that we have a dominant pole at <span class="math inline">\(s_\mathrm{p}\)</span> and a pole-zero doublet with <span class="math inline">\(s_\mathrm{pd}\)</span>/<span class="math inline">\(s_\mathrm{zd}\)</span>: <span class="math display">\[
s_\mathrm{p} = -\frac{g_\mathrm{ds2} + g_\mathrm{ds4}}{C_\mathrm{load}}
\]</span> <span class="math display">\[
s_\mathrm{pd} = -\frac{g_\mathrm{m34}}{C_\mathrm{gs34}}
\]</span> <span class="math display">\[
s_\mathrm{zd} = -\frac{2 g_\mathrm{m34}}{C_\mathrm{gs34}}
\]</span></p>
</section>
<section id="ota-noise" class="level3" data-number="8.3.2">
<h3 data-number="8.3.2" class="anchored" data-anchor-id="ota-noise"><span class="header-section-number">8.3.2</span> OTA Noise</h3>
<p>For the noise analysis we ignore the pole-zero doublet due to <span class="math inline">\(C_\mathrm{gs34}\)</span> (we assume minor impact due to this) and just consider the dominant pole. For the noise analysis at the output we set the input signal to zero, and thus we arrive at the simplified small-signal circuit shown in <a href="#fig-basic-ota-small-signal-noise" class="quarto-xref">Figure&nbsp;28</a>.</p>
<div id="cell-fig-basic-ota-small-signal-noise" class="cell" data-execution_count="21">
<div class="cell-output cell-output-display">
<div id="fig-basic-ota-small-signal-noise" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-basic-ota-small-signal-noise-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-basic-ota-small-signal-noise-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-44" title="Figure&nbsp;28: 5-transistor OTA small-signal model for noise calculation."><img src="index_files/figure-html/fig-basic-ota-small-signal-noise-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-basic-ota-small-signal-noise-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;28: 5-transistor OTA small-signal model for noise calculation.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We see that <span class="math display">\[
\overline{V_\mathrm{gs34}^2} = \frac{1}{g_\mathrm{m34}^2} \left( \overline{I_\mathrm{n1}^2} + \overline{I_\mathrm{n3}^2} \right).
\]</span></p>
<div class="callout callout-style-default callout-important callout-titled" title="Noise Addition">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Noise Addition
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember that <strong>uncorrelated</strong> noise quantities need to be power-summed (i.e., <span class="math inline">\(I^2 = I_1^2 + I_2^2\)</span>)!</p>
</div>
</div>
<p>We can then sum the output noise current <span class="math inline">\(\overline{I_\mathrm{n}}\)</span> as <span class="math display">\[
\overline{I_\mathrm{n}^2} = \overline{I_\mathrm{n2}^2} + \overline{I_\mathrm{n4}^2} + g_\mathrm{m34}^2 \frac{1}{g_\mathrm{m34}^2} \left( \overline{I_\mathrm{n1}^2} + \overline{I_\mathrm{n3}^2} \right) = 2 \left( \overline{I_\mathrm{n12}^2} + \overline{I_\mathrm{n34}^2} \right).
\]</span></p>
<p>As a next step, let us rewrite the OTA transfer function <span class="math inline">\(A(s)\)</span> (see <a href="#eq-simple-ota-gain" class="quarto-xref">Equation&nbsp;16</a>) by getting rid of the pole-zero doublet as a simplifying assumption to get <span id="eq-simple-ota-gain-simplified"><span class="math display">\[
A'(s) = \frac{g_\mathrm{m12}}{g_\mathrm{ds2} + g_\mathrm{ds4} + s C_\mathrm{load}}.
\tag{19}\]</span></span></p>
<p>Inspecting <a href="#eq-simple-ota-gain-simplified" class="quarto-xref">Equation&nbsp;19</a> we can interpret the OTA transfer function as a transconductor <span class="math inline">\(g_\mathrm{m12}\)</span> driving a load of <span class="math inline">\(Y_\mathrm{load} = g_\mathrm{ds2} + g_\mathrm{ds4} + s C_\mathrm{load}\)</span>. We can thus redraw <a href="#fig-voltage-buffer-ota" class="quarto-xref">Figure&nbsp;25</a> in the following way, injecting the previously calculated noise current into the output node. The result is shown in <a href="#fig-voltage-buffer-ota-noise" class="quarto-xref">Figure&nbsp;30</a>.</p>
<div id="cell-fig-voltage-buffer-ota-noise-zout" class="cell" data-execution_count="22">
<div class="cell-output cell-output-display">
<div id="fig-voltage-buffer-ota-noise-zout" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-voltage-buffer-ota-noise-zout-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-voltage-buffer-ota-noise-zout-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-45" title="Figure&nbsp;29: Output impedance calculation of a voltage buffer."><img src="index_files/figure-html/fig-voltage-buffer-ota-noise-zout-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-voltage-buffer-ota-noise-zout-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;29: Output impedance calculation of a voltage buffer.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Output Impedance of the Voltage Buffer">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Output Impedance of the Voltage Buffer
</div>
</div>
<div class="callout-body-container callout-body">
<p>First we short the input terminal to ground and then we connect a current source <span class="math inline">\(I_\mathrm{out}\)</span> at the output terminal, see <a href="#fig-voltage-buffer-ota-noise-zout" class="quarto-xref">Figure&nbsp;29</a>. Since we can neglect the gate leakage current into the inverting input terminal of the OTA, KCL at the output node is simply: <span class="math display">\[
I_\mathrm{out} + g_\mathrm{m12}\left(-V_\mathrm{out}\right) = 0
\]</span> Thus, the output impedance is easily calculated. <span class="math display">\[
Z_\mathrm{out} = \frac{V_\mathrm{out}}{I_\mathrm{out}} = \frac{V_\mathrm{out}}{g_\mathrm{m12}V_\mathrm{out}} = \frac{1}{g_\mathrm{m12}}
\]</span></p>
</div>
</div>
<div id="cell-fig-voltage-buffer-ota-noise" class="cell" data-execution_count="23">
<div class="cell-output cell-output-display">
<div id="fig-voltage-buffer-ota-noise" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-voltage-buffer-ota-noise-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-voltage-buffer-ota-noise-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-46" title="Figure&nbsp;30: A voltage buffer redrawn for noise analysis."><img src="index_files/figure-html/fig-voltage-buffer-ota-noise-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-voltage-buffer-ota-noise-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;30: A voltage buffer redrawn for noise analysis.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We see that the feedback around the transconductor <span class="math inline">\(g_\mathrm{m12}\)</span> creates an impedance of <span class="math inline">\(1/g_\mathrm{m12}\)</span>. We can now calculate the effective load conductance of <span id="eq-basic-ota-output-noise-yload"><span class="math display">\[
Y'_\mathrm{load} = g_\mathrm{ds2} + g_\mathrm{ds4} + s C_\mathrm{load} + g_\mathrm{m12} \approx g_\mathrm{m12} + s C_\mathrm{load}.
\tag{20}\]</span></span></p>
<p>The output noise voltage is then (using <a href="#eq-mosfet-noise" class="quarto-xref">Equation&nbsp;1</a>) <span class="math display">\[
\overline{V_\mathrm{n,out}^2}(f) = \frac{\overline{I_\mathrm{n}^2}}{|Y'_\mathrm{load}|^2} = \frac{\overline{I_\mathrm{n}^2}}{g_\mathrm{m12}^2 + (2 \pi f C_\mathrm{load})2^2} = \frac{8 k T (\gamma_{12} g_\mathrm{m12} + \gamma_{34} g_\mathrm{m34})}{g_\mathrm{m12}^2 + (2 \pi f C_\mathrm{load})^2}.
\]</span></p>
<p>We can use the identity <a href="#eq-integral-identity" class="quarto-xref">Equation&nbsp;8</a> to calculate the rms output noise to <span id="eq-basic-ota-output-noise"><span class="math display">\[
V_\mathrm{n,out,rms}^2 = \int_0^\infty \overline{V_\mathrm{n,out}^2}(f) df = \frac{k T}{C_\mathrm{load}} \left( 2 \gamma_{12} + 2 \gamma_{34} \frac{g_\mathrm{m34}}{g_\mathrm{m12}} \right).
\tag{21}\]</span></span></p>
<p>Inspecting <a href="#eq-basic-ota-output-noise" class="quarto-xref">Equation&nbsp;21</a> we can see that the integrated output noise is the <span class="math inline">\(k T / C\)</span> noise of the output load capacitor, enhanced by the <span class="math inline">\(\gamma_{12}\)</span> of the input differential pair, plus a (smaller) contribution of the current mirror load <span class="math inline">\(M_{3,4}\)</span>. Intuitively, this result makes sense.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: Derivation of 5T-OTA Performance">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: Derivation of 5T-OTA Performance
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please take your time and carefully go through the explanations and derivations for the 5-transistor-OTA in <a href="#sec-basic-ota-large-signal" class="quarto-xref">Section&nbsp;8.2</a> and <a href="#sec-basic-ota-small-signal" class="quarto-xref">Section&nbsp;8.3</a>. Try to do the calculations yourself; if you get stuck, review the previous chapters.</p>
</div>
</div>
</section>
</section>
<section id="sec-basic-ota-sizing" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="sec-basic-ota-sizing"><span class="header-section-number">8.4</span> 5T-OTA Sizing</h2>
<p>Outfitted with the governing equations derived in <a href="#sec-basic-ota-small-signal" class="quarto-xref">Section&nbsp;8.3</a> we can now size the MOSFETs in the OTA, we remember that we have to size <span class="math inline">\(M_{1,2}\)</span> and <span class="math inline">\(M_{3,4}\)</span> equally.</p>
<p>First, we need to select a proper <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> for the MOSFET. Remembering <a href="#sec-gmid-method" class="quarto-xref">Section&nbsp;3</a> we see that for the input differential pair we should go for a large <span class="math inline">\(g_\mathrm{m}\)</span>, thus we select a <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}= 10\)</span>. As <span class="math inline">\(g_\mathrm{ds}\)</span> of <span class="math inline">\(M_2\)</span> could limit the dc gain (<a href="#eq-simple-ota-gain-dc" class="quarto-xref">Equation&nbsp;17</a>) we go with a rather long <span class="math inline">\(L = 5\,\mu\text{m}\)</span>. For current sources a small <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> is a good idea, so we start with <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}=5\)</span> (because we can not go too low because of <span class="math inline">\(V_\mathrm{ds,sat}\)</span>) and also an <span class="math inline">\(L = 5\,\mu\text{m}\)</span>. The <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> is also useful to estimate the required drain-source voltage to keep a MOSFET in saturation (i.e., keep the <span class="math inline">\(g_\mathrm{ds}\)</span> small) with this approximate relationship:</p>
<p><span id="eq-gmid-saturation"><span class="math display">\[
V_\mathrm{ds,sat} = \frac{2}{g_\mathrm{m}/I_\mathrm{D}}
\tag{22}\]</span></span></p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: 5T-OTA Sizing">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: 5T-OTA Sizing
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please size the 5T-OTA according to the previous <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> and <span class="math inline">\(L\)</span> suggestions. Please calculate the <span class="math inline">\(W\)</span> of <span class="math inline">\(M_{1-6}\)</span> and the total supply current. Please check wether gain error, total output noise, and turn-on settling is met with the calculated devices sizes and bias currents.</p>
</div>
</div>
<p>The sizing procedure and its calculation are best performed in a Jupyter notebook, as we can easily look up the exact data from the pre-computed tables:</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Solution: 5T-OTA Sizing">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-41-contents" aria-controls="callout-41" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution: 5T-OTA Sizing
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-41" class="callout-41-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="sizing-for-basic-5t-ota" class="level1 unnumbered unlisted quarto-embed-nb-cell">
<h1 class="unnumbered unlisted">Sizing for Basic 5T-OTA</h1>
<p><strong>Copyright 2024 Harald Pretl</strong></p>
<p>Licensed under the Apache License, Version 2.0 (the “License”); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0</p>
<div id="cell-1" class="cell" data-jupyter="{&quot;source_hidden&quot;:true}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read table data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pygmid <span class="im">import</span> Lookup <span class="im">as</span> lk</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>lv_nmos <span class="op">=</span> lk(<span class="st">'sg13_lv_nmos.mat'</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>lv_pmos <span class="op">=</span> lk(<span class="st">'sg13_lv_pmos.mat'</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># list of parameters: VGS, VDS, VSB, L, W, NFING, ID, VT, GM, GMB, GDS, CGG, CGB, CGD, CGS, CDD, CSS, STH, SFL</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># if not specified, minimum L, VDS=max(vgs)/2=0.9 and VSB=0 are used </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-2" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define the given parameters as taken from the specification table or inital guesses</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>c_load <span class="op">=</span> <span class="fl">50e-15</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>gm_id_m12 <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>gm_id_m34 <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>gm_id_m56 <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>l_12 <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>l_34 <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>l_56 <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>f_bw <span class="op">=</span> <span class="fl">10e6</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>i_total_limit <span class="op">=</span> <span class="fl">10e-6</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>i_bias_in <span class="op">=</span> <span class="fl">20e-6</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>output_voltage <span class="op">=</span> <span class="fl">1.3</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>vin_min <span class="op">=</span> <span class="fl">0.7</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>vin_max <span class="op">=</span> <span class="fl">0.9</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>vdd_min <span class="op">=</span> <span class="fl">1.45</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>vdd_max <span class="op">=</span> <span class="fl">1.55</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-3" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we get the required gm of M1/2 from the bandwidth requirement</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we add a factor of 3 to allow for PVT variation plus additional MOSFET parasitic loading</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>gm_m12 <span class="op">=</span> f_bw <span class="op">*</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">4</span><span class="op">*</span>np.pi<span class="op">*</span>c_load</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'gm12 ='</span>, <span class="bu">round</span>(gm_m12<span class="op">/</span><span class="fl">1e-3</span>, <span class="dv">4</span>), <span class="st">'mS'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gm12 = 0.0188 mS</code></pre>
</div>
</div>
<div id="cell-4" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># since we know gm12 and the gmid we can calculate the bias current</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>id_m12 <span class="op">=</span> gm_m12 <span class="op">/</span> gm_id_m12</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>i_total <span class="op">=</span> <span class="dv">2</span><span class="op">*</span>id_m12</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'i_total (exact) ='</span>, <span class="bu">round</span>(i_total<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">1</span>), <span class="st">'µA'</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># we round to 0.5µA bias currents</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>i_total <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(i_total <span class="op">/</span> <span class="fl">1e-6</span> <span class="op">*</span> <span class="dv">2</span>) <span class="op">/</span> <span class="dv">2</span> <span class="op">*</span> <span class="fl">1e-6</span>, <span class="fl">0.5e-6</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>id_m12 <span class="op">=</span> i_total<span class="op">/</span><span class="dv">2</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'i_total (rounded) ='</span>, i_total<span class="op">/</span><span class="fl">1e-6</span>, <span class="st">'µA'</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> i_total <span class="op">&lt;</span> i_total_limit:</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[info] power consumption target is met!'</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[info] power consumption target is NOT met!'</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>i_total (exact) = 3.8 µA
i_total (rounded) = 4.0 µA
[info] power consumption target is met!</code></pre>
</div>
</div>
<div id="cell-5" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we calculate the dc gain</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>gm_gds_m12 <span class="op">=</span> lv_nmos.lookup(<span class="st">'GM_GDS'</span>, GM_ID<span class="op">=</span>gm_id_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span><span class="fl">0.75</span>, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>gm_gds_m34 <span class="op">=</span> lv_pmos.lookup(<span class="st">'GM_GDS'</span>, GM_ID<span class="op">=</span>gm_id_m34, L<span class="op">=</span>l_34, VDS<span class="op">=</span><span class="fl">0.75</span>, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>gds_m12 <span class="op">=</span> gm_m12 <span class="op">/</span> gm_gds_m12</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>gm_m34 <span class="op">=</span> gm_id_m34 <span class="op">*</span> i_total<span class="op">/</span><span class="dv">2</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>gds_m34 <span class="op">=</span> gm_m34 <span class="op">/</span> gm_gds_m34</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>a0 <span class="op">=</span> gm_m12 <span class="op">/</span> (gds_m12 <span class="op">+</span> gds_m34)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'a0 ='</span>, <span class="bu">round</span>(<span class="dv">20</span><span class="op">*</span>np.log10(a0), <span class="dv">1</span>), <span class="st">'dB'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>a0 = 34.8 dB</code></pre>
</div>
</div>
<div id="cell-6" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we calculate the MOSFET capacitance which adds to Cload, to see the impact on the BW</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>gm_cgs_m12 <span class="op">=</span> lv_nmos.lookup(<span class="st">'GM_CGS'</span>, GM_ID<span class="op">=</span>gm_id_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span><span class="fl">0.75</span>, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>gm_cdd_m12 <span class="op">=</span> lv_nmos.lookup(<span class="st">'GM_CDD'</span>, GM_ID<span class="op">=</span>gm_id_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span><span class="fl">0.75</span>, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>gm_cdd_m34 <span class="op">=</span> lv_pmos.lookup(<span class="st">'GM_CDD'</span>, GM_ID<span class="op">=</span>gm_id_m34, L<span class="op">=</span>l_34, VDS<span class="op">=</span><span class="fl">0.75</span>, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>c_load_parasitic <span class="op">=</span> <span class="bu">abs</span>(gm_m12<span class="op">/</span>gm_cgs_m12) <span class="op">+</span> <span class="bu">abs</span>(gm_m12<span class="op">/</span>gm_cdd_m12) <span class="op">+</span> <span class="bu">abs</span>(gm_m34<span class="op">/</span>gm_cdd_m34)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'additional load capacitance ='</span>, <span class="bu">round</span>(c_load_parasitic<span class="op">/</span><span class="fl">1e-15</span>, <span class="dv">1</span>), <span class="st">'fF'</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>f_bw <span class="op">=</span> gm_m12 <span class="op">/</span> (<span class="dv">4</span><span class="op">*</span>np.pi <span class="op">*</span> (c_load <span class="op">+</span> c_load_parasitic))</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'-3dB bandwidth incl. parasitics ='</span>, <span class="bu">round</span>(f_bw<span class="op">/</span><span class="fl">1e6</span>, <span class="dv">2</span>), <span class="st">'MHz'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>additional load capacitance = 54.9 fF
-3dB bandwidth incl. parasitics = 14.3 MHz</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we can now look up the VGS of the MOSFET</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>vgs_m12 <span class="op">=</span> lv_nmos.look_upVGS(GM_ID<span class="op">=</span>gm_id_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span><span class="fl">0.75</span>, VSB<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>vgs_m34 <span class="op">=</span> lv_pmos.look_upVGS(GM_ID<span class="op">=</span>gm_id_m34, L<span class="op">=</span>l_34, VDS<span class="op">=</span><span class="fl">0.75</span>, VSB<span class="op">=</span><span class="fl">0.0</span>) </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>vgs_m56 <span class="op">=</span> lv_nmos.look_upVGS(GM_ID<span class="op">=</span>gm_id_m56, L<span class="op">=</span>l_56, VDS<span class="op">=</span><span class="fl">0.75</span>, VSB<span class="op">=</span><span class="fl">0.0</span>) </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'vgs_12 ='</span>, <span class="bu">round</span>(<span class="bu">float</span>(vgs_m12), <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'vgs_34 ='</span>, <span class="bu">round</span>(<span class="bu">float</span>(vgs_m34), <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'vgs_56 ='</span>, <span class="bu">round</span>(<span class="bu">float</span>(vgs_m56), <span class="dv">3</span>), <span class="st">'V'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>vgs_12 = 0.367 V
vgs_34 = 0.729 V
vgs_56 = 0.591 V</code></pre>
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate settling time due to slewing with the calculated bias current</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>t_slew <span class="op">=</span> (c_load <span class="op">+</span> c_load_parasitic) <span class="op">*</span> output_voltage <span class="op">/</span> i_total</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'slewing time ='</span>, <span class="bu">round</span>(t_slew<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">3</span>), <span class="st">'µs'</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>t_settle <span class="op">=</span> <span class="dv">5</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>f_bw)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'settling time ='</span>, <span class="bu">round</span>(t_settle<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">3</span>), <span class="st">'µs'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>slewing time = 0.034 µs
settling time = 0.056 µs</code></pre>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate voltage gain error</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>gain_error <span class="op">=</span> a0 <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> a0)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'voltage gain error ='</span>, <span class="bu">round</span>((gain_error<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="st">'%'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>voltage gain error = -1.8 %</code></pre>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate total rms output noise</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>sth_m12 <span class="op">=</span> lv_nmos.lookup(<span class="st">'STH_GM'</span>, VGS<span class="op">=</span>vgs_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span><span class="fl">0.75</span>, VSB<span class="op">=</span><span class="dv">0</span>) <span class="op">*</span> gm_m12</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>gamma_m12 <span class="op">=</span> sth_m12<span class="op">/</span>(<span class="dv">4</span><span class="op">*</span><span class="fl">1.38e-23</span><span class="op">*</span><span class="dv">300</span><span class="op">*</span>gm_m12)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>sth_m34 <span class="op">=</span> lv_pmos.lookup(<span class="st">'STH_GM'</span>, VGS<span class="op">=</span>vgs_m34, L<span class="op">=</span>l_34, VDS<span class="op">=</span><span class="fl">0.75</span>, VSB<span class="op">=</span><span class="dv">0</span>) <span class="op">*</span> gm_m34</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>gamma_m34 <span class="op">=</span> sth_m34<span class="op">/</span>(<span class="dv">4</span><span class="op">*</span><span class="fl">1.38e-23</span><span class="op">*</span><span class="dv">300</span><span class="op">*</span>gm_m34)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>output_noise_rms <span class="op">=</span> <span class="fl">1.38e-23</span><span class="op">*</span><span class="dv">300</span> <span class="op">/</span> (c_load <span class="op">+</span> c_load_parasitic) <span class="op">*</span> (<span class="dv">2</span><span class="op">*</span>gamma_m12 <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>gamma_m34 <span class="op">*</span> gm_m34<span class="op">/</span>gm_m12)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'output noise (rms) ='</span>, <span class="bu">round</span>(output_noise_rms<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">4</span>), <span class="st">'µV'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>output noise (rms) = 0.1254 µV</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate all widths</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>id_w_m12 <span class="op">=</span> lv_nmos.lookup(<span class="st">'ID_W'</span>, GM_ID<span class="op">=</span>gm_id_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span>vgs_m12, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>w_12 <span class="op">=</span> id_m12 <span class="op">/</span> id_w_m12</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>w_12_round <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(w_12<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="fl">0.5</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M1/2 W ='</span>, <span class="bu">round</span>(w_12, <span class="dv">2</span>), <span class="st">'um, rounded W ='</span>, w_12_round, <span class="st">'um'</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>id_m34 <span class="op">=</span> id_m12</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>id_w_m34 <span class="op">=</span> lv_pmos.lookup(<span class="st">'ID_W'</span>, GM_ID<span class="op">=</span>gm_id_m34, L<span class="op">=</span>l_34, VDS<span class="op">=</span>vgs_m34, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>w_34 <span class="op">=</span> id_m34 <span class="op">/</span> id_w_m34</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>w_34_round <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(w_34<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="fl">0.5</span>) </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M3/4 W ='</span>, <span class="bu">round</span>(w_34, <span class="dv">2</span>), <span class="st">'um, rounded W ='</span>, w_34_round, <span class="st">'um'</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>id_w_m5 <span class="op">=</span> lv_nmos.lookup(<span class="st">'ID_W'</span>, GM_ID<span class="op">=</span>gm_id_m56, L<span class="op">=</span>l_56, VDS<span class="op">=</span>vgs_m56, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>w_5 <span class="op">=</span> i_total <span class="op">/</span> id_w_m5</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>w_5_round <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(w_5<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="fl">0.5</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M5 W ='</span>, <span class="bu">round</span>(w_5, <span class="dv">2</span>), <span class="st">'um, rounded W ='</span>, w_5_round, <span class="st">'um'</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>w_6 <span class="op">=</span> w_5_round <span class="op">*</span> i_bias_in <span class="op">/</span> i_total</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>w_6_round <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(w_6<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="fl">0.5</span>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M6 W ='</span>, <span class="bu">round</span>(w_6_round, <span class="dv">2</span>), <span class="st">'um'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>M1/2 W = 1.77 um, rounded W = 2.0 um
M3/4 W = 1.64 um, rounded W = 1.5 um
M5 W = 0.74 um, rounded W = 0.5 um
M6 W = 2.5 um</code></pre>
</div>
</div>
<div id="cell-12" class="cell" data-jupyter="{&quot;source_hidden&quot;:true}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print out final design values</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'5T-OTA dimensioning:'</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'--------------------'</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M1/2 W='</span>, w_12_round, <span class="st">', L='</span>, l_12)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M3/4 W='</span>, w_34_round, <span class="st">', L='</span>, l_34)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M5   W='</span>, w_5_round, <span class="st">', L='</span>, l_56)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M6   W='</span>, w_6_round, <span class="st">', L='</span>, l_56)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'5T-OTA performance summary:'</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'---------------------------'</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'supply current ='</span>, <span class="bu">round</span>(i_total<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">1</span>), <span class="st">'µA'</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'output noise ='</span>, <span class="bu">round</span>(output_noise_rms<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">4</span>), <span class="st">'µVrms'</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'voltage gain error ='</span>, <span class="bu">round</span>((gain_error<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="st">'%'</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'-3dB bandwidth incl. parasitics ='</span>, <span class="bu">round</span>(f_bw<span class="op">/</span><span class="fl">1e6</span>, <span class="dv">2</span>), <span class="st">'MHz'</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'turn-on time (slewing+settling) ='</span>, <span class="bu">round</span>((t_slew<span class="op">+</span>t_settle)<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">3</span>), <span class="st">'µs'</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'5T-OTA bias point check:'</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'------------------------'</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'headroom M1 ='</span>, <span class="bu">round</span>(vdd_min<span class="op">-</span>vgs_m34<span class="op">+</span>vgs_m12<span class="op">-</span>vin_max, <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'headroom M4 ='</span>, <span class="bu">round</span>(vdd_min<span class="op">-</span>vin_max, <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'headroom M5 ='</span>, <span class="bu">round</span>(vin_min<span class="op">-</span>vgs_m12, <span class="dv">3</span>), <span class="st">'V'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5T-OTA dimensioning:
--------------------
M1/2 W= 2.0 , L= 5
M3/4 W= 1.5 , L= 5
M5   W= 0.5 , L= 5
M6   W= 2.5 , L= 5

5T-OTA performance summary:
---------------------------
supply current = 4.0 µA
output noise = 0.1254 µVrms
voltage gain error = -1.8 %
-3dB bandwidth incl. parasitics = 14.3 MHz
turn-on time (slewing+settling) = 0.09 µs

5T-OTA bias point check:
------------------------
headroom M1 = 0.188 V
headroom M4 = 0.55 V
headroom M5 = 0.333 V</code></pre>
</div>
</div>
</section>
</div>
</div>
</div>
</section>
<section id="sec-basic-ota-simulation" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="sec-basic-ota-simulation"><span class="header-section-number">8.5</span> 5T-OTA Simulation</h2>
<p>With the initial sizing of the MOSFETs of the 5T-OTA done, we can design the 5T-OTA circuit and setup a simulation testbench to check the performance parameters. Since this is the first time we draw a more complex schematic, and use a hierarchical design, we should note that drawing a schematic is an art, and there exists a set of rules and recommendations how to name pins, how to use annotations, and so on. Please read <a href="#sec-designers-etiquette" class="quarto-xref">Section&nbsp;21</a> before you start into your design work.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: 5T-OTA Design and Testbench">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: 5T-OTA Design and Testbench
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please design the circuit of the 5T-OTA. Put the OTA circuit in a separate schematic, create a symbol for it, and use this symbol in a testbench you create in Xschem for this 5T-OTA used as a voltage buffer as shown in <a href="#fig-voltage-buffer-ota" class="quarto-xref">Figure&nbsp;25</a>. Use typical conditions for the simulation, and check how well the specification in <a href="#tbl-voltage-buffer-spec" class="quarto-xref">Table&nbsp;2</a> is met, and how well the derivations in <a href="#sec-basic-ota-large-signal" class="quarto-xref">Section&nbsp;8.2</a> and <a href="#sec-basic-ota-small-signal" class="quarto-xref">Section&nbsp;8.3</a> fit to the simulation results.</p>
<p>If you get stuck, you can find the testbench and 5T-OTA schematic <a href="./xschem/ota-5t_tb-ac.svg">here</a> (for the small-signal analysis) and <a href="./xschem/ota-5t_tb-ac.svg">here</a> (for the large-signal settling simulation).</p>
</div>
</div>
</section>
<section id="t-ota-simulation-versus-pvt" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="t-ota-simulation-versus-pvt"><span class="header-section-number">8.6</span> 5T-OTA Simulation versus PVT</h2>
<p>As you have seen in <a href="#sec-basic-ota-simulation" class="quarto-xref">Section&nbsp;8.5</a> running simulations by hand is tedious. When we want to check the overall performance, we have to run many simulations over various conditions:</p>
<ol type="1">
<li>The supply voltage of the circuit has tolerances, and thus we need to check the performance against this variation.</li>
<li>The temperature at which the circuit is operated is likely changing. Also the performance against this has to be verified.</li>
<li>When manufacturing the wafers random variations in various process parameters lead to changed parameters of the integrated circuit components. In order to check for this effect, wafer foundries provide model files which shall cover these manufacturing excursions. Simplified, this leads to a slower or faster MOSFET, and usually NMOS and PMOS are not correlated, so we have the process corners <strong>SS</strong>, <strong>SF</strong>, <strong>TT</strong>, <strong>FS</strong>, and <strong>FF</strong>. So far, we have only used the <strong>TT</strong> models in our simulations.</li>
</ol>
<p>The variations listed in the previous list are abbreviated as <strong>PVT</strong> (process, voltage, temperature) variations. In order to finalize a circuit all combinations of these (plus the variations in operating conditions like input voltage) have to be simulated. As you can imagine, this leads to a huge number of simulations, and simulation results which have to be evaluated for pass/fail.</p>
<p>There are two options how to tackle this efficiently:</p>
<ol type="1">
<li>As an experienced designer you have a very solid understanding of the circuit, plus based on the analytic equations you can identify which combination of operating conditions will lead to a worst case performance. Thus, you can drastically reduce the number of corners to simulate, and you run them by hand.</li>
<li>You are using a framework which highly automates this task of running a plethora of different simulations and evaluating the outcome. These frameworks are called simulation runners.</li>
</ol>
<p>Luckily, there are open-source versions of simulation runners available, and we will use <a href="https://github.com/efabless/cace">CACE</a> in this lecture. CACE is written in Python and allows to setup a datasheet in <a href="https://yaml.org">YAML</a> which defines the simulation problem and the performance parameters to evaluate against which limits. The resulting simulations are then run in parallel and the simulation data is evaluated and summarized in various forms.</p>
<p>There is a CACE setup available for our 5T-OTA. The <a href="./cace/voltage-buffer-ota.yaml">datasheet</a> describes the operating conditions and the simulations tasks. For each simulation a testbench template is needed, <a href="./cace/templates/ota-5t-ac.sch">this one</a> is used for ac simulations, <a href="./cace/templates/ota-5t-noise.sch">this one</a> is used for noise simulation, and <a href="./cace/templates/ota-5t-tran.sch">this one</a> is used for transient simulation.</p>
<p>After a successful run, a documentation is automatically generated. The result of a full run of this <a href="./xschem/ota-5t.svg">OTA design</a> is presented here:</p>
<div id="nte-basic-ota-cace-result" class="callout callout-style-default callout-note callout-titled" title="CACE Summary for 5T-OTA">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-43-contents" aria-controls="callout-43" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;2: CACE Summary for 5T-OTA
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-43" class="callout-43-contents callout-collapse collapse show">
<section id="cace-summary-for-ota-5t" class="level1 unnumbered unlisted callout-body-container callout-body">
<h1 class="unnumbered unlisted">CACE Summary for ota-5t</h1>
<p><strong>netlist source</strong>: schematic</p>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 11%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Tool</th>
<th style="text-align: left;">Result</th>
<th style="text-align: right;">Min Limit</th>
<th style="text-align: right;">Min Value</th>
<th style="text-align: right;">Typ Target</th>
<th style="text-align: right;">Typ Value</th>
<th style="text-align: right;">Max Limit</th>
<th style="text-align: right;">Max Value</th>
<th style="text-align: center;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Output voltage ratio</td>
<td style="text-align: left;">ngspice</td>
<td style="text-align: left;">gain</td>
<td style="text-align: right;">0.97 V/V</td>
<td style="text-align: right;">0.987 V/V</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">1.000 V/V</td>
<td style="text-align: right;">1.03 V/V</td>
<td style="text-align: right;">1.006 V/V</td>
<td style="text-align: center;">Pass ✅</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bandwidth</td>
<td style="text-align: left;">ngspice</td>
<td style="text-align: left;">bw</td>
<td style="text-align: right;">10e6 Hz</td>
<td style="text-align: right;">15551000.000 Hz</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">26912100.000 Hz</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">34051700.000 Hz</td>
<td style="text-align: center;">Pass ✅</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Output noise</td>
<td style="text-align: left;">ngspice</td>
<td style="text-align: left;">noise</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">0.308 mV</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">0.371 mV</td>
<td style="text-align: right;">1 mV</td>
<td style="text-align: right;">0.455 mV</td>
<td style="text-align: center;">Pass ✅</td>
</tr>
<tr class="even">
<td style="text-align: left;">Settling time</td>
<td style="text-align: left;">ngspice</td>
<td style="text-align: left;">tsettle</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">0.135 us</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">0.142 us</td>
<td style="text-align: right;">10 us</td>
<td style="text-align: right;">0.155 us</td>
<td style="text-align: center;">Pass ✅</td>
</tr>
</tbody>
</table>
<section id="plots" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="plots">Plots</h2>
</section>
<section id="gain_vs_temp" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="gain_vs_temp">gain_vs_temp</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/gain_vs_temp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-47" title="gain_vs_temp"><img src="./cace/_docs/ota-5t/schematic/gain_vs_temp.png" class="img-fluid figure-img" alt="gain_vs_temp"></a></p>
<figcaption>gain_vs_temp</figcaption>
</figure>
</div>
</section>
<section id="gain_vs_vin" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="gain_vs_vin">gain_vs_vin</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/gain_vs_vin.png" class="lightbox" data-gallery="quarto-lightbox-gallery-48" title="gain_vs_vin"><img src="./cace/_docs/ota-5t/schematic/gain_vs_vin.png" class="img-fluid figure-img" alt="gain_vs_vin"></a></p>
<figcaption>gain_vs_vin</figcaption>
</figure>
</div>
</section>
<section id="gain_vs_vdd" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="gain_vs_vdd">gain_vs_vdd</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/gain_vs_vdd.png" class="lightbox" data-gallery="quarto-lightbox-gallery-49" title="gain_vs_vdd"><img src="./cace/_docs/ota-5t/schematic/gain_vs_vdd.png" class="img-fluid figure-img" alt="gain_vs_vdd"></a></p>
<figcaption>gain_vs_vdd</figcaption>
</figure>
</div>
</section>
<section id="gain_vs_corner" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="gain_vs_corner">gain_vs_corner</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/gain_vs_corner.png" class="lightbox" data-gallery="quarto-lightbox-gallery-50" title="gain_vs_corner"><img src="./cace/_docs/ota-5t/schematic/gain_vs_corner.png" class="img-fluid figure-img" alt="gain_vs_corner"></a></p>
<figcaption>gain_vs_corner</figcaption>
</figure>
</div>
</section>
<section id="bw_vs_temp" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="bw_vs_temp">bw_vs_temp</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/bw_vs_temp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-51" title="bw_vs_temp"><img src="./cace/_docs/ota-5t/schematic/bw_vs_temp.png" class="img-fluid figure-img" alt="bw_vs_temp"></a></p>
<figcaption>bw_vs_temp</figcaption>
</figure>
</div>
</section>
<section id="bw_vs_vin" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="bw_vs_vin">bw_vs_vin</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/bw_vs_vin.png" class="lightbox" data-gallery="quarto-lightbox-gallery-52" title="bw_vs_vin"><img src="./cace/_docs/ota-5t/schematic/bw_vs_vin.png" class="img-fluid figure-img" alt="bw_vs_vin"></a></p>
<figcaption>bw_vs_vin</figcaption>
</figure>
</div>
</section>
<section id="bw_vs_vdd" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="bw_vs_vdd">bw_vs_vdd</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/bw_vs_vdd.png" class="lightbox" data-gallery="quarto-lightbox-gallery-53" title="bw_vs_vdd"><img src="./cace/_docs/ota-5t/schematic/bw_vs_vdd.png" class="img-fluid figure-img" alt="bw_vs_vdd"></a></p>
<figcaption>bw_vs_vdd</figcaption>
</figure>
</div>
</section>
<section id="bw_vs_corner" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="bw_vs_corner">bw_vs_corner</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/bw_vs_corner.png" class="lightbox" data-gallery="quarto-lightbox-gallery-54" title="bw_vs_corner"><img src="./cace/_docs/ota-5t/schematic/bw_vs_corner.png" class="img-fluid figure-img" alt="bw_vs_corner"></a></p>
<figcaption>bw_vs_corner</figcaption>
</figure>
</div>
</section>
<section id="noise_vs_temp" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="noise_vs_temp">noise_vs_temp</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/noise_vs_temp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-55" title="noise_vs_temp"><img src="./cace/_docs/ota-5t/schematic/noise_vs_temp.png" class="img-fluid figure-img" alt="noise_vs_temp"></a></p>
<figcaption>noise_vs_temp</figcaption>
</figure>
</div>
</section>
<section id="noise_vs_vin" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="noise_vs_vin">noise_vs_vin</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/noise_vs_vin.png" class="lightbox" data-gallery="quarto-lightbox-gallery-56" title="noise_vs_vin"><img src="./cace/_docs/ota-5t/schematic/noise_vs_vin.png" class="img-fluid figure-img" alt="noise_vs_vin"></a></p>
<figcaption>noise_vs_vin</figcaption>
</figure>
</div>
</section>
<section id="noise_vs_vdd" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="noise_vs_vdd">noise_vs_vdd</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/noise_vs_vdd.png" class="lightbox" data-gallery="quarto-lightbox-gallery-57" title="noise_vs_vdd"><img src="./cace/_docs/ota-5t/schematic/noise_vs_vdd.png" class="img-fluid figure-img" alt="noise_vs_vdd"></a></p>
<figcaption>noise_vs_vdd</figcaption>
</figure>
</div>
</section>
<section id="noise_vs_corner" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="noise_vs_corner">noise_vs_corner</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/noise_vs_corner.png" class="lightbox" data-gallery="quarto-lightbox-gallery-58" title="noise_vs_corner"><img src="./cace/_docs/ota-5t/schematic/noise_vs_corner.png" class="img-fluid figure-img" alt="noise_vs_corner"></a></p>
<figcaption>noise_vs_corner</figcaption>
</figure>
</div>
</section>
<section id="settling_vs_temp" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="settling_vs_temp">settling_vs_temp</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/settling_vs_temp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-59" title="settling_vs_temp"><img src="./cace/_docs/ota-5t/schematic/settling_vs_temp.png" class="img-fluid figure-img" alt="settling_vs_temp"></a></p>
<figcaption>settling_vs_temp</figcaption>
</figure>
</div>
</section>
<section id="settling_vs_vin" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="settling_vs_vin">settling_vs_vin</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/settling_vs_vin.png" class="lightbox" data-gallery="quarto-lightbox-gallery-60" title="settling_vs_vin"><img src="./cace/_docs/ota-5t/schematic/settling_vs_vin.png" class="img-fluid figure-img" alt="settling_vs_vin"></a></p>
<figcaption>settling_vs_vin</figcaption>
</figure>
</div>
</section>
<section id="settling_vs_vdd" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="settling_vs_vdd">settling_vs_vdd</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/settling_vs_vdd.png" class="lightbox" data-gallery="quarto-lightbox-gallery-61" title="settling_vs_vdd"><img src="./cace/_docs/ota-5t/schematic/settling_vs_vdd.png" class="img-fluid figure-img" alt="settling_vs_vdd"></a></p>
<figcaption>settling_vs_vdd</figcaption>
</figure>
</div>
</section>
<section id="settling_vs_corner" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="settling_vs_corner">settling_vs_corner</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-5t/schematic/settling_vs_corner.png" class="lightbox" data-gallery="quarto-lightbox-gallery-62" title="settling_vs_corner"><img src="./cace/_docs/ota-5t/schematic/settling_vs_corner.png" class="img-fluid figure-img" alt="settling_vs_corner"></a></p>
<figcaption>settling_vs_corner</figcaption>
</figure>
</div>
</section>
</section>
</div>
</div>
<section id="pvt-simulation-analysis" class="level3" data-number="8.6.1">
<h3 data-number="8.6.1" class="anchored" data-anchor-id="pvt-simulation-analysis"><span class="header-section-number">8.6.1</span> PVT Simulation Analysis</h3>
<p>Looking at the CACE report in <a href="#nte-basic-ota-cace-result" class="quarto-xref">Note&nbsp;2</a> we see that (luckily) the specification is met for all parameters. This is great news! We now have a design that we carefully simulated across PVT and other corners, and which is ready for layout. Once we have the layout ready, we can extract the wiring parasitic (<span class="math inline">\(R\)</span> and <span class="math inline">\(C\)</span>) as well as other layout-dependent effects like <a href="https://global.oup.com/us/companion.websites/9780195170153/pdf/proximityeffectmodels.pdf">well proximity</a>. Using this augmented netlist we can then again use CACE to check performance across conditions and parameter variations, and if we still pass all specification points then our design is finished.</p>
</section>
</section>
</section>
<section id="sec-cascode-stage" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Cascode Stage</h1>
<p>As we have seen in <a href="#sec-basic-ota" class="quarto-xref">Section&nbsp;8</a> the performance of the OTA is generally quite acceptable (see <a href="#tbl-voltage-buffer-spec" class="quarto-xref">Table&nbsp;2</a>), but we might want to aim for better output voltage accuracy. As our analysis has shown the output voltage tolerance is limited by the open-loop dc gain <span class="math inline">\(A_0\)</span> of the OTA (see <a href="#eq-voltage-buffer-tolerance" class="quarto-xref">Equation&nbsp;13</a>), which in turn is limited by the output conductance of <span class="math inline">\(M_2\)</span> and <span class="math inline">\(M_4\)</span> in <a href="#fig-basic-ota" class="quarto-xref">Figure&nbsp;24</a>, which is also confirmed by the analytical result in <a href="#eq-simple-ota-gain-dc" class="quarto-xref">Equation&nbsp;17</a>.</p>
<p>During the sizing procedure we have seen that the achievable <span class="math inline">\(g_\mathrm{m}/ g_\mathrm{ds}\)</span> ratio of a single MOSFET is limited, even if we increase <span class="math inline">\(L\)</span>. We are thus searching for a better option, and here (local) feedback in form of a <strong>cascode</strong> comes to help.</p>
<p>For analysis of a cascode, we use the following single-transistor stage shown in <a href="#fig-cascode-transistor" class="quarto-xref">Figure&nbsp;31</a>.</p>
<div id="cell-fig-cascode-transistor" class="cell" data-execution_count="24">
<div class="cell-output cell-output-display">
<div id="fig-cascode-transistor" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cascode-transistor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-cascode-transistor-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-63" title="Figure&nbsp;31: A MOSFET cascode circuit."><img src="index_files/figure-html/fig-cascode-transistor-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cascode-transistor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;31: A MOSFET cascode circuit.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In order to derive the operation of the cascode analytically, we draw the small-signal equivalent circuit in <a href="#fig-cascode-small-signal" class="quarto-xref">Figure&nbsp;32</a>. We assume that <span class="math inline">\(V_\mathrm{B}\)</span> is a low-ohmic bias voltage, thus we replace it by ac ground. We further set <span class="math inline">\(g_\mathrm{mb}= 0\)</span>.</p>
<div id="cell-fig-cascode-small-signal" class="cell" data-execution_count="25">
<div class="cell-output cell-output-display">
<div id="fig-cascode-small-signal" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cascode-small-signal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-cascode-small-signal-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-64" title="Figure&nbsp;32: The MOSFET cascode small-signal model."><img src="index_files/figure-html/fig-cascode-small-signal-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cascode-small-signal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;32: The MOSFET cascode small-signal model.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Since the gate is assumed at a fixed potential, we can put <span class="math inline">\(C_\mathrm{gs}\)</span> in parallel to <span class="math inline">\(G_\mathrm{S}\)</span> as <span class="math inline">\(G_\mathrm{S}^{*} = G_\mathrm{S} + s C_\mathrm{gs}\)</span>, and we can put <span class="math inline">\(C_\mathrm{gd}\)</span> in parallel to <span class="math inline">\(G_\mathrm{D}\)</span> as <span class="math inline">\(G_\mathrm{D}^{*} = G_\mathrm{D} + s C_\mathrm{gd}\)</span>. As a result we will disregard these capacitors for now, and just consider <span class="math inline">\(G_\mathrm{S}\)</span> and <span class="math inline">\(G_\mathrm{D}\)</span>.</p>
<div id="cell-fig-cascode-small-signal-simplified" class="cell" data-execution_count="26">
<div class="cell-output cell-output-display">
<div id="fig-cascode-small-signal-simplified" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cascode-small-signal-simplified-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-cascode-small-signal-simplified-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-65" title="Figure&nbsp;33: The simplified MOSFET cascode small-signal model."><img src="index_files/figure-html/fig-cascode-small-signal-simplified-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cascode-small-signal-simplified-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;33: The simplified MOSFET cascode small-signal model.
</figcaption>
</figure>
</div>
</div>
</div>
<section id="cascode-output-impedance" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="cascode-output-impedance"><span class="header-section-number">9.1</span> Cascode Output Impedance</h2>
<p>As a first step, we want to calculate the output impedance at the drain of the MOSFET (i.e., looking into the drain). For this, we replace <span class="math inline">\(G_\mathrm{D}\)</span> with a current source. The resulting small-signal equivalent circuit is shown in <a href="#fig-cascode-small-signal-simplified-out" class="quarto-xref">Figure&nbsp;34</a>.</p>
<div id="cell-fig-cascode-small-signal-simplified-out" class="cell" data-execution_count="27">
<div class="cell-output cell-output-display">
<div id="fig-cascode-small-signal-simplified-out" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cascode-small-signal-simplified-out-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-cascode-small-signal-simplified-out-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-66" title="Figure&nbsp;34: The simplified MOSFET cascode small-signal model for calculation of the output impedance."><img src="index_files/figure-html/fig-cascode-small-signal-simplified-out-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cascode-small-signal-simplified-out-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;34: The simplified MOSFET cascode small-signal model for calculation of the output impedance.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We realize that <span class="math inline">\(i_\mathrm{out}\)</span> flows through <span class="math inline">\(G_\mathrm{S}\)</span> and drops <span class="math inline">\(v_\mathrm{gs}\)</span> (note the sign): <span class="math display">\[
v_\mathrm{gs}= -\frac{i_\mathrm{out}}{G_\mathrm{S}}
\]</span></p>
<p>Further, <span class="math inline">\(v_\mathrm{out} = -v_\mathrm{gs}+ v_\mathrm{ds}\)</span>. Calculating KCL at the output node results in <span class="math display">\[
i_\mathrm{out} - g_\mathrm{m}v_\mathrm{gs}- g_\mathrm{ds}v_\mathrm{ds}= 0.
\]</span></p>
<p>Using the previously found identities, and after a bit of algebraic manipulations we arrive at <span id="eq-cascode-output"><span class="math display">\[
g_\mathrm{out} = \frac{i_\mathrm{out}}{v_\mathrm{out}} = \frac{g_\mathrm{ds}}{1 + \frac{g_\mathrm{m}+ g_\mathrm{ds}}{G_\mathrm{S}}} = \frac{g_\mathrm{ds}\cdot G_\mathrm{S}}{G_\mathrm{S} + g_\mathrm{m}+ g_\mathrm{ds}}
\tag{23}\]</span></span></p>
<p>We find that if <span class="math inline">\(G_\mathrm{S} = 0\)</span> (an open) then <span class="math inline">\(g_\mathrm{out} = 0\)</span>, and if <span class="math inline">\(G_\mathrm{S} = \infty\)</span> (a short) then <span class="math inline">\(g_\mathrm{out} = g_\mathrm{ds}\)</span>. We can calculate the benefits of a cascode if we assume we put a cascode on top of a common-source transistor stage (thus <span class="math inline">\(G_\mathrm{S} = g_\mathrm{ds}'\)</span>) and get <span id="eq-cs-cascode-output-impedance"><span class="math display">\[
g_\mathrm{out} = \frac{g_\mathrm{ds}\cdot g_\mathrm{ds}'}{g_\mathrm{ds}' + g_\mathrm{m}+ g_\mathrm{ds}} \approx g_\mathrm{ds}' \frac{g_\mathrm{ds}}{g_\mathrm{m}}.
\tag{24}\]</span></span></p>
<div class="callout callout-style-default callout-important callout-titled" title="Benefit of Cascode (Output)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Benefit of Cascode (Output)
</div>
</div>
<div class="callout-body-container callout-body">
<p>The output impedance of the lower MOSFET (<span class="math inline">\(g_\mathrm{ds}'\)</span>) is <strong>reduced</strong> by the self-gain of the cascode transistor! This is a powerful technique to increase the output impedance of a transistor stage by cascoding, much better than increasing <span class="math inline">\(L\)</span>.</p>
</div>
</div>
</section>
<section id="cascode-input-impedance" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="cascode-input-impedance"><span class="header-section-number">9.2</span> Cascode Input Impedance</h2>
<p>To calculate the input impedance of a cascode (i.e., looking into the source) we replace <span class="math inline">\(G_\mathrm{S}\)</span> with a current source. The resulting small-signal equivalent circuit is shown in <a href="#fig-cascode-small-signal-simplified-in" class="quarto-xref">Figure&nbsp;35</a>.</p>
<div id="cell-fig-cascode-small-signal-simplified-in" class="cell" data-execution_count="28">
<div class="cell-output cell-output-display">
<div id="fig-cascode-small-signal-simplified-in" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cascode-small-signal-simplified-in-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-cascode-small-signal-simplified-in-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-67" title="Figure&nbsp;35: The simplified MOSFET cascode small-signal model for calculation of the input impedance."><img src="index_files/figure-html/fig-cascode-small-signal-simplified-in-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cascode-small-signal-simplified-in-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;35: The simplified MOSFET cascode small-signal model for calculation of the input impedance.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We note that <span class="math inline">\(v_\mathrm{gs}= -v_\mathrm{in}\)</span> and that <span class="math inline">\(i_\mathrm{in}\)</span> flows through <span class="math inline">\(G_\mathrm{D}\)</span>, resulting in <span class="math inline">\(v_\mathrm{D} = i_\mathrm{in} / G_\mathrm{D}\)</span>. Note that <span class="math inline">\(v_\mathrm{ds}=  v_\mathrm{D} - v_\mathrm{in}\)</span>. Formulating KCL at the input node results in <span class="math display">\[
i_\mathrm{in} + g_\mathrm{ds}v_\mathrm{ds}+ g_\mathrm{m}v_\mathrm{gs}= 0.
\]</span></p>
<p>After some manipulation we find that <span id="eq-cascode-input"><span class="math display">\[
g_\mathrm{in} = \frac{i_\mathrm{in}}{v_\mathrm{in}} = \frac{(g_\mathrm{m}+ g_\mathrm{ds}) \cdot G_\mathrm{D}}{g_\mathrm{ds}+ G_\mathrm{D}}.
\tag{25}\]</span></span></p>
<p>Setting <span class="math inline">\(G_\mathrm{D} = 0\)</span> (an open) results in <span class="math inline">\(g_\mathrm{in} = 0\)</span> as well, so the input impedance of the cascode is very large when the drain impedance is large.</p>
<p>However, setting <span class="math inline">\(G_\mathrm{D} = \infty\)</span> (a short or low-ohmic impedance) results in the well-known result of <span class="math inline">\(g_\mathrm{in} = g_\mathrm{m}+ g_\mathrm{ds}\approx g_\mathrm{m}\)</span>, which means that the input impedance looking into a cascode is approximately <span class="math inline">\(1/g_\mathrm{m}\)</span>.</p>
<div class="callout callout-style-default callout-important callout-titled" title="Benefit of Cascode (Input)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Benefit of Cascode (Input)
</div>
</div>
<div class="callout-body-container callout-body">
<p>This has the practical benefit that a capacitance connected at this node results in a high-frequency pole, which is often not critical in terms of stability. Further, the voltage swing at a cascode input node is small due to the often small impedance, and this minimizes the Miller effect at connected inter-node capacitors (see <a href="#sec-miller-theorem" class="quarto-xref">Section&nbsp;16</a>).</p>
</div>
</div>
</section>
</section>
<section id="sec-improved-ota" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Improved OTA</h1>
<p>With the new learned know-how of the cascode stage we can set out to improve our original basic 5T-OTA design. Essentially this means to add cascodes to <span class="math inline">\(M_2\)</span> and <span class="math inline">\(M_4\)</span> in <a href="#fig-basic-ota" class="quarto-xref">Figure&nbsp;24</a>. For symmetry reasons we will add cascodes to both sides, and the resulting schematic is shown in <a href="#fig-improved-ota" class="quarto-xref">Figure&nbsp;36</a>.</p>
<div id="cell-fig-improved-ota" class="cell" data-execution_count="29">
<div class="cell-output cell-output-display">
<div id="fig-improved-ota" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-improved-ota-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-improved-ota-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-68" title="Figure&nbsp;36: The improved OTA based on the 5T-OTA design."><img src="index_files/figure-html/fig-improved-ota-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-improved-ota-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;36: The improved OTA based on the 5T-OTA design.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The transistor name appendix “C” indicates a cascode device sitting atop its base transistor. The bias voltage <span class="math inline">\(V_\mathrm{bias1}\)</span> is referenced to <span class="math inline">\(V_\mathrm{SS}\)</span>, the bias voltage <span class="math inline">\(V_\mathrm{bias3}\)</span> is referenced to <span class="math inline">\(V_\mathrm{DD}\)</span>, and the floating bias voltage <span class="math inline">\(V_\mathrm{bias2}\)</span> creates a voltage bias for <span class="math inline">\(M_\mathrm{1C}\)</span> and <span class="math inline">\(M_\mathrm{2C}\)</span> relative to the tail point, so that the <span class="math inline">\(V_\mathrm{DS}\)</span> of <span class="math inline">\(M_{1,2}\)</span> stays constant with a changing common-mode input voltage.</p>
<div class="callout callout-style-default callout-important callout-titled" title="Cascode Bias Voltage Generation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Cascode Bias Voltage Generation
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is critically import for a stable performance across PVT that the bias voltages for the cascode gates are created in a manner that tracks variations with process, temperature, and supply voltage!</p>
</div>
</div>
<p>The current mirrors constructed out of <span class="math inline">\(M_\mathrm{5/5C,6/6C}\)</span> and <span class="math inline">\(M_\mathrm{3/3C,4/4C}\)</span> are a special kind of <strong>cascode current mirror for low-voltage operation</strong>, also referred to as high-swing cascode current mirror <span class="citation" data-cites="Jespers_Murmann_2017">(<a href="#ref-Jespers_Murmann_2017" role="doc-biblioref">Jespers and Murmann 2017</a>)</span>. This type is very often used, as it forces the <span class="math inline">\(V_\mathrm{GS}\)</span> and <span class="math inline">\(V_\mathrm{DS}\)</span> of <span class="math inline">\(M_{5,6}\)</span> (and <span class="math inline">\(M_{3,4}\)</span>) to be equal, so the current mirror ratio is independent of <span class="math inline">\(g_\mathrm{ds}\)</span>.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: Cascode Current Mirror vs. High-Swing Cascode Current Mirror">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: Cascode Current Mirror vs.&nbsp;High-Swing Cascode Current Mirror
</div>
</div>
<div class="callout-body-container callout-body">
<p>Try to verify the above statement of equal drain-source voltages by deriving both, an equation for <span class="math inline">\(V_\mathrm{DS5}\)</span> assuming a high-swing cascode current mirror (<a href="#fig-improved-ota" class="quarto-xref">Figure&nbsp;36</a>) and <span class="math inline">\(V_\mathrm{DS5}\)</span> in case of a simple cascode current mirror, where the reference branch <span class="math inline">\((M_\mathrm{6/6C})\)</span> is comprised of two mosfet diodes.</p>
</div>
</div>
<p>Further, by properly selecting the bias voltages of the cascode a low-voltage operation is achieved as <span class="math inline">\(V_\mathrm{DS}\)</span> can be minimized, allowing even triode operation of the current-mirror MOSFETs (as, noted above, a large <span class="math inline">\(g_\mathrm{ds}\)</span> is not a big issue).</p>
<p>A simplified small-signal gain calculation of this improved OTA uses the result of <a href="#eq-simple-ota-gain-dc" class="quarto-xref">Equation&nbsp;17</a> and <a href="#eq-cs-cascode-output-impedance" class="quarto-xref">Equation&nbsp;24</a> to arrive at the approximate dc gain of <span id="eq-improved-ota-gain-dc"><span class="math display">\[
A_0 \approx \frac{g_\mathrm{m12}}{g_\mathrm{ds2} \frac{g_\mathrm{ds2C}}{g_\mathrm{m2C}} + g_\mathrm{ds4} \frac{g_\mathrm{ds4C}}{g_\mathrm{m4C}}}
\tag{26}\]</span></span> leading to a significant boost in dc gain due to cascoding. We will use this increased gain to reduce the <span class="math inline">\(L\)</span> of all MOSFET to</p>
<ol type="1">
<li>save area (smaller <span class="math inline">\(L\)</span> will lead to smaller <span class="math inline">\(W\)</span> for a given <span class="math inline">\(W/L\)</span> ratio) and</li>
<li>will push the additional poles and zeros at the inner nodes of the cascode transistors (e.g., the connection of the drain of <span class="math inline">\(M_5\)</span> to the source of <span class="math inline">\(M_\mathrm{5C}\)</span>) to higher frequencies to result in stable behavior and a reasonable gain transfer function (too many poles and zeros in the pass band of the amplifier create many issues with stability margin).</li>
</ol>
<section id="sec-improved-ota-sizing" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="sec-improved-ota-sizing"><span class="header-section-number">10.1</span> Sizing the Improved OTA</h2>
<p>Like the sizing of the 5T-OTA in <a href="#sec-basic-ota-sizing" class="quarto-xref">Section&nbsp;8.4</a> we will again use the <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> method using a Python notebook. Instead of using <span class="math inline">\(L = 5\,\mu\text{m}\)</span> we will this time use a reduced <span class="math inline">\(L = 0.5\,\mu\text{m}\)</span> for <span class="math inline">\(M_\mathrm{1/1C,2/2C,3/3C,4/4C}\)</span> (for speed reasons) and <span class="math inline">\(L = 1\,\mu\text{m}\)</span> for <span class="math inline">\(M_\mathrm{5/5C,6/6C}\)</span> for better common-mode rejection (the tail current mirror is less critical in terms of speed and stability).</p>
<p>We set <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}= 13\)</span> across the board for a good trade-off between speed, current efficiency, and voltage headroom for the MOSFETs (this is now way more critical than in the basic 5T-OTA as we stack now double as many MOSFET at the same supply voltage). Please look at <a href="#sec-gmid-method" class="quarto-xref">Section&nbsp;3</a> to confirm this choice.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Improved OTA Sizing">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-48-contents" aria-controls="callout-48" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Improved OTA Sizing
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-48" class="callout-48-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<section id="sizing-for-basic-improved-ota" class="level1 unnumbered unlisted quarto-embed-nb-cell">
<h1 class="unnumbered unlisted">Sizing for Basic (Improved) OTA</h1>
<p><strong>Copyright 2024 Harald Pretl</strong></p>
<p>Licensed under the Apache License, Version 2.0 (the “License”); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0</p>
<div id="cell-1" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read table data</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pygmid <span class="im">import</span> Lookup <span class="im">as</span> lk</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>lv_nmos <span class="op">=</span> lk(<span class="st">'sg13_lv_nmos.mat'</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>lv_pmos <span class="op">=</span> lk(<span class="st">'sg13_lv_pmos.mat'</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># list of parameters: VGS, VDS, VSB, L, W, NFING, ID, VT, GM, GMB, GDS, CGG, CGB, CGD, CGS, CDD, CSS, STH, SFL</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># if not specified, minimum L, VDS=max(vgs)/2=0.9 and VSB=0 are used </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-2" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define the given parameters as taken from the specification table or initial guesses</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>c_load <span class="op">=</span> <span class="fl">50e-15</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>gm_id_m12 <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>gm_id_m12c <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>gm_id_m34 <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>gm_id_m34c <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>gm_id_m56 <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>gm_id_m56c <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>l_12 <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>l_12c <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>l_34 <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>l_34c <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>l_56 <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>l_56c <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>f_bw <span class="op">=</span> <span class="fl">10e6</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>i_total_limit <span class="op">=</span> <span class="fl">10e-6</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>i_bias_in <span class="op">=</span> <span class="fl">20e-6</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>output_voltage <span class="op">=</span> <span class="fl">1.3</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>vin_min <span class="op">=</span> <span class="fl">0.7</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>vin_max <span class="op">=</span> <span class="fl">0.9</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>vdd_min <span class="op">=</span> <span class="fl">1.45</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>vdd_max <span class="op">=</span> <span class="fl">1.55</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>vds_headroom <span class="op">=</span> <span class="fl">0.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-3" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we get the required gm of M1/2 from the bandwidth requirement</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we add a factor of 3 to allow for PVT variation plus additional MOSFET parasitic loading</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># we also add an additional factor of 2 to get more dc gain (and there is power still in the budget)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>gm_m12 <span class="op">=</span> f_bw <span class="op">*</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">4</span><span class="op">*</span>np.pi<span class="op">*</span>c_load <span class="op">*</span> <span class="dv">3</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'gm12 ='</span>, <span class="bu">round</span>(gm_m12<span class="op">/</span><span class="fl">1e-3</span>, <span class="dv">4</span>), <span class="st">'mS'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gm12 = 0.0565 mS</code></pre>
</div>
</div>
<div id="cell-4" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># since we know gm12 and the gmid we can calculate the bias current</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>id_m12 <span class="op">=</span> gm_m12 <span class="op">/</span> gm_id_m12</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>i_total <span class="op">=</span> <span class="dv">2</span><span class="op">*</span>id_m12</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'i_total (exact) ='</span>, <span class="bu">round</span>(i_total<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">1</span>), <span class="st">'µA'</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># we round to 0.5µA bias currents</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>i_total <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(i_total <span class="op">/</span> <span class="fl">1e-6</span> <span class="op">*</span> <span class="dv">2</span>) <span class="op">/</span> <span class="dv">2</span> <span class="op">*</span> <span class="fl">1e-6</span>, <span class="fl">0.5e-6</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># here is a manual override to set the current; we keep a reserve of 2µA for bias branch</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>i_total <span class="op">=</span> <span class="fl">8e-6</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>id_m12 <span class="op">=</span> i_total<span class="op">/</span><span class="dv">2</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'i_total (rounded) ='</span>, i_total<span class="op">/</span><span class="fl">1e-6</span>, <span class="st">'µA'</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> i_total <span class="op">&lt;</span> i_total_limit:</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[info] power consumption target is met!'</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'[info] power consumption target is NOT met!'</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>i_total (exact) = 8.7 µA
i_total (rounded) = 8.0 µA
[info] power consumption target is met!</code></pre>
</div>
</div>
<div id="cell-5" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we calculate the dc gain</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>gm_gds_m12 <span class="op">=</span> lv_nmos.lookup(<span class="st">'GM_GDS'</span>, GM_ID<span class="op">=</span>gm_id_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">2</span><span class="op">*</span>vds_headroom)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>gm_gds_m12c <span class="op">=</span> lv_nmos.lookup(<span class="st">'GM_GDS'</span>, GM_ID<span class="op">=</span>gm_id_m12c, L<span class="op">=</span>l_12c, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">3</span><span class="op">*</span>vds_headroom)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>gm_gds_m34 <span class="op">=</span> lv_pmos.lookup(<span class="st">'GM_GDS'</span>, GM_ID<span class="op">=</span>gm_id_m34, L<span class="op">=</span>l_34, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>gm_gds_m34c <span class="op">=</span> lv_pmos.lookup(<span class="st">'GM_GDS'</span>, GM_ID<span class="op">=</span>gm_id_m34c, L<span class="op">=</span>l_34c, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span>vds_headroom)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># conductance of lower cascoded differential pair</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>gds_m12 <span class="op">=</span> gm_m12 <span class="op">/</span> gm_gds_m12</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>gds_m12_casc <span class="op">=</span> gds_m12 <span class="op">/</span> gm_gds_m12c</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># conductance of upper cascoded current mirror</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>gm_m34 <span class="op">=</span> gm_id_m34 <span class="op">*</span> i_total<span class="op">/</span><span class="dv">2</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>gds_m34 <span class="op">=</span> gm_m34 <span class="op">/</span> gm_gds_m34</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>gds_m34_casc <span class="op">=</span> gds_m34 <span class="op">/</span> gm_gds_m34c</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'gds_12 ='</span>, <span class="bu">round</span>(gds_m12<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">3</span>), <span class="st">'µs'</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'gm_12c/gds_12c ='</span>,<span class="bu">round</span>(<span class="bu">float</span>(gm_gds_m12c), <span class="dv">1</span>))</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'gds_34 ='</span>, <span class="bu">round</span>(gds_m34<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">3</span>), <span class="st">'µs'</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'gm_34c/gds_34c ='</span>, <span class="bu">round</span>(<span class="bu">float</span>(gm_gds_m34c), <span class="dv">1</span>))</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>a0 <span class="op">=</span> gm_m12 <span class="op">/</span> (gds_m12_casc <span class="op">+</span> gds_m34_casc)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'a0 ='</span>, <span class="bu">round</span>(<span class="dv">20</span><span class="op">*</span>np.log10(a0), <span class="dv">1</span>), <span class="st">'dB'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gds_12 = 4.026 µs
gm_12c/gds_12c = 13.4
gds_34 = 2.031 µs
gm_34c/gds_34c = 24.9
a0 = 43.4 dB</code></pre>
</div>
</div>
<div id="cell-6" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we calculate the MOSFET capacitance which adds to Cload, to see the impact on the BW</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>gm_cgs_m12 <span class="op">=</span> lv_nmos.lookup(<span class="st">'GM_CGS'</span>, GM_ID<span class="op">=</span>gm_id_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">2</span><span class="op">*</span>vds_headroom)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>gm_cdd_m12c <span class="op">=</span> lv_nmos.lookup(<span class="st">'GM_CDD'</span>, GM_ID<span class="op">=</span>gm_id_m12c, L<span class="op">=</span>l_12c, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">3</span><span class="op">*</span>vds_headroom)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>gm_cdd_m34c <span class="op">=</span> lv_pmos.lookup(<span class="st">'GM_CDD'</span>, GM_ID<span class="op">=</span>gm_id_m34c, L<span class="op">=</span>l_34c, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span>vds_headroom)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>c_load_parasitic <span class="op">=</span> <span class="bu">abs</span>(gm_m12<span class="op">/</span>gm_cgs_m12) <span class="op">+</span> <span class="bu">abs</span>(gm_m12<span class="op">/</span>gm_cdd_m12c) <span class="op">+</span> <span class="bu">abs</span>(gm_m34<span class="op">/</span>gm_cdd_m34c)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'additional load capacitance ='</span>, <span class="bu">round</span>(c_load_parasitic<span class="op">/</span><span class="fl">1e-15</span>, <span class="dv">1</span>), <span class="st">'fF'</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>f_bw <span class="op">=</span> gm_m12 <span class="op">/</span> (<span class="dv">4</span><span class="op">*</span>np.pi <span class="op">*</span> (c_load <span class="op">+</span> c_load_parasitic))</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'-3dB bandwidth incl. parasitics ='</span>, <span class="bu">round</span>(f_bw<span class="op">/</span><span class="fl">1e6</span>, <span class="dv">2</span>), <span class="st">'MHz'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>additional load capacitance = 5.5 fF
-3dB bandwidth incl. parasitics = 81.15 MHz</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we can now look up the VGS of the MOSFET</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>vgs_m12 <span class="op">=</span> lv_nmos.look_upVGS(GM_ID<span class="op">=</span>gm_id_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">2</span><span class="op">*</span>vds_headroom)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>vgs_m12c <span class="op">=</span> lv_nmos.look_upVGS(GM_ID<span class="op">=</span>gm_id_m12c, L<span class="op">=</span>l_12c, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">3</span><span class="op">*</span>vds_headroom)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>vgs_m34 <span class="op">=</span> lv_pmos.look_upVGS(GM_ID<span class="op">=</span>gm_id_m34, L<span class="op">=</span>l_34, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="fl">0.0</span>) </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>vgs_m34c <span class="op">=</span> lv_pmos.look_upVGS(GM_ID<span class="op">=</span>gm_id_m34c, L<span class="op">=</span>l_34c, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span>vds_headroom) </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>vgs_m56 <span class="op">=</span> lv_nmos.look_upVGS(GM_ID<span class="op">=</span>gm_id_m56, L<span class="op">=</span>l_56, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="fl">0.0</span>) </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>vgs_m56c <span class="op">=</span> lv_nmos.look_upVGS(GM_ID<span class="op">=</span>gm_id_m56c, L<span class="op">=</span>l_56c, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span>vds_headroom) </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'vgs_12  ='</span>, <span class="bu">round</span>(<span class="bu">float</span>(vgs_m12), <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'vgs_12c ='</span>, <span class="bu">round</span>(<span class="bu">float</span>(vgs_m12c), <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'vgs_34  ='</span>, <span class="bu">round</span>(<span class="bu">float</span>(vgs_m34), <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'vgs_34c ='</span>, <span class="bu">round</span>(<span class="bu">float</span>(vgs_m34c), <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'vgs_56  ='</span>, <span class="bu">round</span>(<span class="bu">float</span>(vgs_m56), <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'vgs_56c ='</span>, <span class="bu">round</span>(<span class="bu">float</span>(vgs_m56c), <span class="dv">3</span>), <span class="st">'V'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>vgs_12  = 0.436 V
vgs_12c = 0.458 V
vgs_34  = 0.475 V
vgs_34c = 0.512 V
vgs_56  = 0.358 V
vgs_56c = 0.384 V</code></pre>
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate settling time due to slewing with the calculated bias current</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>t_slew <span class="op">=</span> (c_load <span class="op">+</span> c_load_parasitic) <span class="op">*</span> output_voltage <span class="op">/</span> i_total</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'slewing time  ='</span>, <span class="bu">round</span>(t_slew<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">3</span>), <span class="st">'µs'</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>t_settle <span class="op">=</span> <span class="dv">5</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>f_bw)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'settling time ='</span>, <span class="bu">round</span>(t_settle<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">3</span>), <span class="st">'µs'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>slewing time  = 0.009 µs
settling time = 0.01 µs</code></pre>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate voltage gain error</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>gain_error <span class="op">=</span> a0 <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> a0)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'voltage gain error ='</span>, <span class="bu">round</span>((gain_error<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="st">'%'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>voltage gain error = -0.7 %</code></pre>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate total rms output noise</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>sth_m12 <span class="op">=</span> lv_nmos.lookup(<span class="st">'STH_GM'</span>, VGS<span class="op">=</span>vgs_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">2</span><span class="op">*</span>vds_headroom) <span class="op">*</span> gm_m12</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>gamma_m12 <span class="op">=</span> sth_m12<span class="op">/</span>(<span class="dv">4</span><span class="op">*</span><span class="fl">1.38e-23</span><span class="op">*</span><span class="dv">300</span><span class="op">*</span>gm_m12)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>sth_m34 <span class="op">=</span> lv_pmos.lookup(<span class="st">'STH_GM'</span>, VGS<span class="op">=</span>vgs_m34, L<span class="op">=</span>l_34, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">0</span>) <span class="op">*</span> gm_m34</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>gamma_m34 <span class="op">=</span> sth_m34<span class="op">/</span>(<span class="dv">4</span><span class="op">*</span><span class="fl">1.38e-23</span><span class="op">*</span><span class="dv">300</span><span class="op">*</span>gm_m34)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>output_noise_rms <span class="op">=</span> <span class="fl">1.38e-23</span><span class="op">*</span><span class="dv">300</span> <span class="op">/</span> (c_load <span class="op">+</span> c_load_parasitic) <span class="op">*</span> (<span class="dv">2</span><span class="op">*</span>gamma_m12 <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>gamma_m34 <span class="op">*</span> gm_m34<span class="op">/</span>gm_m12)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'output noise (rms) ='</span>, <span class="bu">round</span>(output_noise_rms<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">3</span>), <span class="st">'µV'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>output noise (rms) = 0.308 µV</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate all widths</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>id_w_m12 <span class="op">=</span> lv_nmos.lookup(<span class="st">'ID_W'</span>, GM_ID<span class="op">=</span>gm_id_m12, L<span class="op">=</span>l_12, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">2</span><span class="op">*</span>vds_headroom)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>w_12 <span class="op">=</span> id_m12 <span class="op">/</span> id_w_m12</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>w_12_round <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(w_12<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="fl">0.5</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M1/2  W ='</span>, <span class="bu">round</span>(w_12, <span class="dv">2</span>), <span class="st">'um, rounded W ='</span>, w_12_round, <span class="st">'um'</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>id_m12c <span class="op">=</span> id_m12</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>id_w_m12c <span class="op">=</span> lv_nmos.lookup(<span class="st">'ID_W'</span>, GM_ID<span class="op">=</span>gm_id_m12c, L<span class="op">=</span>l_12c, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">3</span><span class="op">*</span>vds_headroom)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>w_12c <span class="op">=</span> id_m12c <span class="op">/</span> id_w_m12c</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>w_12c_round <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(w_12c<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="fl">0.5</span>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M1/2c W ='</span>, <span class="bu">round</span>(w_12c, <span class="dv">2</span>), <span class="st">'um, rounded W ='</span>, w_12c_round, <span class="st">'um'</span>)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>id_m34 <span class="op">=</span> id_m12</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>id_w_m34 <span class="op">=</span> lv_pmos.lookup(<span class="st">'ID_W'</span>, GM_ID<span class="op">=</span>gm_id_m34, L<span class="op">=</span>l_34, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>w_34 <span class="op">=</span> id_m34 <span class="op">/</span> id_w_m34</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>w_34_round <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(w_34<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="fl">0.5</span>) </span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M3/4  W ='</span>, <span class="bu">round</span>(w_34, <span class="dv">2</span>), <span class="st">'um, rounded W ='</span>, w_34_round, <span class="st">'um'</span>)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>id_m34c <span class="op">=</span> id_m12</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>id_w_m34c <span class="op">=</span> lv_pmos.lookup(<span class="st">'ID_W'</span>, GM_ID<span class="op">=</span>gm_id_m34c, L<span class="op">=</span>l_34c, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span>vds_headroom)</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>w_34c <span class="op">=</span> id_m34c <span class="op">/</span> id_w_m34c</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>w_34c_round <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(w_34c<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="fl">0.5</span>) </span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M3/4c W ='</span>, <span class="bu">round</span>(w_34c, <span class="dv">2</span>), <span class="st">'um, rounded W ='</span>, w_34c_round, <span class="st">'um'</span>)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>id_w_m5 <span class="op">=</span> lv_nmos.lookup(<span class="st">'ID_W'</span>, GM_ID<span class="op">=</span>gm_id_m56, L<span class="op">=</span>l_56, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>w_5 <span class="op">=</span> i_total <span class="op">/</span> id_w_m5</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>w_5_round <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(w_5<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="fl">0.5</span>)</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M5    W ='</span>, <span class="bu">round</span>(w_5, <span class="dv">2</span>), <span class="st">'um, rounded W ='</span>, w_5_round, <span class="st">'um'</span>)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>id_w_m5c <span class="op">=</span> lv_nmos.lookup(<span class="st">'ID_W'</span>, GM_ID<span class="op">=</span>gm_id_m56c, L<span class="op">=</span>l_56c, VDS<span class="op">=</span>vds_headroom, VSB<span class="op">=</span>vds_headroom)</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>w_5c <span class="op">=</span> i_total <span class="op">/</span> id_w_m5c</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>w_5c_round <span class="op">=</span> <span class="bu">max</span>(<span class="bu">round</span>(w_5c<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="fl">0.5</span>)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M5c   W ='</span>, <span class="bu">round</span>(w_5c, <span class="dv">2</span>), <span class="st">'um, rounded W ='</span>, w_5c_round, <span class="st">'um'</span>)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>w_6 <span class="op">=</span> w_5_round <span class="op">*</span> i_bias_in <span class="op">/</span> i_total</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M6    W ='</span>, <span class="bu">round</span>(w_6, <span class="dv">2</span>), <span class="st">'um'</span>)</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>w_6c <span class="op">=</span> w_5c_round <span class="op">*</span> i_bias_in <span class="op">/</span> i_total</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M6c   W ='</span>, <span class="bu">round</span>(w_6c, <span class="dv">2</span>), <span class="st">'um'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>M1/2  W = 0.83 um, rounded W = 1.0 um
M1/2c W = 0.8 um, rounded W = 1.0 um
M3/4  W = 3.28 um, rounded W = 3.5 um
M3/4c W = 2.99 um, rounded W = 3.0 um
M5    W = 3.05 um, rounded W = 3.0 um
M5c   W = 2.87 um, rounded W = 3.0 um
M6    W = 7.5 um
M6c   W = 7.5 um</code></pre>
</div>
</div>
<div id="cell-12" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out final design values</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Improved OTA dimensioning:'</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'--------------------------'</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M1/2  W='</span>, w_12_round, <span class="st">', L='</span>, l_12)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M1/2c W='</span>, w_12c_round, <span class="st">', L='</span>, l_12c)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M3/4  W='</span>, w_34_round, <span class="st">', L='</span>, l_34)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M3/4c W='</span>, w_34c_round, <span class="st">', L='</span>, l_34c)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M5   W='</span>, w_5_round, <span class="st">', L='</span>, l_56)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M5c  W='</span>, w_5c_round, <span class="st">', L='</span>, l_56c)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M6   W='</span>, <span class="bu">round</span>(w_6, <span class="dv">2</span>), <span class="st">', L='</span>, l_56)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'M6c  W='</span>, <span class="bu">round</span>(w_6c, <span class="dv">2</span>), <span class="st">', L='</span>, l_56c)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Improved OTA performance summary:'</span>)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'---------------------------------'</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'supply current ='</span>, <span class="bu">round</span>(i_total<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">1</span>), <span class="st">'µA'</span>)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'output noise ='</span>, <span class="bu">round</span>(output_noise_rms<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">3</span>), <span class="st">'µVrms'</span>)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'voltage gain error ='</span>, <span class="bu">round</span>((gain_error<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="st">'%'</span>)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'-3dB bandwidth incl. parasitics ='</span>, <span class="bu">round</span>(f_bw<span class="op">/</span><span class="fl">1e6</span>, <span class="dv">2</span>), <span class="st">'MHz'</span>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'turn-on time (slewing+settling) ='</span>, <span class="bu">round</span>((t_slew<span class="op">+</span>t_settle)<span class="op">/</span><span class="fl">1e-6</span>, <span class="dv">3</span>), <span class="st">'µs'</span>)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Improved OTA bias point check:'</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'------------------------------'</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'headroom M1+M1c ='</span>, <span class="bu">round</span>(vdd_min<span class="op">-</span>vgs_m34<span class="op">+</span>vgs_m12<span class="op">-</span>vin_max, <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'headroom M4+M4c ='</span>, <span class="bu">round</span>(vdd_min<span class="op">-</span>vin_max, <span class="dv">3</span>), <span class="st">'V'</span>)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'headroom M5+M5c ='</span>, <span class="bu">round</span>(vin_min<span class="op">-</span>vgs_m12, <span class="dv">3</span>), <span class="st">'V'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Improved OTA dimensioning:
--------------------------
M1/2  W= 1.0 , L= 0.5
M1/2c W= 1.0 , L= 0.5
M3/4  W= 3.5 , L= 0.5
M3/4c W= 3.0 , L= 0.5
M5   W= 3.0 , L= 1
M5c  W= 3.0 , L= 1
M6   W= 7.5 , L= 1
M6c  W= 7.5 , L= 1

Improved OTA performance summary:
---------------------------------
supply current = 8.0 µA
output noise = 0.308 µVrms
voltage gain error = -0.7 %
-3dB bandwidth incl. parasitics = 81.15 MHz
turn-on time (slewing+settling) = 0.019 µs

Improved OTA bias point check:
------------------------------
headroom M1+M1c = 0.512 V
headroom M4+M4c = 0.55 V
headroom M5+M5c = 0.264 V</code></pre>
</div>
</div>
</section>
</div>
</div>
</div>
<p>Looking at this sizing result we see that we achieve an improved <span class="math inline">\(A0 &gt; 43\,\text{dB}\)</span> while meeting also the other performance requirements of <a href="#tbl-voltage-buffer-spec" class="quarto-xref">Table&nbsp;2</a> with margin. In addition, we check the voltage headroom of the critical MOSFET to see if we can squeeze it into the available supply voltage range, and see that this is possible with our above choice selection of parameters.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: Improved OTA Sizing">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: Improved OTA Sizing
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please take a detailed look at the above sizing notebook and play with the numbers and calculations. Do you find a better trade-off for the input parameters? Can you understand the ratio behind the choices and calculations?</p>
</div>
</div>
</section>
<section id="designing-the-improved-ota" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="designing-the-improved-ota"><span class="header-section-number">10.2</span> Designing the Improved OTA</h2>
<p>Based on the collected experience in this lecture and the result of the sizing procedure in <a href="#sec-improved-ota-sizing" class="quarto-xref">Section&nbsp;10.1</a> you should be able to design this OTA. If you want, please go ahead and try an implementation and check its performance with CACE.</p>
<p>As an alternative there is a prepared OTA design shown in <a href="#fig-improved-ota-design" class="quarto-xref">Figure&nbsp;37</a> which we will discuss in detail next.</p>
<div id="fig-improved-ota-design" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-improved-ota-design-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/ota-improved.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-69" title="Figure&nbsp;37: Improved OTA design in Xschem."><img src="./xschem/ota-improved.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-improved-ota-design-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;37: Improved OTA design in Xschem.
</figcaption>
</figure>
</div>
<section id="discussion-of-the-ota-design" class="level3" data-number="10.2.1">
<h3 data-number="10.2.1" class="anchored" data-anchor-id="discussion-of-the-ota-design"><span class="header-section-number">10.2.1</span> Discussion of the OTA Design</h3>
<p>We will now do an analysis of the circuit design of the OTA including all the complications which make this design practical.</p>
<ol type="1">
<li>For easier navigation, the device identifier are consistent with the circuit sketch in <a href="#fig-improved-ota" class="quarto-xref">Figure&nbsp;36</a>.</li>
<li>Some MOSFET dimensions are rounded to make a better fit in IC layout. Please also look carefully at <span class="math inline">\(W\)</span>, <span class="math inline">\(L\)</span>, and <span class="math inline">\(\mathrm{ng}\)</span>. The parameter <span class="math inline">\(\mathrm{ng}\)</span> sets how the total <span class="math inline">\(W\)</span> of a MOSFET should be split into individual MOSFET fingers with <span class="math inline">\(W_\mathrm{f} = W / \mathrm{ng}\)</span>. This is done to arrive at a suitably sized MOSFET physical implementation. As we will not deal with IC layout in this lecture we will leave it at that.</li>
<li>In order to allow good matching in the IC layout, MOSFETs (and other components) have to be constructed from equal pieces. To that end, <span class="math inline">\(W/L\)</span> scaling is done using unit elements (see finger width <span class="math inline">\(W_\mathrm{f}\)</span>). Sometimes, besides <span class="math inline">\(W\)</span> the length <span class="math inline">\(L\)</span> has to be scaled, and this leads to the oddly-looking series stacking of some MOSFET (easily recognizable by the connected gates). In order to increase circuit readability, a subcircuit could be constructed hiding this series stacking of MOSFET, but it is sometimes easier to avoid subcircuits. There is a fine line in this trade, sometime a depth of 4 is the decision point between subcircuit use/no-use.</li>
<li>As you can (hopefully) see the circuit is carefully drawn to ease readability. Important nets are named, text comments state certain properties like nominal voltage levels, bias currents, etc. Current sensing elements are added to directly see the dc currents in the circuit simulation.</li>
<li>The bias voltage generation for the cascodes is included as well. The voltage drop for the bottom transistors is developed across a resistor (this is a simple but effective way, but other implementations are possible as well). We are using a dummy branch for bias generation (constructed with <span class="math inline">\(M_\mathrm{7/7C,8/8C}\)</span> and <span class="math inline">\(R_3\)</span>).</li>
<li>The floating bias voltage <span class="math inline">\(V_\mathrm{bias2}\)</span> is created by implementing a current source from <span class="math inline">\(V_\mathrm{DD}\)</span> (<span class="math inline">\(M_\mathrm{9/9C}\)</span>), then a MOSFET diode <span class="math inline">\(M_{11}\)</span> with resistor <span class="math inline">\(R_4\)</span>, and an additional current source towards <span class="math inline">\(V_\mathrm{SS}\)</span> (<span class="math inline">\(M_\mathrm{10/10C}\)</span>). Instead of using the bottom current source the current in the tail current source <span class="math inline">\(M_\mathrm{5/5C}\)</span> could have been increased, but matching is better with the chosen approach.</li>
<li>Power-down transistors <span class="math inline">\(M_{\mathrm{pd,}x}\)</span> are added to allow a proper shutdown of the circuit with a digital enable input. It is generally a good idea to clamp floating nodes in off-mode so that no issues during power-down (like increased leakage currents) or delayed startup or shutdown are occurring. It is further a good design principle to buffer all incoming digital signals with inverters connected to the local supply. This lowers the risk of unwanted noise coupling or excessive slew rates on the incoming digital signals.</li>
<li>Sensitive bias nodes are buffered with decoupling capacitors. We are using MOSFET as nonlinear capacitors, which is not an issue in this application, but we value the increased capacitive density. Please note how the MOSFET are connected (to <span class="math inline">\(V_\mathrm{DD}\)</span>? or to <span class="math inline">\(V_\mathrm{SS}\)</span>?).</li>
</ol>
<p>The resistor used in this circuit are subcircuits to allow series connection of unit resistor elements. The schematic of one element is shown in <a href="#fig-improved-ota-design-res" class="quarto-xref">Figure&nbsp;38</a>. It is using an effective method to create a series string of connected resistors using wire bundles. Try to understand the circuit, consult the Xschem manual, and look at the resulting SPICE netlist to confirm your finding.</p>
<div id="fig-improved-ota-design-res" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-improved-ota-design-res-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/ota-improved-res-4.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-70" title="Figure&nbsp;38: Series resistor implementation used in the improved OTA design."><img src="./xschem/ota-improved-res-4.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-improved-ota-design-res-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;38: Series resistor implementation used in the improved OTA design.
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Parallel Connection">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Parallel Connection
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that a parallel connection of devices is effectively possible using the multiplier notation of Xschem.</p>
</div>
</div>
</section>
</section>
<section id="simulation-of-improved-ota" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="simulation-of-improved-ota"><span class="header-section-number">10.3</span> Simulation of Improved OTA</h2>
<p>Now that the circuit design of the improved OTA is done, we an use the same simulation test bench as for the basic OTA. The testbench is shown in <a href="#fig-improved-ota-design-tb-ac" class="quarto-xref">Figure&nbsp;39</a> and <a href="#fig-improved-ota-design-tb-tran" class="quarto-xref">Figure&nbsp;40</a>.</p>
<div id="fig-improved-ota-design-tb-ac" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-improved-ota-design-tb-ac-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/ota-improved_tb-ac.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-71" title="Figure&nbsp;39: Simulation testbench of the improved OTA design (small-signal)."><img src="./xschem/ota-improved_tb-ac.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-improved-ota-design-tb-ac-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;39: Simulation testbench of the improved OTA design (small-signal).
</figcaption>
</figure>
</div>
<div id="fig-improved-ota-design-tb-tran" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-improved-ota-design-tb-tran-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="./xschem/ota-improved_tb-tran.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-72" title="Figure&nbsp;40: Simulation testbench of the improved OTA design (large-signal)."><img src="./xschem/ota-improved_tb-tran.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-improved-ota-design-tb-tran-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;40: Simulation testbench of the improved OTA design (large-signal).
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise: Improved OTA Initial Simulation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: Improved OTA Initial Simulation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please use the above testbenches to simulate the improved OTA:</p>
<ol type="1">
<li>Check the dc bias points. Are they good? How stable are they across PVT variations?</li>
<li>What are the small-signal parameters like gain, noise and bandwidth? Are they fitting the specification?</li>
<li>What is large-signal performance? Is the settling fast enough? Is the settling well behaved, i.e., are there overshoots or other strange ringing indicating potential stability issues?</li>
<li>Try to improve the design. Change various device parameters and see what happens. Whenever you change something, check the dc operating point first. If the dc operating point is not good no further simulations make sense.</li>
</ol>
</div>
</div>
</section>
<section id="corner-simulation-of-improved-ota" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="corner-simulation-of-improved-ota"><span class="header-section-number">10.4</span> Corner Simulation of Improved OTA</h2>
<p>Just like for the basic OTA we use the CACE system to check the performance of the improved OTA design holistically across variations like PVT and input signal variations. The results of the CACE run are shown below in <a href="#nte-improved-ota-cace-result" class="quarto-xref">Note&nbsp;3</a>.</p>
<div id="nte-improved-ota-cace-result" class="callout callout-style-default callout-note callout-titled" title="CACE Summary for Improved OTA">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-52-contents" aria-controls="callout-52" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;3: CACE Summary for Improved OTA
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-52" class="callout-52-contents callout-collapse collapse show">
<section id="cace-summary-for-ota-improved" class="level1 unnumbered unlisted callout-body-container callout-body">
<h1 class="unnumbered unlisted">CACE Summary for ota-improved</h1>
<p><strong>netlist source</strong>: schematic</p>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 11%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Tool</th>
<th style="text-align: left;">Result</th>
<th style="text-align: right;">Min Limit</th>
<th style="text-align: right;">Min Value</th>
<th style="text-align: right;">Typ Target</th>
<th style="text-align: right;">Typ Value</th>
<th style="text-align: right;">Max Limit</th>
<th style="text-align: right;">Max Value</th>
<th style="text-align: center;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Output voltage ratio</td>
<td style="text-align: left;">ngspice</td>
<td style="text-align: left;">gain</td>
<td style="text-align: right;">0.99 V/V</td>
<td style="text-align: right;">1.000 V/V</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">1.001 V/V</td>
<td style="text-align: right;">1.01 V/V</td>
<td style="text-align: right;">1.009 V/V</td>
<td style="text-align: center;">Pass ✅</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bandwidth</td>
<td style="text-align: left;">ngspice</td>
<td style="text-align: left;">bw</td>
<td style="text-align: right;">10e6 Hz</td>
<td style="text-align: right;">107908000.000 Hz</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">226025000.000 Hz</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">292975000.000 Hz</td>
<td style="text-align: center;">Pass ✅</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Output noise</td>
<td style="text-align: left;">ngspice</td>
<td style="text-align: left;">noise</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">0.346 mV</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">0.407 mV</td>
<td style="text-align: right;">1 mV</td>
<td style="text-align: right;">0.497 mV</td>
<td style="text-align: center;">Pass ✅</td>
</tr>
<tr class="even">
<td style="text-align: left;">Settling time</td>
<td style="text-align: left;">ngspice</td>
<td style="text-align: left;">tsettle</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">0.196 us</td>
<td style="text-align: right;">any</td>
<td style="text-align: right;">0.212 us</td>
<td style="text-align: right;">5 us</td>
<td style="text-align: right;">0.226 us</td>
<td style="text-align: center;">Pass ✅</td>
</tr>
</tbody>
</table>
<section id="plots-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="plots-1">Plots</h2>
</section>
<section id="gain_vs_temp-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="gain_vs_temp-1">gain_vs_temp</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/gain_vs_temp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-73" title="gain_vs_temp"><img src="./cace/_docs/ota-improved/schematic/gain_vs_temp.png" class="img-fluid figure-img" alt="gain_vs_temp"></a></p>
<figcaption>gain_vs_temp</figcaption>
</figure>
</div>
</section>
<section id="gain_vs_vin-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="gain_vs_vin-1">gain_vs_vin</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/gain_vs_vin.png" class="lightbox" data-gallery="quarto-lightbox-gallery-74" title="gain_vs_vin"><img src="./cace/_docs/ota-improved/schematic/gain_vs_vin.png" class="img-fluid figure-img" alt="gain_vs_vin"></a></p>
<figcaption>gain_vs_vin</figcaption>
</figure>
</div>
</section>
<section id="gain_vs_vdd-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="gain_vs_vdd-1">gain_vs_vdd</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/gain_vs_vdd.png" class="lightbox" data-gallery="quarto-lightbox-gallery-75" title="gain_vs_vdd"><img src="./cace/_docs/ota-improved/schematic/gain_vs_vdd.png" class="img-fluid figure-img" alt="gain_vs_vdd"></a></p>
<figcaption>gain_vs_vdd</figcaption>
</figure>
</div>
</section>
<section id="gain_vs_corner-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="gain_vs_corner-1">gain_vs_corner</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/gain_vs_corner.png" class="lightbox" data-gallery="quarto-lightbox-gallery-76" title="gain_vs_corner"><img src="./cace/_docs/ota-improved/schematic/gain_vs_corner.png" class="img-fluid figure-img" alt="gain_vs_corner"></a></p>
<figcaption>gain_vs_corner</figcaption>
</figure>
</div>
</section>
<section id="bw_vs_temp-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="bw_vs_temp-1">bw_vs_temp</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/bw_vs_temp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-77" title="bw_vs_temp"><img src="./cace/_docs/ota-improved/schematic/bw_vs_temp.png" class="img-fluid figure-img" alt="bw_vs_temp"></a></p>
<figcaption>bw_vs_temp</figcaption>
</figure>
</div>
</section>
<section id="bw_vs_vin-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="bw_vs_vin-1">bw_vs_vin</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/bw_vs_vin.png" class="lightbox" data-gallery="quarto-lightbox-gallery-78" title="bw_vs_vin"><img src="./cace/_docs/ota-improved/schematic/bw_vs_vin.png" class="img-fluid figure-img" alt="bw_vs_vin"></a></p>
<figcaption>bw_vs_vin</figcaption>
</figure>
</div>
</section>
<section id="bw_vs_vdd-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="bw_vs_vdd-1">bw_vs_vdd</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/bw_vs_vdd.png" class="lightbox" data-gallery="quarto-lightbox-gallery-79" title="bw_vs_vdd"><img src="./cace/_docs/ota-improved/schematic/bw_vs_vdd.png" class="img-fluid figure-img" alt="bw_vs_vdd"></a></p>
<figcaption>bw_vs_vdd</figcaption>
</figure>
</div>
</section>
<section id="bw_vs_corner-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="bw_vs_corner-1">bw_vs_corner</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/bw_vs_corner.png" class="lightbox" data-gallery="quarto-lightbox-gallery-80" title="bw_vs_corner"><img src="./cace/_docs/ota-improved/schematic/bw_vs_corner.png" class="img-fluid figure-img" alt="bw_vs_corner"></a></p>
<figcaption>bw_vs_corner</figcaption>
</figure>
</div>
</section>
<section id="noise_vs_temp-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="noise_vs_temp-1">noise_vs_temp</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/noise_vs_temp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-81" title="noise_vs_temp"><img src="./cace/_docs/ota-improved/schematic/noise_vs_temp.png" class="img-fluid figure-img" alt="noise_vs_temp"></a></p>
<figcaption>noise_vs_temp</figcaption>
</figure>
</div>
</section>
<section id="noise_vs_vin-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="noise_vs_vin-1">noise_vs_vin</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/noise_vs_vin.png" class="lightbox" data-gallery="quarto-lightbox-gallery-82" title="noise_vs_vin"><img src="./cace/_docs/ota-improved/schematic/noise_vs_vin.png" class="img-fluid figure-img" alt="noise_vs_vin"></a></p>
<figcaption>noise_vs_vin</figcaption>
</figure>
</div>
</section>
<section id="noise_vs_vdd-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="noise_vs_vdd-1">noise_vs_vdd</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/noise_vs_vdd.png" class="lightbox" data-gallery="quarto-lightbox-gallery-83" title="noise_vs_vdd"><img src="./cace/_docs/ota-improved/schematic/noise_vs_vdd.png" class="img-fluid figure-img" alt="noise_vs_vdd"></a></p>
<figcaption>noise_vs_vdd</figcaption>
</figure>
</div>
</section>
<section id="noise_vs_corner-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="noise_vs_corner-1">noise_vs_corner</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/noise_vs_corner.png" class="lightbox" data-gallery="quarto-lightbox-gallery-84" title="noise_vs_corner"><img src="./cace/_docs/ota-improved/schematic/noise_vs_corner.png" class="img-fluid figure-img" alt="noise_vs_corner"></a></p>
<figcaption>noise_vs_corner</figcaption>
</figure>
</div>
</section>
<section id="settling_vs_temp-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="settling_vs_temp-1">settling_vs_temp</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/settling_vs_temp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-85" title="settling_vs_temp"><img src="./cace/_docs/ota-improved/schematic/settling_vs_temp.png" class="img-fluid figure-img" alt="settling_vs_temp"></a></p>
<figcaption>settling_vs_temp</figcaption>
</figure>
</div>
</section>
<section id="settling_vs_vin-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="settling_vs_vin-1">settling_vs_vin</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/settling_vs_vin.png" class="lightbox" data-gallery="quarto-lightbox-gallery-86" title="settling_vs_vin"><img src="./cace/_docs/ota-improved/schematic/settling_vs_vin.png" class="img-fluid figure-img" alt="settling_vs_vin"></a></p>
<figcaption>settling_vs_vin</figcaption>
</figure>
</div>
</section>
<section id="settling_vs_vdd-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="settling_vs_vdd-1">settling_vs_vdd</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/settling_vs_vdd.png" class="lightbox" data-gallery="quarto-lightbox-gallery-87" title="settling_vs_vdd"><img src="./cace/_docs/ota-improved/schematic/settling_vs_vdd.png" class="img-fluid figure-img" alt="settling_vs_vdd"></a></p>
<figcaption>settling_vs_vdd</figcaption>
</figure>
</div>
</section>
<section id="settling_vs_corner-1" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="settling_vs_corner-1">settling_vs_corner</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./cace/_docs/ota-improved/schematic/settling_vs_corner.png" class="lightbox" data-gallery="quarto-lightbox-gallery-88" title="settling_vs_corner"><img src="./cace/_docs/ota-improved/schematic/settling_vs_corner.png" class="img-fluid figure-img" alt="settling_vs_corner"></a></p>
<figcaption>settling_vs_corner</figcaption>
</figure>
</div>
</section>
</section>
</div>
</div>
<p>The improved performance allows to improve the specifications in a few important points, notably the output voltage tolerance which is an important metric for a reference voltage buffer. We have intentionally increased the power consumption a little bit, but we negotiated with the chip lead designer a changed bias current level, so overall the situation is even slightly improved. The new situation with the improved design is summarized in <a href="#tbl-voltage-buffer-spec-improved" class="quarto-xref">Table&nbsp;3</a> (unchanged entries are not shown).</p>
<div id="tbl-voltage-buffer-spec-improved" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-voltage-buffer-spec-improved-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Voltage buffer specification
</figcaption>
<div aria-describedby="tbl-voltage-buffer-spec-improved-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 54%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Specification</th>
<th style="text-align: center;">Basic 5T-OTA</th>
<th style="text-align: center;">Improved OTA</th>
<th style="text-align: center;">Unit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Output voltage error</td>
<td style="text-align: center;"><span class="math inline">\(&lt;3\)</span></td>
<td style="text-align: center;"><span class="math inline">\(&lt;1\)</span></td>
<td style="text-align: center;">%</td>
</tr>
<tr class="even">
<td style="text-align: left;">Total output noise (rms)</td>
<td style="text-align: center;"><span class="math inline">\(&lt;1\)</span></td>
<td style="text-align: center;"><span class="math inline">\(&lt;0.5\)</span></td>
<td style="text-align: center;">mV<sub>rms</sub></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Supply current (as low as possible)</td>
<td style="text-align: center;"><span class="math inline">\(&lt;10\)</span></td>
<td style="text-align: center;"><span class="math inline">\(&lt;20\)</span></td>
<td style="text-align: center;">µA</td>
</tr>
<tr class="even">
<td style="text-align: left;">Turn-on time (settled to with 1%)</td>
<td style="text-align: center;"><span class="math inline">\(&lt;10\)</span></td>
<td style="text-align: center;"><span class="math inline">\(&lt;1\)</span></td>
<td style="text-align: center;">µs</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Externally provided bias current (nominal)</td>
<td style="text-align: center;"><span class="math inline">\(20\)</span></td>
<td style="text-align: center;"><span class="math inline">\(5\)</span></td>
<td style="text-align: center;">µA</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
</section>
<section id="a-fully-differential-ota" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> A Fully-Differential OTA</h1>
<p>To be added in a future release.</p>
</section>
<section id="biasing-the-ota" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Biasing the OTA</h1>
<p>To be added in a future release.</p>
</section>
<section id="an-rc-opamp-filter" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> An RC-OPAMP Filter</h1>
<p>To be added in a future release.</p>
</section>
<section id="summary-conclusion" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> Summary &amp; Conclusion</h1>
<p>By now, you should be familiar with the use of a schematic entry tool (Xschem) and circuit simulator (ngspice). You have learned the basic performance trade-offs, and the large- and small-signal behavior of the MOSFET. You can use the <span class="math inline">\(g_\mathrm{m}/I_\mathrm{D}\)</span> method to size MOSFET for class-A operation. You can design simple amplifiers based on OTA structures. In summary, you are on a good way to become a good analog or mixed-signal circuit designer!</p>
<div class="callout callout-style-default callout-important callout-titled" title="Feedback">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Feedback
</div>
</div>
<div class="callout-body-container callout-body">
<p>We hope you have enjoyed these lecture notes! If you have feedback, suggestions, additions, or corrections, please send us an e-mail, create a GitHub issue, or provide a GitHub pull request. Thank you in advance for your contributions!</p>
</div>
</div>
</section>
<section id="sec-middlebrook-method" class="level1" data-number="15">
<h1 data-number="15"><span class="header-section-number">15</span> Appendix: Middlebrook’s Method</h1>
<p>When we want to do a closed-loop gain analysis (for stability or other investigations), we have the need to break the loop at one point, apply a stimulus, and monitor the response on the other end. By doing this we want to keep the loading on both ends similar to the original case. To achieve this, we break the loop at one point by inserting (1) an ac voltage source, and (2) attach an ac current source, as shown in <a href="#fig-middlebrook-voltage" class="quarto-xref">Figure&nbsp;41</a> and <a href="#fig-middlebrook-current" class="quarto-xref">Figure&nbsp;42</a>. The derivation of this approach is presented in <span class="citation" data-cites="Middlebrook_1975">(<a href="#ref-Middlebrook_1975" role="doc-biblioref">Middlebrook 1975</a>)</span>, and has the big advantage that loading is not changed, and the bias points are also correct.</p>
<div id="cell-fig-middlebrook-voltage" class="cell" data-execution_count="30">
<div class="cell-output cell-output-display">
<div id="fig-middlebrook-voltage" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-middlebrook-voltage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-middlebrook-voltage-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-89" title="Figure&nbsp;41: Middlebrook voltage loop gain simulation."><img src="index_files/figure-html/fig-middlebrook-voltage-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-middlebrook-voltage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41: Middlebrook voltage loop gain simulation.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-middlebrook-current" class="cell" data-execution_count="31">
<div class="cell-output cell-output-display">
<div id="fig-middlebrook-current" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-middlebrook-current-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-middlebrook-current-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-90" title="Figure&nbsp;42: Middlebrook current loop gain simulation."><img src="index_files/figure-html/fig-middlebrook-current-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-middlebrook-current-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;42: Middlebrook current loop gain simulation.
</figcaption>
</figure>
</div>
</div>
</div>
<p>For both cases we do an ac analysis, and find the corresponding transfer functions <span class="math inline">\(T_\mathrm{v}\)</span> and <span class="math inline">\(T_\mathrm{i}\)</span> as <span class="math display">\[
T_\mathrm{v} = -\frac{V_\mathrm{r}}{V_\mathrm{f}}
\]</span> and <span class="math display">\[
T_\mathrm{i} = -\frac{I_\mathrm{r}}{I_\mathrm{f}}.
\]</span></p>
<p>Then, we can calculate the closed-loop transfer function <span class="math inline">\(T(s) = H_\mathrm{ol(s)}\)</span> as <span class="math display">\[
T(s) = \frac{T_\mathrm{v} T_\mathrm{i} - 1}{T_\mathrm{v} + T_\mathrm{i} + 2}.
\]</span></p>
</section>
<section id="sec-miller-theorem" class="level1" data-number="16">
<h1 data-number="16"><span class="header-section-number">16</span> Appendix: Miller’s Theorem</h1>
<p>Using Miller’s theorem we can find the equivalent circuit of an impedance connected between two nodes, and we know the transfer function between these nodes. The given situation is shown in <a href="#fig-miller-theorem" class="quarto-xref">Figure&nbsp;43</a>, and the equivalent circuit is shown in <a href="#fig-miller-theorem-equivalent" class="quarto-xref">Figure&nbsp;44</a>.</p>
<div id="cell-fig-miller-theorem" class="cell" data-execution_count="32">
<div class="cell-output cell-output-display">
<div id="fig-miller-theorem" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-miller-theorem-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-miller-theorem-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-91" title="Figure&nbsp;43: An impedance connected between two nodes A and B."><img src="index_files/figure-html/fig-miller-theorem-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-miller-theorem-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;43: An impedance connected between two nodes A and B.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-miller-theorem-equivalent" class="cell" data-execution_count="33">
<div class="cell-output cell-output-display">
<div id="fig-miller-theorem-equivalent" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-miller-theorem-equivalent-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-miller-theorem-equivalent-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-92" title="Figure&nbsp;44: An equivalent circuit using Miller’s theorem."><img src="index_files/figure-html/fig-miller-theorem-equivalent-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-miller-theorem-equivalent-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;44: An equivalent circuit using Miller’s theorem.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Using Miller’s theorem <span class="citation" data-cites="Sheikholeslami_2015">(<a href="#ref-Sheikholeslami_2015" role="doc-biblioref">Sheikholeslami 2015</a>)</span> we can calculate <span class="math display">\[
Z_1 = \frac{Z}{1 - A} = \frac{Z}{1 - V_\mathrm{B} / V_\mathrm{A}}
\]</span> and <span class="math display">\[
Z_2 = \frac{Z}{1 - A^{-1}} = \frac{Z}{1 - V_\mathrm{A} / V_\mathrm{B}}
\]</span> to arrive at an equivalent circuit, given that <span class="math inline">\(A = V_\mathrm{B} / V_\mathrm{A}\)</span> is the voltage gain between nodes A and B. A derivation of this theorem is relative straightforward considering the current through <span class="math inline">\(Z\)</span> when looking into the impedance from either node A or node B and calculating an equivalent impedance causing the same current.</p>
<p>Note that if <span class="math inline">\(V_\mathrm{A} = V_\mathrm{B}\)</span> then there is no current flow through <span class="math inline">\(Z\)</span>, and accordingly the impedances <span class="math inline">\(Z_1 = Z_2 = \infty\)</span>.</p>
<p>Miller’s theorem can be quite handy when an impedance is strapped between two nodes, and we want to break this connection in a calculation, e.g., considering the effect of <span class="math inline">\(C_\mathrm{GD}\)</span> in a MOSFET.</p>
</section>
<section id="sec-5t-ota-zout" class="level1" data-number="17">
<h1 data-number="17"><span class="header-section-number">17</span> Appendix: 5T-OTA Small-Signal Output Impedance</h1>
<p>This section gives additional details to the analysis presented in <a href="#sec-basic-ota-small-signal" class="quarto-xref">Section&nbsp;8.3</a>. Here we provide the full calculation of the output impedance/conductance of the 5T-OTA for frequencies below the dominant pole, i.e.&nbsp;we neglect any capacitors.</p>
<div id="cell-fig-basic-ota-small-signal-zout" class="cell" data-execution_count="34">
<div class="cell-output cell-output-display">
<div id="fig-basic-ota-small-signal-zout" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-basic-ota-small-signal-zout-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-basic-ota-small-signal-zout-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-93" title="Figure&nbsp;45: 5-transistor OTA small-signal model for output impedance calculations."><img src="index_files/figure-html/fig-basic-ota-small-signal-zout-output-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-basic-ota-small-signal-zout-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;45: 5-transistor OTA small-signal model for output impedance calculations.
</figcaption>
</figure>
</div>
</div>
</div>
<section id="open-loop-configuration" class="level2" data-number="17.1">
<h2 data-number="17.1" class="anchored" data-anchor-id="open-loop-configuration"><span class="header-section-number">17.1</span> Open-Loop Configuration</h2>
<p>For the open-loop case, the gates of <span class="math inline">\(M_1\)</span> and <span class="math inline">\(M_2\)</span> are tied to ground and thus, both <span class="math inline">\(v_\mathrm{gs}\)</span> are equal. <span class="math display">\[
v_\mathrm{in,p}=v_\mathrm{in,p}=0~\text{V}
\]</span> <span id="eq-app-vbufzout-vin-ol"><span class="math display">\[
v_\mathrm{gs1} = v_\mathrm{gs2}
\tag{27}\]</span></span></p>
<p>KCL at the output node: <span id="eq-app-vbufzout-kcl-vout-ol"><span class="math display">\[
i_\mathrm{out} -g_\mathrm{ds4} v_\mathrm{out} - g_\mathrm{m34}v_\mathrm{gs34} - i_{g_\mathrm{ds2}} - g_\mathrm{m2}v_\mathrm{gs2} = 0
\tag{28}\]</span></span></p>
<p>KCL at the tail node: <span class="math display">\[
g_\mathrm{m1}v_\mathrm{gs1} + g_\mathrm{m2}v_\mathrm{gs2} + i_{g_\mathrm{ds2}} + g_\mathrm{ds5}v_\mathrm{gs2} = 0
\]</span></p>
<p>Using <a href="#eq-app-vbufzout-vin-ol" class="quarto-xref">Equation&nbsp;27</a> we can eliminate <span class="math inline">\(v_\mathrm{gs1}\)</span> and solve for <span class="math inline">\(i_{g_\mathrm{ds2}}\)</span>. <span id="eq-app-vbufzout-igds2"><span class="math display">\[
i_{g_\mathrm{ds2}} = -\left(g_\mathrm{m1}+g_\mathrm{m2}+g_\mathrm{ds5}\right)v_\mathrm{gs2}
\tag{29}\]</span></span></p>
<p>Furthermore, we need an expression for <span class="math inline">\(v_\mathrm{gs34}\)</span>. Ohm’s law at the conductance <span class="math inline">\(g_\mathrm{m34}\)</span> will suffice. <span id="eq-app-vbufzout-vgs34-ol"><span class="math display">\[
v_\mathrm{gs34} = -\frac{g_\mathrm{m1}}{g_\mathrm{m34}}v_\mathrm{gs1}
\tag{30}\]</span></span></p>
<p>KVL from the output node down to ground (over <span class="math inline">\(g_\mathrm{ds2}\)</span> and <span class="math inline">\(g_\mathrm{ds5}\)</span>) in combination with <a href="#eq-app-vbufzout-igds2" class="quarto-xref">Equation&nbsp;29</a> gives us an expression for <span class="math inline">\(v_\mathrm{gs2}\)</span> <span id="eq-app-vbufzout-vgs2-ol"><span class="math display">\[
v_\mathrm{gs2} = -\frac{g_\mathrm{ds2}}{g_\mathrm{m1}+g_\mathrm{m2}+g_\mathrm{ds2}+g_\mathrm{ds5}}v_\mathrm{out}
\tag{31}\]</span></span></p>
<p>Now, we can plug in all quantities into <a href="#eq-app-vbufzout-kcl-vout-ol" class="quarto-xref">Equation&nbsp;28</a>. First, <a href="#eq-app-vbufzout-igds2" class="quarto-xref">Equation&nbsp;29</a> is inserted, which provides an expression for the current through the output conductance <span class="math inline">\(g_\mathrm{ds2}\)</span> of <span class="math inline">\(M_2\)</span>. <span class="math display">\[
i_\mathrm{out} -g_\mathrm{ds4} v_\mathrm{out} - g_\mathrm{m34}v_\mathrm{gs34} + \left(g_\mathrm{m1}+g_\mathrm{ds5}\right)v_\mathrm{gs2} = 0
\]</span></p>
<p>Second, <span class="math inline">\(v_\mathrm{gs34}\)</span> is substituted by <a href="#eq-app-vbufzout-vgs34-ol" class="quarto-xref">Equation&nbsp;30</a>. Since we have assumed a matched pair of transistors for the current mirror comprised of <span class="math inline">\(M_3\)</span> and <span class="math inline">\(M_4\)</span>, <span class="math inline">\(g_\mathrm{m34}\)</span> perfectly cancels out of the equation, and is effectively replaced by the transconductance <span class="math inline">\(g_\mathrm{m1}\)</span> of the input transistor <span class="math inline">\(M_1\)</span>. <span class="math display">\[
i_\mathrm{out} -g_\mathrm{ds4} v_\mathrm{out} + \left(2g_\mathrm{m1}+g_\mathrm{ds5}\right)v_\mathrm{gs2} = 0
\]</span></p>
<p>Third, <a href="#eq-app-vbufzout-vgs2-ol" class="quarto-xref">Equation&nbsp;31</a> gives as an expression for the last remaining unknown <span class="math inline">\(v_\mathrm{gs2}\)</span>. Thus, the factor in front of <span class="math inline">\(v_\mathrm{out}\)</span> defines the conductance at the output node. <span id="eq-app-vbufzout-zout-ol-1"><span class="math display">\[
i_\mathrm{out} -\left[g_\mathrm{ds4} + \left(2g_\mathrm{m1}+g_\mathrm{ds5}\right)\frac{g_\mathrm{ds2}}{g_\mathrm{m1}+g_\mathrm{m2}+g_\mathrm{ds2}+g_\mathrm{ds5}}\right]v_\mathrm{out} = 0
\tag{32}\]</span></span> Before, we interpret this result, we use are assumption of matched input transistors (<span class="math inline">\(g_\mathrm{m12}=g_\mathrm{m1}=g_\mathrm{m2}\)</span>) and slightly rearrange the equation to give us more insight. <span id="eq-app-vbufzout-zout-ol-2"><span class="math display">\[
i_\mathrm{out} -\left[g_\mathrm{ds4} + \frac{g_\mathrm{ds2}\cdot\left(2g_\mathrm{m12}+g_\mathrm{ds5}\right)}{g_\mathrm{ds2}+\left(2g_\mathrm{m12}+g_\mathrm{ds5}\right)}\right]v_\mathrm{out} = 0
\tag{33}\]</span></span> Now, we can identify the common equation of the total resistance of two parallel resistors. However, we are dealing with conductances here, so the same equation describes the total conductance of two conductances in series, while parallel conductances are simply summed. In parallel to <span class="math inline">\(g_\mathrm{ds4}\)</span>, there is effectively the series connection of <span class="math inline">\(g_\mathrm{ds2}\)</span> and <span class="math inline">\(\left(2g_\mathrm{m12}+g_\mathrm{ds5}\right)\)</span> at work. If we apply the general assumption of <span class="math inline">\(g_\mathrm{m}\gg g_\mathrm{ds}\)</span>, only the parallel connection of <span class="math inline">\(g_\mathrm{ds4}\)</span> and <span class="math inline">\(g_\mathrm{ds2}\)</span> remains. Therefore, moving <span class="math inline">\(g_\mathrm{ds2} + g_\mathrm{ds4}\)</span> in parallel to <span class="math inline">\(C_\mathrm{load}\)</span> in <a href="#sec-basic-ota-small-signal" class="quarto-xref">Section&nbsp;8.3</a> was valid. <span id="eq-app-vbufzout-zout-ol-3"><span class="math display">\[
\frac{i_\mathrm{out}}{v_\mathrm{out}}\approx g_\mathrm{ds4} + g_\mathrm{ds2}
\tag{34}\]</span></span></p>
</section>
<section id="closed-loop-configuration" class="level2" data-number="17.2">
<h2 data-number="17.2" class="anchored" data-anchor-id="closed-loop-configuration"><span class="header-section-number">17.2</span> Closed-Loop Configuration</h2>
<p>In contrast to the open-loop case, we keep the gate of <span class="math inline">\(M_1\)</span> connected to ground and tie the input of <span class="math inline">\(M_2\)</span> to the output node <span class="math inline">\(v_\mathrm{out}\)</span>. <span id="eq-app-vbufzout-vin-cl"><span class="math display">\[
v_\mathrm{in,n} = v_\mathrm{out}
\tag{35}\]</span></span></p>
<p>KCL at the output node: <span id="eq-app-vbufzout-kcl-vout-cl"><span class="math display">\[
i_\mathrm{out} -g_\mathrm{ds4} v_\mathrm{out} - g_\mathrm{m34}v_\mathrm{gs34} - g_\mathrm{ds2}v_\mathrm{gs2} - g_\mathrm{m2}v_\mathrm{gs2} = 0
\tag{36}\]</span></span></p>
<p>We use KVL from the output node down to ground to find an expression for <span class="math inline">\(v_\mathrm{gs2}\)</span>. <span id="eq-app-vbufzout-kvl-vout-cl"><span class="math display">\[
v_\mathrm{gs2} =  v_\mathrm{out} + v_\mathrm{gs1}
\tag{37}\]</span></span></p>
<p>KCL at the tail node: <span id="eq-app-vbufzout-kcl-vtail-cl"><span class="math display">\[
g_\mathrm{m1}v_\mathrm{gs1} + g_\mathrm{m2}v_\mathrm{gs2} + g_\mathrm{ds2}v_\mathrm{gs2} + g_\mathrm{ds5}v_\mathrm{gs2} = 0
\tag{38}\]</span></span></p>
<p>Using <a href="#eq-app-vbufzout-kvl-vout-cl" class="quarto-xref">Equation&nbsp;37</a> to substitute <span class="math inline">\(v_\mathrm{gs2}\)</span> in {#eq-app-vbufzout-kcl-vtail-cl} we find an equation for <span class="math inline">\(v_\mathrm{gs1}\)</span>. <span id="eq-app-vbufzout-vgs1-cl"><span class="math display">\[
v_\mathrm{gs1} = -\frac{g_\mathrm{m2}+g_\mathrm{ds2}}{g_\mathrm{m1}+g_\mathrm{m2}+g_\mathrm{ds2}+g_\mathrm{ds5}}v_\mathrm{out}
\tag{39}\]</span></span></p>
<p>Again, we derive the output conductance by plugging <a href="#eq-app-vbufzout-kvl-vout-cl" class="quarto-xref">Equation&nbsp;37</a>, <a href="#eq-app-vbufzout-vgs34-ol" class="quarto-xref">Equation&nbsp;30</a> and <a href="#eq-app-vbufzout-vgs1-cl" class="quarto-xref">Equation&nbsp;39</a> step by step into <a href="#eq-app-vbufzout-kcl-vout-cl" class="quarto-xref">Equation&nbsp;36</a>. First, we use <a href="#eq-app-vbufzout-kvl-vout-cl" class="quarto-xref">Equation&nbsp;37</a> to eliminate <span class="math inline">\(v_\mathrm{gs2}\)</span>. <span class="math display">\[
i_\mathrm{out} -\left(g_\mathrm{ds4} + g_\mathrm{ds2} + g_\mathrm{m2}\right)v_\mathrm{out} - g_\mathrm{m34}v_\mathrm{gs34} - \left(g_\mathrm{ds2} + g_\mathrm{m2}\right)v_\mathrm{gs1} = 0
\]</span></p>
<p>Second, <a href="#eq-app-vbufzout-vgs34-ol" class="quarto-xref">Equation&nbsp;30</a> also holds for the closed-loop case and lets us eliminate <span class="math inline">\(v_\mathrm{gs34}\)</span>. <span class="math display">\[
i_\mathrm{out} -\left(g_\mathrm{ds4} + g_\mathrm{ds2} + g_\mathrm{m2}\right)v_\mathrm{out} - \left(g_\mathrm{ds2} + g_\mathrm{m2} - g_\mathrm{m1}\right)v_\mathrm{gs1} = 0
\]</span></p>
<p>Third, we use <a href="#eq-app-vbufzout-vgs1-cl" class="quarto-xref">Equation&nbsp;39</a> to eliminate the remaining unknown <span class="math inline">\(v_\mathrm{gs1}\)</span>. <span class="math display">\[
i_\mathrm{out} -\left(g_\mathrm{ds4} + g_\mathrm{ds2} + g_\mathrm{m2}\right)v_\mathrm{out} + \left(g_\mathrm{ds2} + g_\mathrm{m2} - g_\mathrm{m1}\right)\frac{g_\mathrm{m2}+g_\mathrm{ds2}}{g_\mathrm{m1}+g_\mathrm{m2}+g_\mathrm{ds2}+g_\mathrm{ds5}}v_\mathrm{out} = 0
\]</span></p>
<p>A more simpler result can be obtained, if we neglect <span class="math inline">\(g_\mathrm{ds2}\)</span> and <span class="math inline">\(g_\mathrm{ds5}\)</span> in <a href="#eq-app-vbufzout-vgs1-cl" class="quarto-xref">Equation&nbsp;39</a> first (<span class="math inline">\(g_\mathrm{m}\gg g_\mathrm{ds}\)</span>) and then plug it into our main equation. Additionally, we use <span class="math inline">\(g_\mathrm{m12}=g_\mathrm{m1}=g_\mathrm{m2}\)</span> to further simplify the equation. <span class="math display">\[
i_\mathrm{out} -\left(g_\mathrm{ds4} + \frac{3}{2} g_\mathrm{ds2} + g_\mathrm{m12}\right)v_\mathrm{out} \approx 0
\]</span></p>
<p>If we apply <span class="math inline">\(g_\mathrm{m}\gg g_\mathrm{ds}\)</span> again, we arrive at the same result which was used for the noise calculation in <a href="#sec-basic-ota-small-signal" class="quarto-xref">Section&nbsp;8.3</a>, compare the expression for <span class="math inline">\(Y'_\mathrm{load}\)</span> given by <a href="#eq-basic-ota-output-noise-yload" class="quarto-xref">Equation&nbsp;20</a> . <span class="math display">\[
i_\mathrm{out} -\left(g_\mathrm{m12}\right)v_\mathrm{out} \approx 0
\]</span></p>
</section>
</section>
<section id="sec-linux-cheatsheet" class="level1" data-number="18">
<h1 data-number="18"><span class="header-section-number">18</span> Appendix: Linux Cheatsheet</h1>
<p>The most useful commands for the Linux command line are:</p>
<ul>
<li><code>ls</code> to list files and directories</li>
<li><code>cd</code> to change directory (e.g.&nbsp;<code>cd analog-circuit-design/xschem</code>)</li>
<li><code>cd ..</code> to move one directory level down</li>
<li><code>mkdir</code> to create a new directory (e.g.&nbsp;<code>mkdir my_directory</code>)</li>
<li><code>touch</code> to create an empty file (e.g.&nbsp;<code>touch file.txt</code>)</li>
<li><code>rm</code> to remove files (e.g.&nbsp;<code>rm file.txt</code>)</li>
<li><code>rm -r</code> to remove recursively, for example a directory (e.g.&nbsp;<code>rm -r my_directory</code>)</li>
<li><code>cp</code> to copy files (e.g.&nbsp;<code>cp file.txt destination</code>)</li>
<li><code>cp -r</code> to copy recursively a directory (e.g.&nbsp;<code>cp -r directory destination</code>)</li>
<li><code>mv</code> to rename files (e.g.&nbsp;<code>mv file.txt new_name.txt</code>)</li>
<li><code>mv</code> to move files into other directories (e.g.&nbsp;<code>mv file.txt directory</code>)</li>
<li><code>cat</code> to view the contents of a file (e.g.&nbsp;<code>cat file.txt</code>)</li>
<li><code>find</code> to search for files and directories (e.g.&nbsp;<code>find /path -name "*.txt"</code>)</li>
<li><code>nano</code> to edit file (e.g.&nbsp;<code>nano file.txt</code>)</li>
<li><code>Ctrl + C</code> to forcefully terminate a running process</li>
<li><code>htop</code> to open the “task manager”</li>
</ul>
<p>More advanced commands can be found under <a href="https://www.geeksforgeeks.org/linux-commands-cheat-sheet" class="uri">https://www.geeksforgeeks.org/linux-commands-cheat-sheet</a>.</p>
</section>
<section id="sec-xschem-cheatsheet" class="level1" data-number="19">
<h1 data-number="19"><span class="header-section-number">19</span> Appendix: Xschem Cheatsheet</h1>
<p>When opening Xschem, using <code>Help -&gt; Keys</code> a pop-up windows comes up with many useful shortcuts. The most useful are:</p>
<section id="moving-around-in-a-schematic" class="level4" data-number="19.0.0.1">
<h4 data-number="19.0.0.1" class="anchored" data-anchor-id="moving-around-in-a-schematic"><span class="header-section-number">19.0.0.1</span> Moving around in a schematic:</h4>
<ul>
<li><code>Cursor keys</code> to move around</li>
<li><code>Ctrl-e</code> to go back to parent schematic</li>
<li><code>e</code> to descend into schematic of selected symbol</li>
<li><code>i</code> to descend into symbol of selected symbol</li>
<li><code>f</code> full zoom on schematic</li>
<li><code>Shift-z</code> to zoom in</li>
<li><code>Ctrl-z</code> to zoom out</li>
</ul>
</section>
<section id="editing-schematics" class="level4" data-number="19.0.0.2">
<h4 data-number="19.0.0.2" class="anchored" data-anchor-id="editing-schematics"><span class="header-section-number">19.0.0.2</span> Editing schematics:</h4>
<ul>
<li><code>Del</code> to delete elements</li>
<li><code>Ins</code> to insert elements from library</li>
<li><code>Escape</code> to abort an operation</li>
<li><code>Ctrl-#</code> to rename components with duplicate names</li>
<li><code>c</code> to copy elements</li>
<li><code>Alt-Shift-l</code> to add wire label</li>
<li><code>Alt-l</code> to add label pin</li>
<li><code>m</code> to move selected objects</li>
<li><code>Shift-R</code> to rotate selected objects</li>
<li><code>Shift-F</code> to mirror / flip selected objects</li>
<li><code>q</code> to edit properties</li>
<li><code>Ctrl-s</code> to save schematic</li>
<li><code>t</code> to place a text</li>
<li><code>Shift-T</code> to toggle the <code>ignore</code> flag on an instance</li>
<li><code>u</code> to undo an operation</li>
<li><code>w</code> to draw a wire</li>
<li><code>Shift-W</code> draw wire and snap to close pin or net point</li>
<li><code>&amp;</code> to join, break, and collapse wires</li>
<li><code>A</code> to make symbol from schematic</li>
<li><code>Alt-s</code> to reload the circuit if changes in a subcircuit were made</li>
</ul>
</section>
<section id="viewingsimulating-schematics" class="level4" data-number="19.0.0.3">
<h4 data-number="19.0.0.3" class="anchored" data-anchor-id="viewingsimulating-schematics"><span class="header-section-number">19.0.0.3</span> Viewing/Simulating Schematics</h4>
<ul>
<li><code>5</code> to only view probes</li>
<li><code>k</code> to highlight selected net</li>
<li><code>Shift-K</code> to unhighlight all nets</li>
<li><code>Shift-o</code> to toggle light/dark color scheme</li>
<li><code>s</code> to run a simulation</li>
<li><code>a &amp; b</code> to add cursors to an in-circuit simulation graph</li>
<li><code>f</code> full zoom on y- or x-axis in in-circuit simulation graph</li>
</ul>
</section>
</section>
<section id="sec-ngspice-cheatsheet" class="level1" data-number="20">
<h1 data-number="20"><span class="header-section-number">20</span> Appendix: ngspice Cheatsheet</h1>
<p>Here is an unsorted list of useful ngspice settings and command:</p>
<section id="commands" class="level2" data-number="20.1">
<h2 data-number="20.1" class="anchored" data-anchor-id="commands"><span class="header-section-number">20.1</span> Commands</h2>
<ul>
<li><code>ac dec|lin points fstart fstop</code> performs a small-signal ac analysis with either linear or decade sweep</li>
<li><code>dc sourcename vstart vstop vincr [src2 start2 stop2 incr2]</code> runs a dc-sweep, optionally across two variables</li>
<li><code>display</code> shows the available data vectors in the current plot</li>
<li><code>echo</code> can be used to display text, <code>$variable</code> or <code>$&amp;vector</code>, can be useful for debugging</li>
<li><code>let name = expr</code> to create a new vector; <code>unlet vector</code> deletes a specified vector; access vector data with <code>$&amp;vec</code></li>
<li><code>linearize vec</code> linearizes a vector on an equidistant time scale, do this before an FFT; with <code>set specwindow=windowtype</code> a proper windowing function can be set</li>
<li><code>meas</code> can be used for various evaluations of measurement results (see ngspice manual for details)</li>
<li><code>noise v(output &lt;ref&gt;) src (dec|lin) pts fstart fstop</code> runs a small-signal noise analysis</li>
<li><code>op</code> calculates the operating point, useful for checking bias points and device parameters</li>
<li><code>plot expr vs scale</code> to plot something</li>
<li><code>print expr</code> to print it, use <code>print all</code> to print everything</li>
<li><code>remzerovec</code> can be useful to remove vectors with zero length, which otherwise cause issues when saving or plotting data</li>
<li><code>rusage</code> plot information about resource usage like memory</li>
<li><code>save all</code> or <code>save signal</code> specifies which data is saved during simulation; this lowers RAM usage during simulation and size of RAW file; do save before the actual simulation statement</li>
<li><code>setplot</code> show a list of available plots</li>
<li><code>set var = value</code> to set the value of a variable; use variable with <code>$var</code>; <code>unset var</code> removes a variable</li>
<li><code>set enable_noisy_r</code> to enable noise of behavioral resistors; usually, this is a good idea</li>
<li><code>shell cmd</code> to run a shell command</li>
<li><code>show : param</code>, like <code>show : gm</code> shows the <span class="math inline">\(g_\mathrm{m}\)</span> of all devices after running an operating point with <code>op</code></li>
<li><code>spec</code> plots a spectrum (i.e.&nbsp;frequency domain plot)</li>
<li><code>status</code> shows the saved parameters and nodes</li>
<li><code>tf</code> runs a transfer function analysis, returning transfer function, input and output resistance</li>
<li><code>tran tstep tstop &lt;tstart &lt;tmax&gt;&gt;</code> runs a transient analysis until <code>tstop</code>, reporting results with <code>tstep</code> step size, starting to plot at <code>tstart</code> and performs time steps not larger then <code>tmax</code></li>
<li><code>wrdata</code> writes data into a file in a tabular ASCII format; easy to further process</li>
<li><code>write</code> writes simulation data (the saved nodes) into a RAW file; default is binary, can be changed to ASCII with <code>set filetype=ascii</code>; with <code>set appendwrite</code> data is added to an existing file</li>
</ul>
</section>
<section id="options" class="level2" data-number="20.2">
<h2 data-number="20.2" class="anchored" data-anchor-id="options"><span class="header-section-number">20.2</span> Options</h2>
<p>Use <code>option option=val option=val</code> to set various options; important ones are:</p>
<ul>
<li><code>abstol</code> sets the absolute current error tolerance (default is 1pA)</li>
<li><code>gmin</code> is the conductance applied at every node for convergence improvement (default is 1e-12); this can be critical for very high impedance circuits</li>
<li><code>klu</code> sets the KLU matrix solver</li>
<li><code>list</code> print the summary listing of the input data</li>
<li><code>maxord</code> sets the numerical order of the integration method (default is 2 for Gear)</li>
<li><code>method</code> set the numerical integration method to <code>gear</code> or <code>trap</code> (default is <code>trap</code>)</li>
<li><code>node</code> prints the node table</li>
<li><code>opts</code> prints the option values</li>
<li><code>temp</code> sets the simulation temperature</li>
<li><code>reltol</code> set the relative error tolerance (default is 0.001 = 0.1%)</li>
<li><code>savecurrents</code> saves the terminal currents of all devices</li>
<li><code>sparse</code> sets the sparse matrix solver, which can run noise analysis, but is slower than <code>klu</code></li>
<li><code>vntol</code> sets the absolute voltage error tolerance (default is 1µV)</li>
<li><code>warn</code> enables the printing of the SOA warning messages</li>
</ul>
</section>
<section id="convergence-helper" class="level2" data-number="20.3">
<h2 data-number="20.3" class="anchored" data-anchor-id="convergence-helper"><span class="header-section-number">20.3</span> Convergence Helper</h2>
<ul>
<li><code>option gmin</code> can be used to increase the conductance applied at every node</li>
<li><code>option method=gear</code> can lead to improved convergence</li>
<li><code>.nodeset</code> can be used to specify initial node voltage guesses</li>
<li><code>.ic</code> can be used to set initial conditions</li>
</ul>
</section>
</section>
<section id="sec-designers-etiquette" class="level1" data-number="21">
<h1 data-number="21"><span class="header-section-number">21</span> Appendix: Circuit Designer’s Etiquette</h1>
<section id="prolog" class="level2" data-number="21.1">
<h2 data-number="21.1" class="anchored" data-anchor-id="prolog"><span class="header-section-number">21.1</span> Prolog</h2>
<p>A consistent naming and schematic drawing style, as well as VHDL/Verilog coding scheme, is a huge help in avoiding errors and increasing productivity. Even if just one person works on a design, the error rate is lowered. If multiple persons work together in a team, a consistent working style is a big help for smooth cooperation without misunderstanding each other’s intentions. Consistency also helps to reuse existing blocks. In a well-done design, the documentation is included in the schematic/source code, so there is no searching for a piece of documentation somewhere else (which is often not found anyway).</p>
</section>
<section id="pins" class="level2" data-number="21.2">
<h2 data-number="21.2" class="anchored" data-anchor-id="pins"><span class="header-section-number">21.2</span> Pins</h2>
<ul>
<li>Name package pins (interfacing with the outside the IC) in <strong>UPPERCASE</strong>, and all internal signals in <strong>lowercase</strong>.</li>
<li>Supply voltages like VDD/VCC and ground like VSS/GND need to start with either <code>VDD</code>, <code>VCC</code>, <code>VSS</code>, <code>VEE</code> or <code>GND</code>, plus a suitable suffix. Examples: <code>VDD1</code>, <code>VDD_AMP</code>, <code>vdd_ldo_out</code>, <code>VSS_ANA</code> (uppercase means connected to a pin, lowercase means a VDD is created on-chip by, e.g., an LDO).</li>
<li>Preferred are <code>VDD</code>/<code>VSS</code> for CMOS and <code>VCC</code>/<code>GND</code> for bipolar circuits. In BiCMOS circuits <code>VDD</code>/<code>VSS</code> are preferred, as usually, the digital content is the major part.</li>
<li>Digital signals in an analog schematic should start with <code>di_</code> (for digital input) or <code>do_</code> (for digital output). Example: <code>di_ctrl1</code>. In the rare case of a bi-directional digital signal <code>dio_</code> can be used.</li>
<li>Name digital signals consistently: <code>di_pon</code> is active-high, <code>di_pon_b</code> is active-low (<code>_b</code> standing for the negating “bar”); as an alternative, this last signal could be named <code>di_disable</code>. <code>di_reset</code> is an active-high reset, but often a reset is active-low, so it needs to be named <code>di_reset_b</code> (an alternative is <code>di_resetn</code>).</li>
<li>In mixed-voltage designs, it might be useful to append the voltage level of a signal to avoid connecting incompatible inputs and outputs. Example: <code>do_comp_1v2</code> or <code>di_poweron_3v3</code>.</li>
<li>Digital buses always have the MSB to the left and LSB to the right. Example: <code>do_adc[7:0]</code>.</li>
<li>Analog signals should start with a <code>v</code> for a voltage signal or <code>i</code> for a current signal. It is often useful to include a value for bias signals or make the naming meaningful. RF signals, which are often neither voltage nor current signals, start the name with <code>rf_</code>. Examples: Signal and pin names like <code>ibias_30u</code> (30uA of bias current), <code>vbg_1v2</code> (a bandgap voltage of 1.2V), <code>vin_p</code>, <code>v_filt_out_n</code>, and <code>rf_lna_i</code> speak for themselves.</li>
<li>Appending analog signals with <code>_i</code> and <code>_o</code> might be useful if a clear direction is obvious in the signal flow. If a signal is bi-directional, it is better to skip <code>_io</code>.</li>
<li>Consistently use pin types <code>input</code>, <code>output</code>, or <code>inout</code> to indicate signal flow. Power supply pins are of <code>inout</code> type.</li>
</ul>
</section>
<section id="schematics" class="level2" data-number="21.3">
<h2 data-number="21.3" class="anchored" data-anchor-id="schematics"><span class="header-section-number">21.3</span> Schematics</h2>
<ul>
<li>In analog schematics, add a textual note about basic circuit performance. For example, in an amplifier, note things like suitable supply range, typical and w.c. current consumption, gain, GBW, input voltage range, PSRR, and other useful information.</li>
<li>If a circuit has a quirk or is particularly clever, add a note on how it works, so others can understand the function without excessive analysis (reviewing a circuit should not be a brain teaser).</li>
<li>Use provided borders or drawing templates for schematics, and fill the data in, like circuit designer name, date, change history, project name, etc.</li>
<li>Use a versioning system for your data, and check in often. This avoids data loss, and going back to an earlier design stage is simple. <code>SVN</code> is often preferable to <code>GIT</code> for binary data.</li>
<li>Draw uncluttered clear circuits. Ideally, the circuit function is apparent by inspection <strong>quickly</strong>. Everyone can obscure an inverter so that it takes 5 minutes to recognize it, but this is not a good design.</li>
<li>Don’t alter the standard grid setting while drawing schematics (also make sure that the pins in your drawn symbols are on the standard grid)! Off-grid schematic elements will haunt you and your colleagues forever!</li>
<li>Once a schematic is finished, take the time to name component instances properly (you can use speaking names like <code>Rstab</code> or simply use <code>R1</code>, <code>R2</code>, etc.). Use iterated instances to clean up the circuit. Use wire bundles to clean up circuits where useful. A clever technique is to use bundles and iterated instances to efficiently draw large resistor ladders, for example (however, use with care).</li>
<li>Avoid connection-by-name, as it makes the circuit hard to read. However, there is a fine line to not cluttering circuits. Signals with many connections (<code>vdd</code>, <code>vss</code>, <code>pon</code>, <code>pon_b</code>) are often better done with connection-by-name instead of drawing a wire.</li>
<li>Some tools allow the use of colored wires, which might be used to mark signal paths, bias lines, etc. However, this should not be overdone; use it with care.</li>
<li>If you add auxiliary elements like current probes, ensure they get proper treatment when creating the netlist for the LVS (some elements should be shorted, and some elements simply taken out). Ideally, only use a single schematic for simulation, LVS, etc. By using tool features this can usually be done, and avoids the need to keep multiple schematics of one block in sync.</li>
<li>Use annotations in the schematics to (1) denote current levels in branches, (2) denote bias voltage levels, (3) explain the function of logic input signals, and (4) put in logic tables if not obvious.</li>
<li>Add comments concerning the layout, like matching devices, certain considerations of placement, sensitive nodes, etc.</li>
<li>Add simple ASCII diagrams for timing signals if useful.</li>
<li>Name internal signals (signals connected to pins are anyway named like the port) in a meaningful way; this makes tracking signals in simulation or layout much easier (automatic net names like <code>net0032</code> are of not much help).</li>
<li>Properly name instances, not just <code>I1</code> or <code>I2</code>; better is <code>amp1</code>, <code>inv2</code>, etc. (a descriptor in a tool output like <code>I1/I13/I5/net017</code> is not helpful; compare that to <code>adc1/bias/bg/vref_int</code>).</li>
<li>On check-and-save, never ignore warnings; just fix them! They will annoy you and others forever and might flag critical design flaws.</li>
<li>Name cells interpretably, ideally making the function clear already by the name. It is often useful to prefix or postfix a cell by the project name and design iteration. Example: In the project <code>GIGAPROJECT</code>, the cells which are changed in the second design step are prefixed with <code>g2_</code>, like <code>g2_amp_bias</code>. Of course, more letters as a project abbreviation are useful if a name collision is likely to happen.</li>
<li>Cell names in lowercase are a good choice, as otherwise, capitalization leads to inconsistency in cell names. Use <code>_</code> to break words instead of <code>CamelCase</code>, like <code>amp_bias_startup</code>.</li>
<li>When building a design, start with the hierarchy first; plan a suitable design structure, and define all interfaces. Implement simple behavioral models for every circuit block (either with controlled sources or using Verilog-A or VHDL/Verilog digital models). In this way, you can simulate the overall design early and find issues in the hierarchy or the interconnects. Then, populate the hierarchy with the detailed circuit designs in the leaf cells. At each point in the design process, you have a design that can be simulated, with some blocks as behavioral models and some blocks already designed. Try to avoid scattered circuit elements (digital or analog) in the hierarchy; it is better to push all components into the leaf cells.</li>
<li>Avoid huge schematics, better break them down into smaller, maintainable, and self-contained blocks, and provide a simulation test bench for these simple blocks. In this way, later re-simulation across the hierarchy is easily possible.</li>
<li>When building up the hierarchy, choose pin names and signal names as consistently as possible. Example: use the signal name <code>vref_int</code> when connecting two leaf cells with the pin names <code>vref_int_o</code> and <code>vref_int_i</code>.</li>
<li>Avoid the excessive use of net breakers like small resistors, as they inhibit net tracing and can lead to simulation convergence issues. If a net breaker is needed (or a current should be probed) use a 0V dc voltage source.</li>
</ul>
</section>
<section id="symbols" class="level2" data-number="21.4">
<h2 data-number="21.4" class="anchored" data-anchor-id="symbols"><span class="header-section-number">21.4</span> Symbols</h2>
<ul>
<li>Spend time drawing nice symbols! Ideally, the underlying circuit functionality is apparent by just looking at the symbol.</li>
<li>Arrange the pins in a meaningful way.</li>
<li>Group pins that belong together. An often useful arrangement is to locate the inputs on the left side, outputs on the right, digital control inputs at the bottom, and supplies at the top.</li>
<li>Make the origin of a symbol in the top-left corner. In this way, symbols can be changed more easily, for example, by swapping out different versions of blocks.</li>
<li>The cell name (and potentially library name) should be visible in the symbol, not only in the properties.</li>
</ul>
</section>
<section id="design-robustness" class="level2" data-number="21.5">
<h2 data-number="21.5" class="anchored" data-anchor-id="design-robustness"><span class="header-section-number">21.5</span> Design Robustness</h2>
<ul>
<li>It is good practice to buffer incoming digital signals with a local inverter (connected to the local block supply) before connecting it to internal nodes. This improves the slew rate of the control signal and lowers the chance of unwanted cross-talk.</li>
<li>Consider dummy elements for good matching, and try to make useful unit sizes of components. This will make the layout creation much smoother.</li>
<li>The golden rule of good analog performance is good matching, and good matching is achieved by identical components (size, orientation, surroundings)! If the layout does not look nice (humans like symmetry), it will not perform well.</li>
<li>Consider supply decoupling and bias voltage decoupling inside the cells. Often, dummy elements can be used for that. Be aware, however, of unwanted supply resonances (think bond wire <code>L</code> and decoupling <code>C</code>) and slow transients of bias nodes after disturbance.</li>
<li>Always implement a proper power-down mode. Avoid floating nodes in off-mode. The better defined the on- as well as the off-mode are, the less the chance of leakage currents. Always simulate both modes (on and off), and also simulate a transient power-up of a circuit to identify issues with slow bias start or insufficient turn-off, or nasty feedback loop instabilities during transients.</li>
<li>When drawing the first schematic, add parasitic capacitances to each node. If all nodes are labeled, a capacitor bank is easily put into one corner of the schematic with parasitic caps tied to the ground. Use 5fF as a starting value (and replace it later with the correct value from parasitic extraction). This accounts for some wiring parasitics in layout and helps to account for these layout impairments early in the design phase and later when simulating the schematic instead of the extracted netlist with parasitics.</li>
</ul>
</section>
<section id="rules-for-good-mixed-signal-and-rf-circuits" class="level2" data-number="21.6">
<h2 data-number="21.6" class="anchored" data-anchor-id="rules-for-good-mixed-signal-and-rf-circuits"><span class="header-section-number">21.6</span> Rules for Good Mixed-Signal and RF Circuits</h2>
<ul>
<li>Separate analog and digital power supply, connect to package pins with multiple bond wires/bumps, and separate noisy and clean <code>vdd</code>/<code>vss</code> from each other!</li>
<li>Prevent supply loops; keep <code>vdd</code> and <code>vss</code> lines close to each other (incl.&nbsp;bond wires and PCB traces)! This minimizes <code>L</code> and coupling factor <code>k</code>.</li>
<li>Some prefer a massive (punched) ground plane, which is possible if you have enough metal levels. With a ground plane, the return path of a signal or supply line is just a few microns away.</li>
<li>Use chip-internal decoupling capacitors, and decouple bias voltages to the <strong>correct</strong> potential (<code>vdd</code> or <code>vss</code>, or another node, depending on the circuit)!</li>
<li>Use substrate contacts and guard rings to lower substrate crosstalk but use a quiet potential for connection; use triple-well if available! Connecting a guard-ring/substrate contact to a noisy supply is a prime noise injector (usually unwanted).</li>
<li>Physically separate quiet and noisy circuits (at least by the epi thickness)!</li>
<li>Reduce circuit noise generation as much as possible (avoid switching circuits if possible, use constant-current circuits instead, and use series/shunt regulators for supply isolation).</li>
<li>Reduce sensitivity of circuits to interference (by using a fully differential design with high PSRR/CMRR, symmetrical layout parasitics, and good matching)!</li>
</ul>
</section>
<section id="vhdlverilog-coding-guide" class="level2" data-number="21.7">
<h2 data-number="21.7" class="anchored" data-anchor-id="vhdlverilog-coding-guide"><span class="header-section-number">21.7</span> VHDL/Verilog Coding Guide</h2>
<p>These recommendations are specifically targeted at Verilog; however, they apply similarly to VHDL.</p>
<ul>
<li>Use automatic checkers (linters) to see whether your code contains errors or vulnerabilities. Commercial or open-source tools allow this, e.g., Icarus Verilog (<code>iverilog -g2005 -tnull FILE.v</code>) or Verilator (<code>verilator --lint-only -Wall FILE.v</code>).</li>
<li>Write readable and maintainable code; use speaking variable names, and use a naming convention for inputs (beginning with <code>i_</code>) and outputs (beginning with <code>o_</code>). Active-low signals have an <code>_n</code> or <code>_b</code> in their name, like <code>i_reset_n</code>. Use comments to explain the intention.</li>
<li>With a synchronous reset reset-related racing conditions are often avoided. If an asynchronous reset is desirable (which is often the case), ensure the reset signals are free from race conditions.</li>
<li>Module-local registers and wires could append <code>_w</code> (for Verilog <code>wire</code>) or <code>_r</code> (for Verilog <code>reg</code>) to make their function clear. This is not required in SystemVerilog where the unified type <code>logic</code> should be used.</li>
<li>Use an <code>assign</code> statement for logic as this often is easier to read than an <code>always @(*)</code> block. The ternary operator <code>COND ? TRUE : FALSE</code> can help with conditional assignments and is often a better choice than a (nested) <code>if ... else</code> statement.</li>
<li>Declare all outputs explicitly with either <code>reg</code> or <code>wire</code>.</li>
<li>Use local parameter definitions with <code>localparam</code> in a module to make the code easier to follow. Name parameters in <strong>UPPERCASE</strong>.</li>
<li>Take care to reset all registers to a defined state (in simulation and HW).</li>
<li>Use the rule of “one file per module.” The filename shall match the module declaration.</li>
<li>Use <code>`default_nettype none</code> at the beginning of a file containing a module definition. After the module you can use <code>`default_nettype wire</code>. This will add a safety net against typos in signal names.</li>
<li>In a logic assign block, use <code>assign @(*) begin ... end</code> instead of spelling out the signals in the sensitivity list. Forgetting a signal could lead to serious mismatches between simulation and HW.</li>
<li>Make your code flexible by making bit widths and other values parameterized using a <code>localparam</code> or module parameter.</li>
<li>Be cautious of implicit type conversions and bit-width adaptions; better make explicit conversions and match bit widths in assignments.</li>
<li>Use only blocking assignments (<code>=</code>) in <code>always @(*)</code> blocks, and only non-blocking assignments (<code>&lt;=</code>) in clocked <code>always @(posedge ...)</code> blocks.</li>
</ul>
</section>
<section id="further-reading" class="level2" data-number="21.8">
<h2 data-number="21.8" class="anchored" data-anchor-id="further-reading"><span class="header-section-number">21.8</span> Further Reading</h2>
<ul>
<li>Good information about drawing schematics, design testbenches, etc: <a href="https://circuit-artists.com" class="uri">https://circuit-artists.com</a></li>
<li>Sutherland/Mills, <em>Verilog and SystemVerilog Gotchas - 101 Common Coding Erorrs and How to Avoid Them</em>, Springer, 2010</li>
<li>B. Razavi, <em>The Analog Mind</em>, recurrent column in IEEE Solid-State Circuits Magazine</li>
</ul>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Gray_Mayer_5th_ed" class="csl-entry" role="listitem">
Gray, Paul R., Paul J. Hurst, Stephen H. Lewis, and Robert G. Meyer. 2009. <em><span class="nocase">Analysis and Design of Analog Integrated Circuits</span></em>. Wiley.
</div>
<div id="ref-Hellen_2003" class="csl-entry" role="listitem">
Hellen, Edward H. 2003. <span>“<span class="nocase">Verifying the diode–capacitor circuit voltage decay</span>.”</span> <em>American Journal of Physics</em> 71 (8): 797–800. <a href="https://doi.org/10.1119/1.1578070">https://doi.org/10.1119/1.1578070</a>.
</div>
<div id="ref-Chenming_Hu_2010" class="csl-entry" role="listitem">
Hu, Chenming. 2010. <em>Modern Semiconductor Devices for Integrated Circuits</em>. Pearson.
</div>
<div id="ref-Jespers_Murmann_2017" class="csl-entry" role="listitem">
Jespers, Paul G. A., and Boris Murmann. 2017. <em>Systematic Design of Analog CMOS Circuits: Using Pre-Computed Lookup Tables</em>. Cambridge University Press.
</div>
<div id="ref-Maxwell_1873" class="csl-entry" role="listitem">
Maxwell, James Clerk. 1873. <em>A Treatise on Electricity and Magnetism</em>. Vol. 1. Clarendon Press.
</div>
<div id="ref-Middlebrook_1975" class="csl-entry" role="listitem">
Middlebrook, R. D. 1975. <span>“<span class="nocase">Measurement of loop gain in feedback systems</span>.”</span> <em>International Journal of Electronics</em> 38 (4): 485–512. <a href="https://doi.org/10.1080/00207217508920421">https://doi.org/10.1080/00207217508920421</a>.
</div>
<div id="ref-murmann_mos_stages_2013" class="csl-entry" role="listitem">
Murmann, Boris. 2013. <em><span class="nocase">Analysis and Design of Elementary MOS Amplifier Stages</span></em>. NTS Press.
</div>
<div id="ref-Nagel_1975" class="csl-entry" role="listitem">
Nagel, Laurence W. 1975. <span>“SPICE2: A Computer Program to Simulate Semiconductor Circuits.”</span> PhD thesis, EECS Department, University of California, Berkeley. <a href="http://www2.eecs.berkeley.edu/Pubs/TechRpts/1975/9602.html">http://www2.eecs.berkeley.edu/Pubs/TechRpts/1975/9602.html</a>.
</div>
<div id="ref-Razavi_Analog_CMOS" class="csl-entry" role="listitem">
Razavi, Behzad. 2017. <em><span class="nocase">Design of Analog CMOS Integrated Circuits</span></em>. McGraw-Hill.
</div>
<div id="ref-Sheikholeslami_2015" class="csl-entry" role="listitem">
Sheikholeslami, Ali. 2015. <span>“<span class="nocase">Miller’s Theorem [Circuit Intuitions]</span>.”</span> <em>IEEE Solid-State Circuits Magazine</em> 7 (3): 9–10. <a href="https://doi.org/10.1109/mssc.2015.2446457">https://doi.org/10.1109/mssc.2015.2446457</a>.
</div>
<div id="ref-Tsividis_McAndrew_2011" class="csl-entry" role="listitem">
Tsividis, Yannis, and Colin McAndrew. 2011. <em>Operation and Modeling of the MOS Transistor</em>. Oxford University Press.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div>Apache-2.0 license</div></div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"selector":".lightbox","loop":false,"openEffect":"zoom","descPosition":"bottom","closeEffect":"zoom"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>