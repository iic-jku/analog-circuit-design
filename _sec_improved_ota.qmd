With the new learned know-how of the cascode stage we can set out to improve our original basic 5T-OTA design. Essentially this means to add cascodes to $M_2$ and $M_4$ in @fig-basic-ota. For symmetry reasons we will add cascodes to both sides, and the resulting schematic is shown in @fig-improved-ota.

{{< include figures/_fig_improved_ota.qmd >}}

The transistor name appendix "C" indicates a cascode device sitting atop its base transistor. The bias voltage $V_\mathrm{bias1}$ is referenced to $\Vss$, the bias voltage $V_\mathrm{bias3}$ is referenced to $\Vdd$, and the floating bias voltage $V_\mathrm{bias2}$ creates a voltage bias for $M_\mathrm{1C}$ and $M_\mathrm{2C}$ relative to the tail point, so that the $\VDS$ of $M_{1,2}$ stays constant with a changing common-mode input voltage.

::: {.callout-important title="Cascode Bias Voltage Generation"}
It is critically import for a stable performance across PVT that the bias voltages for the cascode gates are created in a manner that tracks variations with process, temperature, and supply voltage!
:::

The current mirrors constructed out of $M_\mathrm{5/5C,6/6C}$ and $M_\mathrm{3/3C,4/4C}$ are a special kind of **cascoded current mirror for low-voltage operation**. This type is very often used, as it forces the $\VGS$ and $\VDS$ of $M_{5,6}$ (and $M_{3,4}$) to be equal, so the current mirror ratio is independent of $\gds$. Further, by properly selecting the bias voltages of the cascode a low-voltage operation is achieved as $\VDS$ can be minimized, allowing even triode operation of the current-mirror MOSFETs (as, noted above, a large $\gds$ is not a big issue).

A simplified small-signal gain calculation of this improved OTA uses the result of @eq-simple-ota-gain-dc and @eq-cs-cascode-output-impedance to arrive at the approximate dc gain of
$$
A_0 \approx \frac{\gm[12]}{\gds[2] \frac{\gds[2C]}{\gm[2C]} + \gds[4] \frac{\gds[4C]}{\gm[4C]}}
$$ {#eq-improved-ota-gain-dc}
leading to a significant boost in dc gain due to cascoding. We will use this increased gain to reduce the $L$ of all MOSFET to

1. save area (smaller $L$ will lead to smaller $W$ for a given $W/L$ ratio) and
2. will push the additional poles and zeros at the inner nodes of the cascoded transistors (e.g., the connection of the drain of $M_5$ to the source of $M_\mathrm{5C}$) to higher frequencies to result in stable behaviour and a reasonable gain transfer function (too many poles and zeros in the passband of the amplifier create many issues with stability margin).

## Sizing the Improved OTA {#sec-improved-ota-sizing}

Like the sizing of the 5T-OTA in @sec-basic-ota-sizing we will again use the $\gmid$ method using a Python notebook. Instead of using $L = 5\,\mu\text{m}$ we will this time use a reduced $L = 0.5\,\mu\text{m}$ for $M_\mathrm{1/1C,2/2C,3/3C,4/4C}$ (for speed reasons) and $L = 1\,\mu\text{m}$ for $M_\mathrm{5/5C,6/6C}$ for better common-mode rejection (the tail current mirror is less critical in terms of speed and stability).

We set $\gmid = 13$ across the board for a good trade-off between speed, current efficiency, and voltage headroom for the MOSFETs (this is now way more critical than in the basic 5T-OTA as we stack now double as many MOSFET at the same supply voltage). Please look at @sec-gmid-method to confirm this choice.

::: {.callout-note title="Improved OTA Sizing" collapse="false"}
{{< embed ./sizing/sizing_basic_ota_improved.ipynb echo=true >}}
:::

Looking at this sizing result we see that we achieve an improved $A0 > 43\,\text{dB}$ while meeting also the other performance requirements of @tbl-voltage-buffer-spec with margin. In addition, we check the voltage headroom of the critical MOSFET to see if we can squeeze it into the available supply voltage range, and see that this is possible with our above choice selection of parameters.

::: {.callout-tip title="Exercise: Improved OTA Sizing"}
Please take a detailed look at the above sizing notebook and play with the numbers and calculations. Do you find a better trade-off for the input parameters? Can you understand the ratio behind the choices and calculations?
:::

## Designing the Improved OTA

Based on the collected experience in this lecture and the result of the sizing procedure in @sec-improved-ota-sizing you should be able to design this OTA. If you want, please go ahead and try an implementation and check its performance with CACE.

As an alternative there is a prepared OTA design shown in @fig-improved-ota-design which we will discuss in detail next.

![Improved OTA design in Xschem.](./xschem/ota-improved.svg){#fig-improved-ota-design}

### Discussion of the OTA Design

We will now do an analysis of the circuit design of the OTA including all the complications which make this design practical.

1. For easier navigation, the device identifier are consistent with the circuit sketch in @fig-improved-ota.
2. Some MOSFET dimensions are rounded to make a better fit in IC layout. Please also look carefully at $W$, $L$, and $\mathrm{ng}$. The parameter $\mathrm{ng}$ sets how the total $W$ of a MOSFET should be split into individual MOSFET fingers with $W_\mathrm{f} = W / \mathrm{ng}$. This is done to arrive at a suitably sized MOSFET physical implementation. As we will not deal with IC layout in this lecture we will leave it at that.
3. In order to allow good matching in the IC layout, MOSFETs (and other components) have to constructed from equal pieces. To that end, $W/L$ scaling is done using unit elements (see finger width $W_\mathrm{f}$). Sometimes, besides $W$ the length $L$ has to be scaled, and this leads to the oddly-looking series stacking of some MOSFET (easily recognizable by the connected gates). In order to increase circuit readability, a subcircuit could be constructed hiding this series stacking of MOSFET, but it is sometimes easier to avoid subcircuits. There is a fine line in this trade, sometime a depth of 4 is the decision point between subcircuit use/no-use.
4. As you can (hopefully) see the circuit is carefully drawn to ease readability. Important nets are named, text comments state certain properties like nominal voltage levels, bias currents, etc. Current sensing elements are added to directly see the dc currents in the circuit simulation.
5. The bias voltage generation for the cascodes is included as well. The voltage drop for the bottom transistors is developed across a resistor (this is a simple but effective way, but other implementations are possible as well). We are using a dummy branch for bias generation (constructed with $M_\mathrm{7/7C,8/8C}$ and $R_3$).
6. The floating bias voltage $V_\mathrm{bias2}$ is created by implementing a current source from $\Vdd$ ($M_\mathrm{9/9C}$), then a MOSFET diode $M_{11}$ with resistor $R_4$, and an additional current source towards $\Vss$ ($M_\mathrm{10/10C}$). Instead of using the bottom current source the current in the tail current source $M_\mathrm{5/5C}$ could have been increased, but matching is better with the chosen approach.
7. Power-down transistors $M_{\mathrm{pd,}x}$ are added to allow a proper shutdown of the circuit with a digital enable input. It is generally a good idea to clamp floating nodes in off-mode so that no issues during power-down (like increased leakage currents) or delayed startup or shutdown are occuring. It is further a good design principle to buffer all incoming digital signals with inverters connected to the local supply. This lowers the risk of unwanted noise coupling or excessive slewrates on the incoming digital signals.
8. Sensitive bias nodes are buffered with decoupling capacitors. We are using MOSFET as nonlinear capacitors, which is not an issue in this application, but we value the increased capacitive density. Please note how the MOSFET are connected (to $\Vdd$? or $\Vss$?).

The resistor used in this circuit are subcircuits to allow series connection of unit resistor elements. The schematic of one element is shown in @fig-improved-ota-design-res. It is using an effective method to create a series string of connected resistors using wire bundles. Try to understand the circuit, consult the Xschem manual, and look at the resulting SPICE netlist to confirm your finding.

![Series resistor implementation used in the improved OTA design.](./xschem/ota-improved-res-4.svg){#fig-improved-ota-design-res}

::: {.callout-note title="Parallel Connection"}
Note that a parallel connection of devices is effectively possible using the multiplier notation of Xschem.
:::

## Simulation of Improved OTA

Now that the circuit design of the improved OTA is done, we an use the same simulation test bench as for the basic OTA. The testbench is shown in @fig-improved-ota-design-tb-ac and @fig-improved-ota-design-tb-tran.

![Simulation testbench of the improved OTA design (small-signal).](./xschem/ota-improved_tb-ac.svg){#fig-improved-ota-design-tb-ac}

![Simulation testbench of the improved OTA design (large-signal).](./xschem/ota-improved_tb-tran.svg){#fig-improved-ota-design-tb-tran}

::: {.callout-tip title="Exercise: Improved OTA Initial Simulation"}
Please use the above testbenches to simulate the improved OTA:

1. Check the dc bias points. Are they good? How stable are they across PVT variations?
2. What are the small-signal parameters like gain, noise and bandwidth? Are they fitting the specification?
3. What is large-signal performance? Is the settling fast enough? Is the settling well behaved, i.e., are there overshoots or other strange ringing indicating potential stability issues?
4. Try to improve the design. Change various device parameters and see what happens. Whenever you change something, check the dc operating point first. If the dc operating point is not good no further simulations make sense.
:::

## Corner Simulation of Improved OTA

Just like for the basic OTA we use the CACE system to check the performance of the improved OTA design holistically across variations like PVT and input signal variations. The results of the CACE run are shown below in @nte-improved-ota-cace-result.

::: {#nte-improved-ota-cace-result .callout-note title="CACE Summary for Improved OTA" collapse="false"}

{{< include ./cace/_docs/ota-improved_schematic.md >}}
:::

The improved performance allows to improve the specificatios in a few important points, notably the output voltage tolerance which is an important metric for a reference voltage buffer. We have intetionally increased the power consumption a little bit, but we negotiated with the chip lead designer a changed bias current level, so overall the situation is even slightly improved. The new situation with the improved design is summarized in @tbl-voltage-buffer-spec-improved (unchanged entries are not shown).

| Specification                              | Basic 5T-OTA | Improved OTA | Unit    |
|:-------------------------------------------|:------------:|:------------:|:-------:|
| Output voltage error                       | $<3$         | $<1$         | %       |
| Total output noise (rms)                   | $<1$         | $<0.5$       | mV~rms~ |
| Supply current (as low as possible)        | $<10$        | $<20$        | µA      |
| Turn-on time (settled to with 1%)          | $<10$        | $<1$         | µs      |
| Externally provided bias current (nominal) | $20$         | $5$          | µA      |

: Voltage buffer specification {#tbl-voltage-buffer-spec-improved}
