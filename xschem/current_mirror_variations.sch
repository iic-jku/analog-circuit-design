v {xschem version=3.4.8RC file_version=1.3}
G {}
K {}
V {}
S {}
F {}
E {}
T {Basic current mirror} 270 -630 0 0 0.4 0.4 {}
T {Cascoded current mirror} 650 -1320 0 0 0.4 0.4 {}
T {Degenerated current mirror} 920 -730 0 0 0.4 0.4 {}
T {Regulated current mirror} 1460 -1340 0 0 0.4 0.4 {}
N 60 -330 60 -310 {
lab=GND}
N 220 -400 290 -400 {
lab=GND}
N 60 -570 60 -430 {
lab=v_dd}
N 60 -570 290 -570 {
lab=v_dd}
N 290 -450 290 -430 {
lab=#net1}
N 330 -400 360 -400 {
lab=#net1}
N 360 -450 360 -400 {
lab=#net1}
N 290 -450 360 -450 {
lab=#net1}
N 290 -570 290 -550 {
lab=v_dd}
N 290 -490 290 -450 {
lab=#net1}
N 500 -400 570 -400 {
lab=GND}
N 60 -330 220 -330 {
lab=GND}
N 60 -370 60 -330 {
lab=GND}
N 220 -400 220 -330 {
lab=GND}
N 220 -330 290 -330 {
lab=GND}
N 290 -370 290 -330 {
lab=GND}
N 290 -330 500 -330 {
lab=GND}
N 500 -370 500 -330 {
lab=GND}
N 500 -330 570 -330 {
lab=GND}
N 570 -400 570 -330 {
lab=GND}
N 620 -350 620 -330 {
lab=GND}
N 570 -330 620 -330 {
lab=GND}
N 360 -400 460 -400 {
lab=#net1}
N 500 -570 620 -570 {
lab=out}
N 500 -470 500 -430 {
lab=#net2}
N 200 -850 200 -830 {
lab=GND}
N 200 -920 270 -920 {
lab=GND}
N 270 -1270 270 -1250 {
lab=v_dd}
N 480 -920 550 -920 {
lab=GND}
N 200 -920 200 -850 {
lab=GND}
N 200 -850 270 -850 {
lab=GND}
N 270 -890 270 -850 {
lab=GND}
N 270 -850 480 -850 {
lab=GND}
N 480 -890 480 -850 {
lab=GND}
N 480 -850 550 -850 {
lab=GND}
N 550 -920 550 -850 {
lab=GND}
N 480 -1270 480 -1250 {
lab=out}
N 500 -570 500 -530 {lab=out}
N 620 -570 620 -410 {lab=out}
N 270 -990 270 -950 {lab=#net3}
N 200 -1020 270 -1020 {lab=GND}
N 200 -1020 200 -920 {lab=GND}
N 480 -990 480 -950 {lab=#net4}
N 360 -1020 440 -1020 {lab=#net5}
N 480 -1020 550 -1020 {lab=GND}
N 550 -1020 550 -920 {lab=GND}
N 270 -1070 270 -1050 {lab=#net6}
N 270 -1170 270 -1150 {lab=#net5}
N 270 -1070 340 -1070 {lab=#net6}
N 270 -1090 270 -1070 {lab=#net6}
N 340 -1070 340 -920 {lab=#net6}
N 310 -920 340 -920 {
lab=#net6}
N 270 -1170 360 -1170 {lab=#net5}
N 270 -1190 270 -1170 {lab=#net5}
N 340 -920 440 -920 {
lab=#net6}
N 360 -1170 360 -1020 {lab=#net5}
N 310 -1020 360 -1020 {lab=#net5}
N 480 -1190 480 -1050 {lab=#net7}
N 900 -330 900 -310 {
lab=GND}
N 970 -650 970 -630 {
lab=v_dd}
N 900 -330 970 -330 {
lab=GND}
N 970 -370 970 -330 {
lab=GND}
N 970 -330 1180 -330 {
lab=GND}
N 1180 -370 1180 -330 {
lab=GND}
N 1180 -330 1250 -330 {
lab=GND}
N 1180 -650 1180 -630 {
lab=out}
N 970 -470 970 -430 {lab=#net8}
N 900 -500 970 -500 {lab=GND}
N 900 -500 900 -330 {lab=GND}
N 1180 -470 1180 -430 {lab=#net9}
N 1180 -500 1250 -500 {lab=GND}
N 1250 -500 1250 -330 {lab=GND}
N 970 -550 970 -530 {lab=#net10}
N 1040 -500 1140 -500 {lab=#net10}
N 970 -550 1040 -550 {lab=#net10}
N 970 -570 970 -550 {lab=#net10}
N 1040 -550 1040 -500 {lab=#net10}
N 1010 -500 1040 -500 {lab=#net10}
N 1180 -570 1180 -530 {lab=#net11}
N 980 -950 980 -930 {
lab=GND}
N 980 -1020 1050 -1020 {
lab=GND}
N 1050 -1290 1050 -1270 {
lab=v_dd}
N 1380 -1020 1450 -1020 {
lab=GND}
N 980 -1020 980 -950 {
lab=GND}
N 980 -950 1050 -950 {
lab=GND}
N 1050 -990 1050 -950 {
lab=GND}
N 1380 -990 1380 -950 {
lab=GND}
N 1450 -1020 1450 -950 {
lab=GND}
N 1050 -1090 1050 -1050 {lab=#net12}
N 980 -1120 1050 -1120 {lab=GND}
N 980 -1120 980 -1020 {lab=GND}
N 1380 -1070 1380 -1050 {lab=#net13}
N 1380 -1120 1450 -1120 {lab=GND}
N 1450 -1120 1450 -1020 {lab=GND}
N 1120 -1020 1340 -1020 {
lab=#net14}
N 1050 -1170 1050 -1150 {lab=#net14}
N 1380 -950 1450 -950 {lab=GND}
N 1260 -950 1380 -950 {
lab=GND}
N 1260 -1040 1260 -950 {lab=GND}
N 1210 -950 1260 -950 {
lab=GND}
N 1210 -1070 1260 -1070 {lab=GND}
N 1210 -1070 1210 -950 {lab=GND}
N 1050 -950 1210 -950 {
lab=GND}
N 1300 -1070 1380 -1070 {lab=#net13}
N 1380 -1090 1380 -1070 {lab=#net13}
N 1260 -1120 1340 -1120 {lab=#net15}
N 1260 -1120 1260 -1100 {lab=#net15}
N 1090 -1120 1260 -1120 {lab=#net15}
N 1050 -1170 1120 -1170 {lab=#net14}
N 1050 -1210 1050 -1170 {lab=#net14}
N 1120 -1170 1120 -1020 {lab=#net14}
N 1090 -1020 1120 -1020 {
lab=#net14}
N 1050 -1290 1260 -1290 {lab=v_dd}
N 1260 -1290 1260 -1230 {lab=v_dd}
N 1260 -1170 1260 -1120 {lab=#net15}
N 1380 -1210 1380 -1150 {lab=#net16}
N 1380 -1290 1380 -1270 {lab=out}
N 690 -550 690 -530 {lab=n1}
N 600 -1210 600 -1190 {lab=n2}
N 1300 -620 1300 -600 {lab=n3}
N 1490 -1260 1490 -1240 {lab=n4}
C {devices/code_shown.sym} 0 -150 0 0 {name=MODEL only_toplevel=true
format="tcleval( @value )"
value="
.lib cornerMOSlv.lib mos_tt_mismatch
.lib cornerRES.lib res_typ_mismatch
"}
C {devices/code_shown.sym} 1640 -1040 0 0 {name=NGSPICE only_toplevel=true 
value="
.temp 27
.include current_mirror_variations.save
.control
option noacct noinit seed=1
save all

let mcruns = 500
let runs = 0

*
* Simulate dc output characteristics
*
op
write current_mirror_variations.raw
dc Vout1 0 1.5 10m
plot i(Viout1) i(viout2) i(viout3) i(viout4)
wrdata curmir_variations.txt i(viout1) i(viout2) i(viout3) i(viout4) 

*
* Simulate output noise
*
noise v(n1) ibias1 dec 100 1MEG 100MEG
setplot noise1
wrdata curmir_variations_noise1.txt onoise_spectrum

noise v(n2) ibias2 dec 100 1MEG 100MEG
setplot noise3
wrdata curmir_variations_noise2.txt onoise_spectrum

noise v(n3) ibias3 dec 100 1MEG 100MEG
setplot noise5
wrdata curmir_variations_noise3.txt onoise_spectrum

noise v(n4) ibias41 dec 100 1MEG 100MEG
setplot noise7
wrdata curmir_variations_noise4.txt onoise_spectrum

*
* Simulate mismatch of output current
*
shell rm curmir_variations_mc1.txt
shell rm curmir_variations_mc2.txt
shell rm curmir_variations_mc3.txt
shell rm curmir_variations_mc4.txt
dowhile runs < mcruns
  reset
  option noacct noinit seed=1
  let runs = runs + 1
  op
  print i(Viout1) >> curmir_variations_mc1.txt
  print i(Viout2) >> curmir_variations_mc2.txt
  print i(Viout3) >> curmir_variations_mc3.txt
  print i(Viout4) >> curmir_variations_mc4.txt
end

.endc
"}
C {devices/vsource.sym} 60 -400 0 0 {name=Vdd value=1.5}
C {devices/gnd.sym} 60 -310 0 0 {name=l3 lab=GND}
C {devices/title.sym} 160 -30 0 0 {name=l5 author="(c) 2025 Harald Pretl, Apache-2.0 license"}
C {sg13g2_pr/sg13_lv_nmos.sym} 310 -400 0 1 {name=M11
l=5u
w=10u
ng=1
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {devices/launcher.sym} 500 -100 0 0 {name=h2
descr="simulate" 
tclcommand="xschem save; xschem netlist; xschem simulate"
}
C {devices/launcher.sym} 740 -100 0 0 {name=h3
descr="annotate OP" 
tclcommand="set show_hidden_texts 1; xschem annotate_op"
}
C {devices/isource.sym} 290 -520 0 0 {name=Ibias1 value="dc 50u ac 1"}
C {devices/lab_pin.sym} 60 -570 0 0 {name=p2 sig_type=std_logic lab=v_dd}
C {sg13g2_pr/sg13_lv_nmos.sym} 480 -400 0 0 {name=M12
l=5u
w=10u
ng=1
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {devices/vsource.sym} 620 -380 0 0 {name=Vout1 value=0.4
}
C {devices/lab_pin.sym} 620 -570 0 1 {name=p7 sig_type=std_logic lab=out}
C {devices/ammeter.sym} 500 -500 0 0 {name=Viout1 savecurrent=true spice_ignore=0}
C {sg13g2_pr/annotate_fet_params.sym} 280 -300 0 0 {name=annot1 ref=M11}
C {sg13g2_pr/annotate_fet_params.sym} 490 -300 0 0 {name=annot2 ref=M12}
C {devices/gnd.sym} 200 -830 0 0 {name=l1 lab=GND}
C {sg13g2_pr/sg13_lv_nmos.sym} 290 -920 0 1 {name=M21
l=2u
w=14u
ng=2
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {devices/isource.sym} 270 -1220 0 0 {name=Ibias2 value="dc 50u ac 1"}
C {devices/lab_pin.sym} 270 -1270 0 0 {name=p5 sig_type=std_logic lab=v_dd}
C {sg13g2_pr/sg13_lv_nmos.sym} 460 -920 0 0 {name=M22
l=2u
w=14u
ng=2
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {devices/lab_pin.sym} 480 -1270 0 1 {name=p10 sig_type=std_logic lab=out}
C {devices/ammeter.sym} 480 -1220 0 0 {name=Viout2 savecurrent=true spice_ignore=0}
C {sg13g2_pr/annotate_fet_params.sym} 100 -790 0 0 {name=annot3 ref=M21}
C {sg13g2_pr/annotate_fet_params.sym} 250 -790 0 0 {name=annot4 ref=M22}
C {sg13g2_pr/sg13_lv_nmos.sym} 290 -1020 0 1 {name=M23
l=2u
w=14u
ng=2
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {sg13g2_pr/sg13_lv_nmos.sym} 460 -1020 0 0 {name=M24
l=2u
w=14u
ng=2
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {sg13g2_pr/annotate_fet_params.sym} 410 -790 0 0 {name=annot5 ref=M23}
C {sg13g2_pr/annotate_fet_params.sym} 560 -790 0 0 {name=annot6 ref=M24}
C {devices/gnd.sym} 900 -310 0 0 {name=l2 lab=GND}
C {devices/isource.sym} 970 -600 0 0 {name=Ibias3 value="dc 50u ac 1"}
C {devices/lab_pin.sym} 970 -650 0 0 {name=p1 sig_type=std_logic lab=v_dd}
C {devices/lab_pin.sym} 1180 -650 0 1 {name=p3 sig_type=std_logic lab=out}
C {devices/ammeter.sym} 1180 -600 0 0 {name=Viout3 savecurrent=true spice_ignore=0}
C {sg13g2_pr/annotate_fet_params.sym} 960 -300 0 0 {name=annot7 ref=M31}
C {sg13g2_pr/annotate_fet_params.sym} 1170 -300 0 0 {name=annot8 ref=M32}
C {sg13g2_pr/sg13_lv_nmos.sym} 990 -500 0 1 {name=M31
l=3u
w=20u
ng=2
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {sg13g2_pr/sg13_lv_nmos.sym} 1160 -500 0 0 {name=M32
l=3u
w=20u
ng=2
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {devices/gnd.sym} 980 -930 0 0 {name=l4 lab=GND}
C {sg13g2_pr/sg13_lv_nmos.sym} 1070 -1020 0 1 {name=M41
l=1u
w=10u
ng=1
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {devices/isource.sym} 1050 -1240 0 0 {name=Ibias41 value="dc 50u ac 1"}
C {devices/lab_pin.sym} 1050 -1290 0 0 {name=p4 sig_type=std_logic lab=v_dd}
C {sg13g2_pr/sg13_lv_nmos.sym} 1360 -1020 0 0 {name=M42
l=1u
w=10u
ng=1
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {devices/lab_pin.sym} 1380 -1290 0 1 {name=p6 sig_type=std_logic lab=out}
C {devices/ammeter.sym} 1380 -1240 0 0 {name=Viout4 savecurrent=true spice_ignore=0}
C {sg13g2_pr/annotate_fet_params.sym} 860 -890 0 0 {name=annot9 ref=M41}
C {sg13g2_pr/annotate_fet_params.sym} 990 -890 0 0 {name=annot10 ref=M42}
C {sg13g2_pr/sg13_lv_nmos.sym} 1070 -1120 0 1 {name=M43
l=1u
w=10u
ng=1
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {sg13g2_pr/sg13_lv_nmos.sym} 1360 -1120 0 0 {name=M44
l=1u
w=10u
ng=1
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {sg13g2_pr/annotate_fet_params.sym} 1130 -890 0 0 {name=annot11 ref=M43}
C {sg13g2_pr/annotate_fet_params.sym} 1260 -890 0 0 {name=annot12 ref=M44}
C {sg13g2_pr/sg13_lv_nmos.sym} 1280 -1070 0 1 {name=M45
l=0.13u
w=10u
ng=1
m=1
model=sg13_lv_nmos
spiceprefix=X
}
C {devices/isource.sym} 1260 -1200 0 0 {name=Ibias42 value=5u}
C {sg13g2_pr/annotate_fet_params.sym} 1390 -890 0 0 {name=annot13 ref=M45}
C {sg13g2_pr/rppd.sym} 270 -1120 0 0 {name=R2
w=0.5e-6
l=8e-6
model=rppd
body=gnd
spiceprefix=X
b=0
m=1
}
C {sg13g2_pr/rppd.sym} 970 -400 0 0 {name=R31
w=3e-6
l=45e-6
model=rppd
body=gnd
spiceprefix=X
b=0
m=1
}
C {sg13g2_pr/rppd.sym} 1180 -400 0 1 {name=R32
w=3e-6
l=45e-6
model=rppd
body=gnd
spiceprefix=X
b=0
m=1
}
C {devices/ccvs.sym} 690 -500 0 0 {name=Hn1 vnam=Viout1 value=1}
C {devices/gnd.sym} 690 -470 0 0 {name=l6 lab=GND}
C {devices/lab_pin.sym} 690 -550 0 1 {name=p8 sig_type=std_logic lab=n1}
C {noconn.sym} 690 -550 0 0 {name=l7}
C {devices/ccvs.sym} 600 -1160 0 0 {name=Hn2 vnam=Viout2 value=1}
C {devices/gnd.sym} 600 -1130 0 0 {name=l8 lab=GND}
C {devices/lab_pin.sym} 600 -1210 0 1 {name=p9 sig_type=std_logic lab=n2}
C {noconn.sym} 600 -1210 0 0 {name=l9}
C {devices/ccvs.sym} 1300 -570 0 0 {name=Hn3 vnam=Viout3 value=1}
C {devices/gnd.sym} 1300 -540 0 0 {name=l10 lab=GND}
C {devices/lab_pin.sym} 1300 -620 0 1 {name=p11 sig_type=std_logic lab=n3}
C {noconn.sym} 1300 -620 0 0 {name=l11}
C {devices/ccvs.sym} 1490 -1210 0 0 {name=Hn4 vnam=Viout4 value=1}
C {devices/gnd.sym} 1490 -1180 0 0 {name=l12 lab=GND}
C {devices/lab_pin.sym} 1490 -1260 0 1 {name=p12 sig_type=std_logic lab=n4}
C {noconn.sym} 1490 -1260 0 0 {name=l13}
